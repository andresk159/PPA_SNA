---
title: "PPA-SNA Informe"
author: "Jean Francois Le Coq, Carlos Gonzalez, Andres Camilo Mendez, Fanny Howland"

date: "`r format(Sys.time(), '%d %B %Y')`"
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "D:/OneDrive - CGIAR/Attachments/Desktop/infrormes_PPA") })
output: 
  word_document:
    toc: true
 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "D:/OneDrive - CGIAR/Attachments/Desktop/infrormes_PPA")
```

# Introducción

El monitoreo y el análisis periódico de la red de relaciones pasadas, presentes y futuras dentro y fuera de la plataforma PPA es un componente importante de la agenda general de aprendizaje de PPA. Esta actividad de "monitoreo de procesos" se centrará en comprender y caracterizar la evolución de la red de PPA a lo largo del tiempo, así como su influencia y respuesta a contextos sociales e institucionales más amplios, al tiempo que permite la vinculación de la actividad de la red de PPA con el desarrollo económico sostenible y hitos y resultados de la conservación de la biodiversidad biológica.

Se diseñó un cuestionario para recopilar información específica de todos los actores dentro del PPA y obtener información sobre el tipo de relaciones que cada miembro del PPA tiene con los demás. En este documento se muestran todos los resultados de la encuesta y las redes logradas hasta ahora.  


```{r include = FALSE}
library(pacman)
pacman::p_load(tidyverse, readr, igraph, statnet, readxl, FactoMineR, zoo, likert, lubridate, hrbrthemes,
               igraph, statnet, qgraph, kableExtra, flextable, magrittr, RColorBrewer, xlsx, scales, rlang, writexl, plyr)
library(tidyverse)
library(ggradar)
```

```{r globalvars,echo = FALSE,warning=FALSE,cache=TRUE}

clustering <- function(data, k, dist.method = "euclidean", scale.unit = T){
  
  if(scale.unit){
    data<- scale(data, center = T, scale = T) %>% 
      as_tibble()
  }
  cl <-  data %>% 
    dplyr::mutate_if(is.numeric, .funs = function(i){ifelse(is.na(i), 0, i)}) %>% 
    #imputePCA(.,method="Regularized",ncp=3) %>% 
    #purrr::pluck(1) %>% 
    stats::dist(., method = dist.method) %>% 
    hclust(d =., method = "ward.D") %T>%
    plot() %>% 
    cutree(., k = k) %>% 
    as.character(.)
  
  return(cl)
}
#define file to store tables from results
tbl_pth <-  "D:/OneDrive - CGIAR/Attachments/Desktop/infrormes_PPA/tablas/"
tbl_questions <-  "D:/OneDrive - CGIAR/Attachments/Desktop/infrormes_PPA/tablas_preguntas/"



#function to make a triangle shape
mytriangle <- function(coords, v=NULL, params) {
  vertex.color <- params("vertex", "color")
  if (length(vertex.color) != 1 && !is.null(v)) {
    vertex.color <- vertex.color[v]
  }
  vertex.size <- 1/120 * params("vertex", "size")
  if (length(vertex.size) != 1 && !is.null(v)) {
    vertex.size <- vertex.size[v]
  }

  symbols(x=coords[,1], y=coords[,2], bg=vertex.color,
          stars=cbind(vertex.size, vertex.size, vertex.size),
          add=TRUE, inches=FALSE)
}
igraph::add_shape("triangle", clip=igraph::shapes("circle")$clip,
                 plot=mytriangle)

# function to conver multioption question into  binary  columns
become_vec <- function(choices, n_res){
  
  if(is.null(dim(choices))){
    vec <- as.integer(1:n_res %in% choices) 
  }else if(length(dim(choices))){
    vec <-  as.integer(1:n_res %in% dplyr::pull(choices))
  }
  return(vec)
}


#### cargar datos
pth <- "D:/OneDrive - CGIAR/Documents/Database SNA PPA 2019 final 2020 06 06.xlsx"
xls.file <-  pth

categoria <- excel_sheets(pth)[-1]

raw_data <- suppressMessages(lapply(categoria, function(i){
  read_excel(pth, sheet = i)
}) )
 
names(raw_data) <- categoria

f <-suppressWarnings(raw_data$Informer %>%
  dplyr::mutate(ID2 = paste0(ID, ID_ego))
  #dplyr::mutate(V12 = as.numeric(V12), V12 = as.Date.numeric(V12, origin = "1899-12-30")) %>%
  #dplyr::mutate(V13 = as.numeric(V13), V13 = zoo::as.Date(V13, origin = "1899-12-30"))
)

unq <- unique(f$ID2)  

reshaped <- lapply(unq, function(i){
  f %>% 
    dplyr::filter( ID2 == i) %>% 
    dplyr::pull(V14) %>%
    become_vec(choices = ., n_res = 9)
  
}) %>% 
  do.call( rbind, .) %>% 
  as.data.frame()
names(reshaped) <- paste0("V14_",1:9)


new_data <-list()

new_data$Informer <- f %>% 
  dplyr::filter(!is.na(V2)) %>%
  cbind(., reshaped)%>%
  as_tibble() %>%
  dplyr::select(-V14)

#### atributos de las empresas
new_data$orgs_atributos <- raw_data$Empresas_orgs_atributos %>% 
  dplyr::mutate_all(as.character)
 
##### Percepcoes secction

new_data$Percepcoes <- raw_data$Percepcoes %>%
  dplyr::mutate(ID2 = paste0(ID, ID_ego)) 
  

unq <- unique(new_data$Percepcoes$ID2)  

reshaped <- lapply(unq, function(i){
  new_data$Percepcoes %>% 
    dplyr::filter( ID2 == i) %>% 
    dplyr::pull(V20) %>%
    become_vec(choices = ., n_res = 13)
  
}) %>% 
  do.call( rbind, .) %>% 
  as.data.frame()
names(reshaped) <- paste0("V20_",1:13)



new_data$Percepcoes <- new_data$Percepcoes %>% 
  dplyr::filter(!is.na(V17)) %>%
  cbind(., reshaped)%>%
  as_tibble() %>%
  dplyr::select(-V20)

groups <- raw_data$Orgs_grupo_rodada2019 %>%
  dplyr::filter(!ID %in% c(79, 900)) %>%
  dplyr::mutate_all(as.character)

gr_colors <- groups %>% 
  dplyr::select(V1) %>% 
  dplyr::group_by(V1) %>% 
  tally() %>% 
  dplyr::mutate(color = case_when(
    V1 == "A2" ~ "dodgerblue2",
    V1 == "A" ~ "olivedrab3",
    V1 == "B" ~ "gold",
    TRUE ~ "gray50"
  ))








entrevistados <- groups %>% 
  dplyr::mutate( label = case_when(
    Rodada_2019 == "1" ~  "Interviewed in 2019",
    Rodada_2019 == "2" ~  "Not interviewed in 2019 (no available)",
    Rodada_2019 == "3" ~  "Not interviewed in 2019 (not listed)",
    Rodada_2019 == "4" ~  "Not interviewed in 2019 (included after sample definition)",
    Rodada_2019 == "5" ~  "Not interviewed in 2019 (identified by 2019 interviews)",
    TRUE ~ NA_character_
  ),
  status = if_else(Rodada_2019 == "1", "Interviewed", "Not Interviewed")) 



type_org <-  raw_data$Empresas_orgs_atributos %>% 
  dplyr::select(ID, V39a, V39b) %>%
  dplyr::mutate_all(as.character) %>% 
  dplyr::right_join(., groups) %>% 
  dplyr::mutate(V39a_lab = case_when(
   V39a == "1"~	"Company (consolidates or start-up)",
V39a == "2" ~	"Civil society organization",
V39a == "3"~	"Government agency",
V39a == "4"	~ "Education & Research organization",
TRUE ~ "Not avaliable"),
V39b_lab = case_when(
 V39b == "1"~	 "Brazilian government agency" ,
V39b == "2"~ "Foreign government agency",
V39b == "3"~ "Community association",
V39b == "4"~ "Business association",
V39b == "5"~ "Cooperative",
V39b == "6"~ "Consolidated company",
V39b == "7"~ "Start-up company",
V39b == "8"~ "Foundation",
V39b == "9"~"Investment fund",
V39b == "10"~"Socioenvironmental NGO",
V39b == "11"~"NGO (other)",
V39b == "12"~"Union",
V39b == "13"~"University",
TRUE ~ "Not avaliable")) 
  

```

# Organization atributes

this section shows the results of the questions V39a to V45 in the **Empresas orgs atributos** section.

## Question V39a - Tipo de empresa ou organização (Type of organization)

```{r v39a,echo=FALSE,warning=FALSE,fig.width=8, fig.height=6, cache = F}

V39_df <- type_org %>%
   drop_na() %>% 
  dplyr::filter(V39a_lab != "Not avaliable") 
  
V39_df %>% 
  group_by(V39a_lab) %>% 
  tally() %>%
  dplyr::mutate(freq = round(n/sum(n), 3)*100, Frequency = paste0(freq, "%"))%>% 
  dplyr::arrange(desc(freq)) %>% 
  ggplot(aes(x = reorder(V39a_lab, freq), y = freq, fill = V39a_lab)) + 
  geom_bar(stat = "identity")+
  coord_flip() + 
  scale_fill_viridis_d() +
  geom_text(aes(label = Frequency),
                position = position_stack(vjust = .8), size = 4)+
  labs(x= element_blank(), y = "Frequency", title = "Question V39a - Type of organization")+
  scale_y_continuous(limits=c(0,101), breaks= seq(0,101, by=10)) + 
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  theme(legend.position= "none")
  
V39_df %>% 
  group_by(V39a_lab) %>% 
  tally() %>%
  dplyr::mutate(freq = round(n/sum(n), 3)*100, Frequency = paste0(freq, "%"))%>% 
  dplyr::arrange(desc(freq)) %>% 
  dplyr::rename("Type of organization" = V39a_lab, "Count" = n) %>% 
  dplyr::select(-freq) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V39(Type of organization)", ".csv")) %>% 
  flextable(.)




```

### Question V39a- Type of organization por group

```{r v39a_by_gr,echo=FALSE,warning=FALSE,fig.width=8, fig.height=6, cache = F}

V39_df <- type_org %>% 
   drop_na() %>% 
  dplyr::filter(V39a_lab != "Not avaliable")
  
V39_df %>% 
  group_by(  V1, V39a_lab) %>% 
  tally() %>%
  dplyr::mutate(freq = round(n/sum(n), 3)*100, Frequency = paste0(freq, "%"))%>% 
  #dplyr::arrange(desc(freq)) %>% 
  ggplot(aes(x = V1, y = freq, fill = V39a_lab)) + 
  geom_bar(stat = "identity")+
  coord_flip() + 
  geom_text(aes(label = Frequency),
                position = position_stack(vjust = .5), size = 3)+
  labs(x= "Group", y = "Frequency", title = "Question V39a - Type of organization by group", fill = "Type of organization")+
  scale_y_continuous(limits=c(0,101), breaks= seq(0,101, by=10)) + 
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  theme(legend.position= "right")
  
V39_df %>% 
  group_by(V1, V39a_lab) %>% 
  tally() %>%
  dplyr::mutate(freq = round(n/sum(n), 3)*100, Frequency = paste0(freq, "%")) %>% 
  dplyr::select( "Group" = V1, "Type of organization" = V39a_lab, "Count" = n, Frequency) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V39a(Type of organization)_by_group", ".csv")) %>% 
  flextable(.)

```

\pagebreak

### Question V39a - Type of organization por group (Interviewed)

```{r v39a_by_gr_entrev,echo=FALSE,warning=FALSE,fig.width=8, fig.height=6, cache = F}

V39_df <- type_org %>%
  dplyr::filter(Rodada_2019 == 1) %>% 
  drop_na() %>% 
  dplyr::filter(V39a_lab != "Not avaliable")

  
V39_df %>% 
  group_by(V1, V39a_lab) %>% 
  tally() %>%
  dplyr::mutate(freq = round(n/sum(n), 3)*100, Frequency = paste0(freq, "%"))%>% 
  #dplyr::arrange(desc(freq)) %>% 
  ggplot(aes(x = V1, y = freq, fill = V39a_lab)) + 
  geom_bar(stat = "identity")+
  coord_flip() + 
  geom_text(aes(label = Frequency),
                position = position_stack(vjust = .5), size = 3)+
  labs(x= "(Type of organization)", y = "Frequency", title = "Question V39a - Type of organization by group", fill = "Groups")+
  scale_y_continuous(limits=c(0,101), breaks= seq(0,101, by=10)) + 
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  theme(legend.position= "right")
  
V39_df %>% 
  group_by( V1, V39a_lab) %>% 
  tally() %>%
  dplyr::mutate(freq = round(n/sum(n), 3)*100, Frequency = paste0(freq, "%")) %>% 
  dplyr::select( "Group" = V1, "Type of organization" = V39a_lab, "Count" = n, Frequency) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V39a(Type of organization)_by_group_entrevistados", ".csv")) %>% 
  flextable(.)

```

\pagebreak


## Question V39b - Subtype of organization

```{r v39b,echo=FALSE,warning=FALSE,fig.width=8, fig.height=6, cache = F}

vr <- "V39b"
df_trial <- type_org %>%
  drop_na() %>% 
  dplyr::rename("Q_lab" = V39b_lab)


  
df_trial %>% 
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
  group_by(Q_lab) %>% 
  tally() %>%
  dplyr::mutate(freq = round(n/sum(n), 3)*100, Frequency = paste0(freq, "%"))%>% 
  dplyr::arrange(desc(freq)) %>% 
  ggplot(aes(x = reorder(Q_lab, freq), y = freq, fill = Q_lab)) + 
  geom_bar(stat = "identity")+
  coord_flip() + 
  scale_fill_viridis_d(direction = 1) +
  geom_text(aes(label = Frequency),
                position = position_stack(vjust = .8), size = 4)+
  labs(x= "Subtype of organization", y = "Frequency", title = paste("Question", vr, " - Subtype of organization"))+
  scale_y_continuous(limits=c(0,101), breaks= seq(0,101, by=10)) + 
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  theme(legend.position= "none")

non_response <- df_trial %>% 
 dplyr::filter(!!parse_quo(vr, env = caller_env()) == "0") %>% 
  nrow()
non_res_frq <- round(non_response/nrow(df_trial)*100)

df_trial %>% 
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>%
  group_by(Q_lab) %>% 
  tally() %>%
  dplyr::mutate(freq = round(n/sum(n), 3)*100, Frequency = paste0(freq, "%"))%>% 
  dplyr::arrange(desc(freq))%>% 
  add_row( Q_lab = "No information Rate",  n = non_response, freq = non_res_frq, Frequency = paste0(non_res_frq,"%") ) %>% 
  dplyr::select("Subtype of organization" = Q_lab, Count =n, Frequency)  %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V39b(Subtype of organization)", ".csv")) %>% 
  flextable(.)

```

### Question V39b Subtype of organization by group

```{r v39b_by_gr,echo=FALSE,warning=FALSE,fig.width=8, fig.height=6, cache = F}

vr <- "V39b"
df_trial <- type_org %>%
  drop_na() %>% 
  dplyr::rename("Q_lab" = V39b_lab)
 
  
df_trial %>% 
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>%
  group_by( V1, Q_lab) %>% 
  tally() %>%
  dplyr::mutate(freq = round(n/sum(n), 3)*100, Frequency = paste0(freq, "%"))%>% 
  ggplot(aes(x = reorder(Q_lab, freq), y = freq, fill = V1)) + 
  geom_bar(position = position_dodge2(preserve = "single"), stat = "identity")+
  coord_flip() + 
  scale_fill_manual(values = gr_colors$color) +
  geom_text(aes(label = Frequency),
                position = position_dodge(width  = 0.8), size = 3)+
  labs(x= "Subtype of organization", y = "Frequency", title = paste("Question", vr, "Subtype of organization - by group"), fill = element_blank())+
  scale_y_continuous(limits=c(0,101), breaks= seq(0,101, by=10)) + 
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  theme(legend.position= "bottom")
  
non_response <- df_trial %>% 
 dplyr::filter(!!parse_quo(vr, env = caller_env()) == "0") %>% 
  nrow()
non_res_frq <- round(non_response/nrow(df_trial)*100)

df_trial %>% 
  group_by(V1, Q_lab) %>% 
  tally() %>%
  dplyr::mutate(freq = round(n/sum(n), 3)*100, Frequency = paste0(freq, "%"))%>% 
  dplyr::arrange(desc(freq)) %>% 
  ungroup() %>% 
   add_row( V1 = "No information", Q_lab = "No information Rate",  n = non_response, freq = non_res_frq, Frequency = paste0(non_res_frq,"%") ) %>%
  dplyr::select("Group" = V1, "Subtype of organization" = Q_lab, "Count" = n,  Frequency) %>% 
  write_csv(., paste0(tbl_questions, "pregunta_V39b(Subtype of organization)_by_gr", ".csv")) %>% 
  flextable(.)

```


### Question V39b por grupo (Interviewed)

```{r v39b_by_gr_entrev,echo=FALSE,warning=FALSE,fig.width=8, fig.height=6, cache = F}

vr <- "V39b"
df_trial <- type_org %>% 
  dplyr::filter(Rodada_2019 == 1) %>% 
  dplyr::filter(V39a_lab != "Not avaliable") %>% 
  dplyr::rename("Q_lab" = V39b_lab)
 

  
  
df_trial %>% 
  group_by( Q_lab, V1) %>% 
  tally() %>%
  dplyr::mutate(freq = round(n/sum(n), 3)*100, Frequency = paste0(freq, "%"))%>% 
  ggplot(aes(x = reorder(Q_lab, freq), y = freq, fill = V1)) + 
  geom_bar(position = position_dodge2(preserve = "single"), stat = "identity")+
  coord_flip() + 
  scale_fill_manual(values = gr_colors$color) +
  geom_text(aes(label = Frequency),
                position = position_dodge(width  = 0.8), size = 3)+
  labs(x= "Subtype of organization", y = "Frequency", title = paste("Question", vr, "Subtype of organization - by group"), fill = element_blank())+
  scale_y_continuous(limits=c(0,101), breaks= seq(0,101, by=10)) + 
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  theme(legend.position= "bottom")
  
df_trial %>% 
  group_by( Q_lab, V1) %>% 
  tally() %>%
  dplyr::mutate(freq = round(n/sum(n), 3)*100, Frequency = paste0(freq, "%"))%>% 
  dplyr::arrange(desc(freq)) %>% 
  dplyr::select("Group" = V1, "Subtype of organization" = Q_lab, "Count" = n,  Frequency) %>% 
  write_csv(., paste0(tbl_questions, "pregunta_V39b(Subtype of organization)_by_gr_entrevistados", ".csv")) %>% 
  flextable(.)

```

\pagebreak

### Question V39b (Interviewed) spider graph

```{r v39b_spider,echo=FALSE,warning=FALSE,fig.width=15, fig.height=11, cache = F}

vr <- "V39b"
df_trial <- type_org %>%
  dplyr::filter(Rodada_2019 == "1") %>%
  dplyr::filter(V39a_lab != "Not avaliable") %>% 
  dplyr::rename("Q_lab" = V39b_lab) 
  
df_trial %>% 
  group_by( Q_lab, V1) %>% 
  tally() %>%
  dplyr::mutate(freq = round(n/sum(n), 3)*100, Frequency = paste0(freq, "%"))%>% 
  pivot_wider(id_cols = V1, names_from = Q_lab, values_from = freq) %>% 
  dplyr::mutate_if(is.numeric, .funs = function(i)ifelse(is.na(i), 0, i/100)) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V39b_spider(Subtype of organization)", ".csv")) %>%
  ggradar(., group.colours  = gr_colors$color[-4],group.line.width = 1,  group.point.size = 3)



```

\pagegbreak


## Question V40a - Official economic section of organization (CNAE)

```{r v40a,echo=FALSE,warning=FALSE,fig.width=11, fig.height = 8, cache = F}


vr <- paste0("V40a_", 0:11)
df_trial <- new_data$orgs_atributos %>% 
  dplyr::select(ID, Nome, V1, !!vr) %>% 
  tidyr::drop_na() %>% 
  pivot_longer(cols = V40a_0:V40a_11) %>% 
  dplyr::mutate(Q_lab = case_when(
    name == vr[1]       ~"No information",
    name == vr[2] 	    ~"Agriculture, ranching, forestry, fishing, aquiculture",
    name == vr[3]	      ~"Extrative industries",
    name == vr[4] 	    ~"Manufacturing industries",
    name == vr[5] 	    ~"Commerce",
    name == vr[6] 	    ~"Information and communication",
    name == vr[7] 	    ~"Financial, insurance and related activities",
    name == vr[8]	      ~"Professional, scientific and technical activities",
    name == vr[9] 	    ~"Education",
    name == vr[10]      ~"Other activities and services",
    name == vr[11] 	    ~"International organizations and extraterritorial institutions",
    name == vr[12]	    ~"Transportation, storage and mail",
    TRUE                ~"Not avaliable"
  )) %>% 
  dplyr::filter(Q_lab != "Not avaliable") 
  

tots <- new_data$orgs_atributos %>% 
  dplyr::select(ID, Nome, V1, !!vr) %>% 
  tidyr::drop_na() %>% 
  group_by(V1) %>% 
  tally()

# df_trial %>% 
#   group_by( V1, Q_lab) %>% 
#   dplyr::summarise( Count = sum(as.numeric(value))) %>%
#   ungroup %>% 
#   dplyr::left_join(., tots , by ="V1") %>% 
#   dplyr::mutate(freq = round(Count/n,3), n = NULL) %>%
#   pivot_wider(id_cols = V1, names_from = Q_lab, values_from = freq) %>%
#   ggradar(., group.colours  = c("olivedrab3", "tomato", "gold"),group.line.width = 1,  group.point.size = 3)
  
    
df_trial %>% 
  group_by( V1, Q_lab) %>% 
  dplyr::summarise( Count = sum(as.numeric(value))) %>%
  ungroup %>% 
  dplyr::left_join(., tots , by ="V1") %>% 
  dplyr::mutate(freq = round(Count/n,3)*100, Frequency = paste0(freq, "%")) %>% 
  dplyr::filter(freq != 0) %>% 
  ggplot(aes(x = reorder(Q_lab, freq), y = freq, fill = V1)) +
  geom_bar(position = position_dodge2(preserve = "single", width = 1), stat = "identity", width = 0.8)+
  coord_flip() +
  scale_fill_manual(values = gr_colors$color) +
  geom_text(aes(label = Frequency),
                position = position_dodge(width  = 0.8), size = 3)+
  labs(x= element_blank(), y = "Frequency", title = paste("Question V40a - ", "Official economic section of organization (CNAE)"), fill = element_blank())+
  scale_y_continuous(limits=c(0,101), breaks= seq(0,101, by=10)) +
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  theme(legend.position= "bottom", aspect.ratio = 0.6)



df_trial %>% 
  group_by( V1, Q_lab) %>% 
  dplyr::summarise( Count = sum(as.numeric(value))) %>%
  ungroup %>% 
  dplyr::left_join(., tots , by ="V1") %>% 
  dplyr::mutate(freq = round(Count/n,3)*100, Frequency = paste0(freq, "%")) %>% 
  dplyr::filter(freq != 0) %>% 
  dplyr::select(Group = V1, "Seção Econômica CNAE" = Q_lab, Count, Frequency) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V40a( Official economic section of organization (CNAE))", ".csv")) %>% 
  flextable(.) 

```

### Soporte de interpretación

Este groupsáfico muestra los porcentajes por cada grupo de los sectores económicos a los cuales pertenecen los miembros de la PPA. El 53.7% de los miembros de la PPA que pertenecen al grupo B tiene como sector de actuación las "Atividades profissionais, científicas e técnicas", en el grupo A2 el 80% de sus miembros se desenvuelve en este mismo sector, así como el 35.1% de los miembros de la PPA pertenecientes al grupo A. Notese que los porcentajes no suman 100% debido a que estas categorías son de multiple respuesta, es decir, una empresa puede tener mas de un sector de actuación. Por lo anterior, del 53.7% de las empresas pertenecientes al grupo B que actúan en el sector de "Atividades profissionais, científicas e técnicas" hay un 46.3% que no actúa.

\pagebreak

## Question V40a - Official economic section of organization (CNAE) (Interviewed)

```{r v40a_entrev,echo=FALSE,warning=FALSE,fig.width=11, fig.height = 8, cache = F}


vr <- paste0("V40a_", 0:11)
df_trial <- new_data$orgs_atributos %>% 
  dplyr::select(ID, Nome, V1, !!vr) %>% 
  tidyr::drop_na() %>% 
  pivot_longer(cols = V40a_0:V40a_11) %>% 
  dplyr::mutate(Q_lab = case_when(
    name == vr[1]       ~"No information",
    name == vr[2] 	    ~"Agriculture, ranching, forestry, fishing, aquiculture",
    name == vr[3]	      ~"Extrative industries",
    name == vr[4] 	    ~"Manufacturing industries",
    name == vr[5] 	    ~"Commerce",
    name == vr[6] 	    ~"Information and communication",
    name == vr[7] 	    ~"Financial, insurance and related activities",
    name == vr[8]	      ~"Professional, scientific and technical activities",
    name == vr[9] 	    ~"Education",
    name == vr[10]      ~"Other activities and services",
    name == vr[11] 	    ~"International organizations and extraterritorial institutions",
    name == vr[12]	    ~"Transportation, storage and mail",
    TRUE                ~"Not avaliable"
  )) %>% 
  dplyr::filter(Q_lab != "Not avaliable") 



df_trial <-df_trial %>% 
  dplyr::left_join(., groups %>%  dplyr::select(ID, Rodada_2019), by = c("ID" = "ID")) %>% 
  dplyr::filter(Rodada_2019 == "1") %>% 
  dplyr::select(-Rodada_2019)  

tots <- new_data$orgs_atributos %>% 
  dplyr::filter(!!parse_quo(vr[1], env = caller_env()) != "1") %>% 
  dplyr::select(ID, Nome, V1, !!vr) %>%
  dplyr::left_join(., groups %>%  dplyr::select(ID, Rodada_2019), by = c("ID" = "ID")) %>% 
  dplyr::filter(Rodada_2019 == "1") %>% 
  dplyr::select(-Rodada_2019) %>% 
  tidyr::drop_na() %>% 
  group_by(V1) %>% 
  tally()

# df_trial %>% 
#   group_by( V1, Q_lab) %>% 
#   dplyr::summarise( Count = sum(as.numeric(value))) %>%
#   ungroup %>% 
#   dplyr::left_join(., tots , by ="V1") %>% 
#   dplyr::mutate(freq = round(Count/n,3), n = NULL) %>%
#   pivot_wider(id_cols = V1, names_from = Q_lab, values_from = freq) %>%
#   ggradar(., group.colours  = c("olivedrab3", "tomato", "gold"),group.line.width = 1,  group.point.size = 3)
  
    
df_trial %>% 
  group_by( V1, Q_lab) %>% 
  dplyr::summarise( Count = sum(as.numeric(value))) %>%
  ungroup %>% 
  dplyr::left_join(., tots , by ="V1") %>% 
  dplyr::mutate(freq = round(Count/n,3)*100, Frequency = paste0(freq, "%")) %>% 
  dplyr::filter(freq != 0) %>% 
  ggplot(aes(x = reorder(Q_lab, freq), y = freq, fill = V1)) +
  geom_bar(position = position_dodge2(preserve = "single", width = 1), stat = "identity", width = 0.8)+
  coord_flip() +
  scale_fill_manual(values = gr_colors$color) +
  geom_text(aes(label = Frequency),
                position = position_dodge(width  = 0.8), size = 3)+
  labs(x= element_blank(), y = "Frequency", title = paste("Question V40a - ", "Official economic section of organization (CNAE)"), fill = element_blank())+
  scale_y_continuous(limits=c(0,101), breaks= seq(0,101, by=10)) +
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  theme(legend.position= "bottom", aspect.ratio = 0.6)
  
df_trial %>% 
  group_by( V1, Q_lab) %>% 
  dplyr::summarise( Count = sum(as.numeric(value))) %>%
  ungroup %>% 
  dplyr::left_join(., tots , by ="V1") %>% 
  dplyr::mutate(freq = round(Count/n,3)*100, Frequency = paste0(freq, "%")) %>% 
  dplyr::filter(freq != 0) %>% 
  dplyr::select(Group = V1, "Seção Econômica CNAE" = Q_lab, Count, Frequency) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V40a( Official economic section of organization (CNAE))_Interviewed", ".csv")) %>% 
  flextable(.) 

```


\pagebreak


## Question V40b - Number of official economic sections (CNAE)

```{r v40b,echo=FALSE,warning=FALSE,fig.width=11, fig.height=8, cache = F, dpi = 200}


vr <- "V40b"
df_trial <- new_data$orgs_atributos %>% 
  dplyr::select(ID, Nome, V1, !!vr) %>% 
  tidyr::drop_na() %>% 
  dplyr::mutate(Q_lab = case_when(
    !!parse_quo(vr, env = caller_env()) == 0  ~"No information",
    !!parse_quo(vr, env = caller_env()) == 1 	~"One economic section",
    !!parse_quo(vr, env = caller_env())	== 2  ~"Two economic sections",
    !!parse_quo(vr, env = caller_env()) == 3	~"Three or more economic sections",
    TRUE                ~"Not avaliable"
  )) %>% 
  dplyr::filter(Q_lab != "Not avaliable") %>% 
  dplyr::filter(!Nome %in% c("Nenhuma", "Não se aplica"))




  
df_trial %>% 
  dplyr::group_by(V1) %>% 
  dplyr::mutate(tot = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(V1, Q_lab) %>% 
  dplyr::summarise(Count = n(), tot = unique(tot),freq = round(Count/tot,3)*100, Frequency = paste0(freq, "%")) %>%
  ggplot(aes(x = 2, y = freq, fill = factor(Q_lab)))+
  geom_bar(stat = "identity", width = 1, color = "white")+
  coord_polar("y", start= 0) +
  facet_wrap(~V1)+
  scale_fill_manual(values = c("#0073C2FF","#CD534CFF", "#EFC000FF" ))+
  geom_text(aes(label = Frequency),
            position = position_stack(vjust  = 0.5), size = 4)+
  xlim(0.5, 2.5)+
  theme_bw()+
  labs(x= element_blank(), y = element_blank(), title = paste("Question V40b by groups (Number of official economic sections (CNAE))"), fill = element_blank())+
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  theme(legend.position= "bottom", 
        axis.text.x=element_blank(),
        axis.text.y=element_blank(), 
        axis.ticks=element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank())


 

df_trial %>% 
  dplyr::group_by(V1) %>% 
  dplyr::mutate(tot = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(V1, Q_lab) %>% 
  dplyr::summarise(Count = n(), tot = unique(tot),freq = round(Count/tot,3)*100, Frequency = paste0(freq, "%")) %>% 
  dplyr::select(Group = V1, "Number of official economic sections (CNAE)" = Q_lab, Count, Percentage = Frequency) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V40b(Number of official economic sections (CNAE))_by_gr", ".csv")) %>%  
  flextable(., cwidth = 2)  %>%
  set_caption(., caption = "Percentage by Group")


df_trial %>% 
  dplyr::group_by(Q_lab) %>% 
  dplyr::summarise(Count = n(), freq = round(Count/nrow(.),3)*100, Frequency = paste0(freq, "%")) %>% 
  dplyr::select("Number of official economic sections (CNAE)" = Q_lab,Percentage = Frequency )%T>%
  write_csv(., paste0(tbl_questions, "pregunta_V40b(Number of official economic sections (CNAE))", ".csv")) %>%
  flextable(., cwidth = 2) 

  # ggplot(aes(x = Q_lab, y = freq))+
  # geom_bar(stat = "identity", fill = "#2ca25f")+
  # coord_flip() +
  # geom_text(aes(label = Frequency),
  #               position = position_stack(vjust  = 0.8), size = 3)+
  # labs(x= "Seção Econômica CNAE", y = "Frequency", title = paste("Question V40b"), fill = "Groups")+
  # scale_y_continuous(limits=c(0,101), breaks= seq(0,101, by=10)) +
  # labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  # theme(legend.position= "none")

```


\pagebreak


## Question V40b - Number of official economic sections (CNAE) (Interviewed)

```{r v40b_entrev,echo=FALSE,warning=FALSE,fig.width=11, fig.height=8, cache = F, dpi = 200}


vr <- "V40b"
df_trial <- new_data$orgs_atributos %>% 
  dplyr::select(ID, Nome, V1, !!vr) %>% 
  tidyr::drop_na() %>% 
  dplyr::mutate(Q_lab = case_when(
    !!parse_quo(vr, env = caller_env()) == 0  ~"No information",
    !!parse_quo(vr, env = caller_env()) == 1 	~"One economic section",
    !!parse_quo(vr, env = caller_env())	== 2  ~"Two economic sections",
    !!parse_quo(vr, env = caller_env()) == 3	~"Three or more economic sections",
    TRUE                ~"Not avaliable"
  )) %>% 
  dplyr::filter(Q_lab != "Not avaliable") %>% 
  dplyr::filter(!Nome %in% c("Nenhuma", "Não se aplica"))


df_trial <-df_trial %>% 
  dplyr::left_join(., groups %>%  dplyr::select(ID, Rodada_2019), by = c("ID" = "ID")) %>% 
  dplyr::filter(Rodada_2019 == "1") %>% 
  dplyr::select(-Rodada_2019)

  
df_trial %>% 
  dplyr::group_by(V1) %>% 
  dplyr::mutate(tot = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(V1, Q_lab) %>% 
  dplyr::summarise(Count = n(), tot = unique(tot),freq = round(Count/tot,3)*100, Frequency = paste0(freq, "%")) %>%
  ggplot(aes(x = 2, y = freq, fill = factor(Q_lab)))+
  geom_bar(stat = "identity", width = 1, color = "white")+
  coord_polar("y", start= 0) +
  facet_wrap(~V1)+
  scale_fill_manual(values = c("#0073C2FF","#CD534CFF", "#EFC000FF" ))+
  geom_text(aes(label = Frequency),
            position = position_stack(vjust  = 0.5), size = 4)+
  xlim(0.5, 2.5)+
  theme_bw()+
  labs(x= element_blank(), y = element_blank(), title = paste("Question V40b - Number of official economic sections (CNAE) by group"), fill = element_blank())+
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  theme(legend.position= "bottom", 
        axis.text.x=element_blank(),
        axis.text.y=element_blank(), 
        axis.ticks=element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank())

df_trial %>% 
  dplyr::group_by(V1) %>% 
  dplyr::mutate(tot = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(V1, Q_lab) %>% 
  dplyr::summarise(Count = n(), tot = unique(tot),freq = round(Count/tot,3)*100, Frequency = paste0(freq, "%")) %>% 
  dplyr::select(Group = V1, "Number of official economic sections (CNAE)" = Q_lab, Count, Percentage = Frequency) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V40b(Number of official economic sections (CNAE))_by_gr_entrev", ".csv")) %>%  
  flextable(., cwidth = 2)  


df_trial %>% 
  dplyr::group_by(Q_lab) %>% 
  dplyr::summarise(Count = n(), freq = round(Count/nrow(.),3)*100, Frequency = paste0(freq, "%")) %>% 
  dplyr::select("Number of official economic sections (CNAE)" = Q_lab,Percentage = Frequency )%T>%
  write_csv(., paste0(tbl_questions, "pregunta_V40b(Number of official economic sections (CNAE))_entrev", ".csv")) %>%
  flextable(., cwidth = 2) 

  # ggplot(aes(x = Q_lab, y = freq))+
  # geom_bar(stat = "identity", fill = "#2ca25f")+
  # coord_flip() +
  # geom_text(aes(label = Frequency),
  #               position = position_stack(vjust  = 0.8), size = 3)+
  # labs(x= "Seção Econômica CNAE", y = "Frequency", title = paste("Question V40b"), fill = "Groups")+
  # scale_y_continuous(limits=c(0,101), breaks= seq(0,101, by=10)) +
  # labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  # theme(legend.position= "none")

```



\pagebreak


## Question V41a - Official economic class of organization (CNAE)

```{r v41a,echo=FALSE,warning=FALSE,fig.width=11, fig.height=8, cache = FALSE}

vr <- paste0("V41a_", 0:69)
df_trial <- new_data$orgs_atributos %>% 
  dplyr::select(ID, Nome, V1, !!vr) %>% 
  tidyr::drop_na() %>%
  pivot_longer(cols = -(ID:V1), names_to= "nms") %>% 
  dplyr::mutate(Q_lab = case_when(
nms =='V41a_0'~'No information',
nms =='V41a_1'~'Activities of employer and business membership organizations',
nms =='V41a_2'~'Cultivation of permanent crops',
nms =='V41a_3'~'Manufacture of refined vegetable oils, except corn oil',
nms =='V41a_4'~'Extraction of aluminum ore',
nms =='V41a_5'~'Fund management activities by contract or commission',
nms =='V41a_6'~'Manufacture of spirits and other distilled beverages',
nms =='V41a_7'~'Manufacture of malt, beer and draft beer',
nms =='V41a_8'~'Manufacture of bottled water',
nms =='V41a_9'~'Manufacture of soft drinks and other non-alcoholic beverages',
nms =='V41a_10'~'Professional, scientific and technical activities',
nms =='V41a_11'~'Specialized computer equipment and supplies retailer',
nms =='V41a_12'~'Specialized telephone and communication equipment retailer',
nms =='V41a_13'~'Specialized retailer of home appliances and audio and video equipment',
nms =='V41a_14'~'Sales representatives and trade agents specialising in products not elsewhere specified',
nms =='V41a_15'~'Activities in support of agriculture',
nms =='V41a_16'~'Manufacture of food products not elsewhere specified',
nms =='V41a_17'~'Storage',
nms =='V41a_18'~'Activities in support of ranching',
nms =='V41a_19'~'Activities in support of oil and natural gas extraction',
nms =='V41a_20'~'Manufacture of vegetable and animal oils and fats',
nms =='V41a_21'~'Manufacture of cocoa products, chocolate and sugar confectionery',
nms =='V41a_22'~'Manufacture of pharmaceutical preparations',
nms =='V41a_23'~'Activities of social rights associations',
nms =='V41a_24'~'Legal activities, except notary offices',
nms =='V41a_25'~'Manufacture of fertilizers and manure products',
nms =='V41a_26'~'Manufacture of agricultural defensives',
nms =='V41a_27'~'Manufacture of parts and accessories for motor vehicles',
nms =='V41a_28'~'Manufacture of cosmetics, perfumery and personal hygiene products',
nms =='V41a_29'~'Metallurgy',
nms =='V41a_30'~'Manufacture of various chemical products and preparations',
nms =='V41a_31'~'Open television activities',
nms =='V41a_32'~'Film, video and television production activities',
nms =='V41a_33'~'Film, video and television post-production activities',
nms =='V41a_34'~'Extraction of stone, sand and clay',
nms =='V41a_35'~'Higher education - graduate and extension',
nms =='V41a_36'~'Other financial services activities not elsewhere specified',
nms =='V41a_37'~'Wholesale of goods in general, with predominance of food products',
nms =='V41a_38'~'Cosmetics, perfume and toiletries retail trade',
nms =='V41a_39'~'Activities of trade union organisations',
nms =='V41a_40'~'International bodies and other extraterritorial institutions',
nms =='V41a_41'~'Iron ore extraction',
nms =='V41a_42'~'Extraction of non-ferrous metallic minerals not elsewhere specified',
nms =='V41a_43'~'Extraction of mineral coal',
nms =='V41a_44'~'Extraction of manganese ore',
nms =='V41a_45'~'Ferroalloy production',
nms =='V41a_46'~'Rail freight transport',
nms =='V41a_47'~'Cabotage maritime transport',
nms =='V41a_48'~'Manufacture of household appliances',
nms =='V41a_49'~'Commercial representatives and agents of the electrical appliance, furniture and household goods trade',
nms =='V41a_50'~'Retailing of other new products not elsewhere specified',
nms =='V41a_51'~'Manufacture of instruments and materials for medical and dental use and optical articles',
nms =='V41a_52'~'Manufacture of petroleum products',
nms =='V41a_53'~'Manufacture of resins and elastomers',
nms =='V41a_54'~'Manufacture of soaps, detergents, cleaning products, cosmetics, perfumery and personal hygiene products',
nms =='V41a_55'~'Internet portals, content providers and other information services',
nms =='V41a_56'~'Teaching activities not elsewhere specified',
nms =='V41a_57'~'Film, video and television production activities',
nms =='V41a_58'~'Retailer of fruit, vegetables and poultry products',
nms =='V41a_59'~'Magazine publishing',
nms =='V41a_60'~'Integrated edition for magazine printing',
nms =='V41a_61'~'Road freight transport',
nms =='V41a_62'~'Inland waterway freight transport',
nms =='V41a_63'~'Auxiliary activities of water transportation',
nms =='V41a_64'~'Grinding, manufacture of starch products and animal feed',
nms =='V41a_65'~'Manufacture of footwear of materials not elsewhere specified',
nms =='V41a_66'~'Higher Education - undergraduate and graduate studies',
nms =='V41a_67'~'Beekeeping',
nms =='V41a_68'~'Manufacture of articles of wood, straw, cork, osier and other plaiting materials not elsewhere specified, except furniture',
nms =='V41a_69'~'Accounting, consulting and auditing activities',
TRUE ~ "Not avaliable"
))


non_response <- df_trial %>% 
 dplyr::filter(nms == "V41a_0", value  != 0) %>%
  nrow()
non_res_frq <- round(non_response/length(unique(df_trial$Nome))*100)

#add_row(Q_lab = "No information Rate",  total = non_response, A_frq = paste0(non_res_frq,"%"), A2_frq = A_frq,  B_freq =A_frq )

df_trial %>% 
  dplyr::mutate(value = as.numeric(value)) %>% 
  dplyr::filter(value != 0 ) %>% 
  dplyr::filter(nms != "V41a_0") %>%
  dplyr::group_by(V1, Q_lab) %>% 
  tally() %>% 
  pivot_wider(id_cols = Q_lab, names_from = V1, values_from = n) %>% 
  dplyr::mutate_at(.vars = c("A", "A2", "B"), .funs = function(i){ifelse(is.na(i),0, i)}) %>% 
  dplyr::mutate(A_frq = paste0(round(A/gr_colors$n[1],3)*100, "%"), A2_frq = paste0(round(A2/gr_colors$n[2], 3)*100, "%"), B_freq = paste0(round(B/gr_colors$n[3], 3)*100, "%"), total = A + A2 + B) %>% 
  arrange(desc(total)) %>% 
  add_row(Q_lab = "No information Rate",  total = non_response, A_frq = paste0(non_res_frq,"%"), A2_frq = A_frq,  B_freq =A_frq ) %>%
  dplyr::select("Official economic class of organization (CNAE)" = Q_lab, everything(),  total) %>%
  data.frame() %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V41a(Official economic class of organization (CNAE))", ".csv")) %>% 
  flextable(.) 


```

\pagebreak


## Question V41a - Official economic class of organization (CNAE) (Interviewed)

```{r v41a_entrev,echo=FALSE,warning=FALSE,fig.width=11, fig.height=8, cache = FALSE}

vr <- paste0("V41a_", 0:69)
df_trial <- new_data$orgs_atributos %>% 
  dplyr::select(ID, Nome, V1, !!vr) %>% 
  tidyr::drop_na() %>%
  pivot_longer(cols = -(ID:V1), names_to= "nms") %>% 
  dplyr::mutate(Q_lab = case_when(
nms =='V41a_0'~'No information',
nms =='V41a_1'~'Activities of employer and business membership organizations',
nms =='V41a_2'~'Cultivation of permanent crops',
nms =='V41a_3'~'Manufacture of refined vegetable oils, except corn oil',
nms =='V41a_4'~'Extraction of aluminum ore',
nms =='V41a_5'~'Fund management activities by contract or commission',
nms =='V41a_6'~'Manufacture of spirits and other distilled beverages',
nms =='V41a_7'~'Manufacture of malt, beer and draft beer',
nms =='V41a_8'~'Manufacture of bottled water',
nms =='V41a_9'~'Manufacture of soft drinks and other non-alcoholic beverages',
nms =='V41a_10'~'Professional, scientific and technical activities',
nms =='V41a_11'~'Specialized computer equipment and supplies retailer',
nms =='V41a_12'~'Specialized telephone and communication equipment retailer',
nms =='V41a_13'~'Specialized retailer of home appliances and audio and video equipment',
nms =='V41a_14'~'Sales representatives and trade agents specialising in products not elsewhere specified',
nms =='V41a_15'~'Activities in support of agriculture',
nms =='V41a_16'~'Manufacture of food products not elsewhere specified',
nms =='V41a_17'~'Storage',
nms =='V41a_18'~'Activities in support of ranching',
nms =='V41a_19'~'Activities in support of oil and natural gas extraction',
nms =='V41a_20'~'Manufacture of vegetable and animal oils and fats',
nms =='V41a_21'~'Manufacture of cocoa products, chocolate and sugar confectionery',
nms =='V41a_22'~'Manufacture of pharmaceutical preparations',
nms =='V41a_23'~'Activities of social rights associations',
nms =='V41a_24'~'Legal activities, except notary offices',
nms =='V41a_25'~'Manufacture of fertilizers and manure products',
nms =='V41a_26'~'Manufacture of agricultural defensives',
nms =='V41a_27'~'Manufacture of parts and accessories for motor vehicles',
nms =='V41a_28'~'Manufacture of cosmetics, perfumery and personal hygiene products',
nms =='V41a_29'~'Metallurgy',
nms =='V41a_30'~'Manufacture of various chemical products and preparations',
nms =='V41a_31'~'Open television activities',
nms =='V41a_32'~'Film, video and television production activities',
nms =='V41a_33'~'Film, video and television post-production activities',
nms =='V41a_34'~'Extraction of stone, sand and clay',
nms =='V41a_35'~'Higher education - graduate and extension',
nms =='V41a_36'~'Other financial services activities not elsewhere specified',
nms =='V41a_37'~'Wholesale of goods in general, with predominance of food products',
nms =='V41a_38'~'Cosmetics, perfume and toiletries retail trade',
nms =='V41a_39'~'Activities of trade union organisations',
nms =='V41a_40'~'International bodies and other extraterritorial institutions',
nms =='V41a_41'~'Iron ore extraction',
nms =='V41a_42'~'Extraction of non-ferrous metallic minerals not elsewhere specified',
nms =='V41a_43'~'Extraction of mineral coal',
nms =='V41a_44'~'Extraction of manganese ore',
nms =='V41a_45'~'Ferroalloy production',
nms =='V41a_46'~'Rail freight transport',
nms =='V41a_47'~'Cabotage maritime transport',
nms =='V41a_48'~'Manufacture of household appliances',
nms =='V41a_49'~'Commercial representatives and agents of the electrical appliance, furniture and household goods trade',
nms =='V41a_50'~'Retailing of other new products not elsewhere specified',
nms =='V41a_51'~'Manufacture of instruments and materials for medical and dental use and optical articles',
nms =='V41a_52'~'Manufacture of petroleum products',
nms =='V41a_53'~'Manufacture of resins and elastomers',
nms =='V41a_54'~'Manufacture of soaps, detergents, cleaning products, cosmetics, perfumery and personal hygiene products',
nms =='V41a_55'~'Internet portals, content providers and other information services',
nms =='V41a_56'~'Teaching activities not elsewhere specified',
nms =='V41a_57'~'Film, video and television production activities',
nms =='V41a_58'~'Retailer of fruit, vegetables and poultry products',
nms =='V41a_59'~'Magazine publishing',
nms =='V41a_60'~'Integrated edition for magazine printing',
nms =='V41a_61'~'Road freight transport',
nms =='V41a_62'~'Inland waterway freight transport',
nms =='V41a_63'~'Auxiliary activities of water transportation',
nms =='V41a_64'~'Grinding, manufacture of starch products and animal feed',
nms =='V41a_65'~'Manufacture of footwear of materials not elsewhere specified',
nms =='V41a_66'~'Higher Education - undergraduate and graduate studies',
nms =='V41a_67'~'Beekeeping',
nms =='V41a_68'~'Manufacture of articles of wood, straw, cork, osier and other plaiting materials not elsewhere specified, except furniture',
nms =='V41a_69'~'Accounting, consulting and auditing activities',
TRUE ~ "Not avaliable"
))


df_trial <-df_trial %>% 
  dplyr::left_join(., groups %>%  dplyr::select(ID, Rodada_2019), by = c("ID" = "ID")) %>% 
  dplyr::filter(Rodada_2019 == "1") %>% 
  dplyr::select(-Rodada_2019)

non_response <- df_trial %>% 
 dplyr::filter(nms == "V41a_0", value  != 0) %>%
  nrow()
non_res_frq <- round(non_response/length(unique(df_trial$Nome))*100)

#add_row(Q_lab = "No information Rate",  total = non_response, A_frq = paste0(non_res_frq,"%"), A2_frq = A_frq,  B_freq =A_frq )


df_trial %>% 
  dplyr::mutate(value = as.numeric(value)) %>% 
  dplyr::filter(value != 0 ) %>% 
  dplyr::group_by(V1, Q_lab) %>% 
  tally() %>% 
  pivot_wider(id_cols = Q_lab, names_from = V1, values_from = n) %>% 
  dplyr::mutate_at(.vars = c("A", "A2", "B"), .funs = function(i){ifelse(is.na(i),0, i)}) %>% 
  dplyr::mutate(A_frq = paste0(round(A/gr_colors$n[1],3)*100, "%"), A2_frq = paste0(round(A2/gr_colors$n[2], 3)*100, "%"), B_freq = paste0(round(B/gr_colors$n[3], 3)*100, "%"), total = A + A2 + B) %>% 
  arrange(desc(total)) %>% 
  add_row(Q_lab = "No information Rate",  total = non_response, A_frq = paste0(non_res_frq,"%"), A2_frq = A_frq,  B_freq =A_frq ) %>% 
  dplyr::select("Official economic class of organization (CNAE)" = Q_lab, everything(),  total) %>%
  data.frame() %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V41a(Official economic class of organization (CNAE))_entrev", ".csv")) %>% 
  flextable(.) 


```




\pagebreak


## Question V41b - Number of official economic classes (CNAE)

```{r v41b,echo=FALSE,warning=FALSE,fig.width=11, fig.height=8, cache = F, dpi = 200}

vr <- "V41b"
df_trial <- new_data$orgs_atributos %>% 
  dplyr::select(ID, Nome, V1, !!vr) %>% 
  tidyr::drop_na() %>% 
  dplyr::mutate(Q_lab = case_when(
    !!parse_quo(vr, env = caller_env()) == 0  ~"No information",
    !!parse_quo(vr, env = caller_env()) == 1 	~"One economic class",
    !!parse_quo(vr, env = caller_env())	== 2  ~"Two economic classes",
    !!parse_quo(vr, env = caller_env()) == 3	~"Three economic classes" ,
    !!parse_quo(vr, env = caller_env()) == 4	~"Four economic classes" ,
    !!parse_quo(vr, env = caller_env()) == 5	~"Five economic classes" ,
    !!parse_quo(vr, env = caller_env()) == 6	~"Six or more economic classes" ,
    TRUE                ~"Not avaliable"
  )) %>% 
  dplyr::filter(Q_lab != "Not avaliable") %>% 
  dplyr::filter(!Nome %in% c("Nenhuma", "Não se aplica"))

  
df_trial %>% 
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
  dplyr::group_by(V1) %>% 
  dplyr::mutate(tot = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(V1, Q_lab) %>% 
  dplyr::summarise(Count = n(), tot = unique(tot),freq = round(Count/tot,3)*100, Frequency = paste0(freq, "%")) %>% 
  ggplot(aes(x = 2, y = freq, fill = factor(Q_lab)))+
  geom_bar(stat = "identity", width = 1, color = "white")+
  coord_polar("y", start= 0) +
  facet_wrap(~V1)+
  scale_fill_manual(values = c("#d8b365",
"#377eb8",
"#4daf4a",
"#984ea3",
"#ff7f00",
"#5ab4ac"))+ #c("#CD534CFF", "#0073C2FF", "#EFC000FF",  )
  geom_text(aes(label = Frequency),
            position = position_stack(vjust  = 0.5), size = 4)+
  xlim(0.5, 2.5)+
  theme_bw()+
  labs(x= element_blank(), y = element_blank(), title = paste("Question V41b (Número de classes econômicas CNAE)"), fill = element_blank())+
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  theme(legend.position= "bottom", 
        axis.text.x=element_blank(),
        axis.text.y=element_blank(), 
        axis.ticks=element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank())


non_response <- df_trial %>% 
 dplyr::filter(!!parse_quo(vr, env = caller_env()) == "0") %>%
  nrow()
non_res_frq <- round(non_response/nrow(df_trial)*100)

#ungroup() %>% 
#add_row(Q_lab = "No information Rate",  total = non_response, A_frq = paste0(non_res_frq,"%"), A2_frq = A_frq,  B_freq =A_frq )


df_trial %>% 
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
  dplyr::group_by(V1) %>% 
  dplyr::mutate(tot = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(V1, Q_lab) %>% 
  dplyr::summarise(Count = n(), tot = unique(tot),freq = round(Count/tot,3)*100, Frequency = paste0(freq, "%")) %>% 
  ungroup() %>% 
  add_row(V1 = "No information", Q_lab = "No information Rate",  Count = non_response, tot = Count, freq = non_res_frq ,Frequency = paste0(non_res_frq,"%")) %>% 
  dplyr::select(Group = V1, "Number of official economic classes (CNAE)" = Q_lab, Count, Percentage = Frequency) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V41b(Number of official economic classes (CNAE))_by_gr", ".csv")) %>% 
  flextable(., cwidth = 2) %>% 
  set_caption(., caption = "Frequency by Group")


df_trial %>% 
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
  dplyr::group_by(Q_lab) %>% 
  dplyr::summarise(Count = n(), freq = round(Count/nrow(.),3)*100, Frequency = paste0(freq, "%")) %>%
   ungroup() %>% 
  add_row(Q_lab = "No information Rate",  Count = non_response, freq = non_res_frq ,Frequency = paste0(non_res_frq,"%")) %>% 
  dplyr::select("Number of official economic classes (CNAE)" = Q_lab, Count, Percentage = Frequency ) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V41b(Number of official economic classes (CNAE))", ".csv")) %>%
  flextable(., cwidth = 2)

```


\pagebreak


## Question V41b - Number of official economic classes (CNAE) (Interviewed)

```{r v41b_entrev,echo=FALSE,warning=FALSE,fig.width=11, fig.height=8, cache = F, dpi = 200}

vr <- "V41b"
df_trial <- new_data$orgs_atributos %>% 
  dplyr::select(ID, Nome, V1, !!vr) %>% 
  tidyr::drop_na() %>% 
  dplyr::mutate(Q_lab = case_when(
    !!parse_quo(vr, env = caller_env()) == 0  ~"No information",
    !!parse_quo(vr, env = caller_env()) == 1 	~"One economic class",
    !!parse_quo(vr, env = caller_env())	== 2  ~"Two economic classes",
    !!parse_quo(vr, env = caller_env()) == 3	~"Three economic classes" ,
    !!parse_quo(vr, env = caller_env()) == 4	~"Four economic classes" ,
    !!parse_quo(vr, env = caller_env()) == 5	~"Five economic classes" ,
    !!parse_quo(vr, env = caller_env()) == 6	~"Six or more economic classes" ,
    TRUE                ~"Not avaliable"
  )) %>% 
  dplyr::filter(Q_lab != "Not avaliable") %>% 
  dplyr::filter(!Nome %in% c("Nenhuma", "Não se aplica"))

df_trial <-df_trial %>% 
  dplyr::left_join(., groups %>%  dplyr::select(ID, Rodada_2019), by = c("ID" = "ID")) %>% 
  dplyr::filter(Rodada_2019 == "1") %>% 
  dplyr::select(-Rodada_2019)
  
df_trial %>%
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
  dplyr::group_by(V1) %>% 
  dplyr::mutate(tot = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(V1, Q_lab) %>% 
  dplyr::summarise(Count = n(), tot = unique(tot),freq = round(Count/tot,3)*100, Frequency = paste0(freq, "%")) %>% 
  ggplot(aes(x = 2, y = freq, fill = factor(Q_lab)))+
  geom_bar(stat = "identity", width = 1, color = "white")+
  coord_polar("y", start= 0) +
  facet_wrap(~V1)+
  scale_fill_manual(values = c("#d8b365",
"#377eb8",
"#4daf4a",
"#984ea3",
"#ff7f00",
"#5ab4ac"))+ #c("#CD534CFF", "#0073C2FF", "#EFC000FF",  )
  geom_text(aes(label = Frequency),
            position = position_stack(vjust  = 0.5), size = 4)+
  xlim(0.5, 2.5)+
  theme_bw()+
  labs(x= element_blank(), y = element_blank(), title = paste("Question V41b - Number of official economic classes (CNAE)"), fill = element_blank())+
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  theme(legend.position= "bottom", 
        axis.text.x=element_blank(),
        axis.text.y=element_blank(), 
        axis.ticks=element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank())

non_response <- df_trial %>% 
 dplyr::filter(!!parse_quo(vr, env = caller_env()) == "0") %>%
  nrow()
non_res_frq <- round(non_response/nrow(df_trial)*100)

#dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
#ungroup() %>% 
# add_row(V1 = "No information", Q_lab = "No information Rate",  Count = non_response, tot = Count, freq = non_res_frq,Frequency = paste0(non_res_frq,"%"))



df_trial %>% 
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
  dplyr::group_by(V1) %>% 
  dplyr::mutate(tot = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(V1, Q_lab) %>% 
  dplyr::summarise(Count = n(), tot = unique(tot),freq = round(Count/tot,3)*100, Frequency = paste0(freq, "%")) %>%
  ungroup() %>%
  add_row(V1 = "No information", Q_lab = "No information Rate",  Count = non_response, tot = Count, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>% 
  dplyr::select(Group = V1, "Number of official economic classes (CNAE)" = Q_lab, Count, Percentage = Frequency) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V41b(Number of official economic classes (CNAE))_by_gr_entrev", ".csv")) %>% 
  flextable(., cwidth = 2) %>% 
  set_caption(., caption = "Frequency by Group")


df_trial %>% 
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
  dplyr::group_by(Q_lab) %>% 
  dplyr::summarise(Count = n(), freq = round(Count/nrow(.),3)*100, Frequency = paste0(freq, "%")) %>%
   ungroup() %>%
  add_row(Q_lab = "No information Rate",  Count = non_response, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>% 
  dplyr::select("Number of official economic classes (CNAE)" = Q_lab, Count,Percentage = Frequency ) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V41b(Number of official economic classes (CNAE))_entrev", ".csv")) %>%
  flextable(., cwidth = 2)

```


\pagebreak

## Question V42a - Number of employees


```{r v42a,echo=FALSE,warning=FALSE,fig.width=11, fig.height=8, cache = F, dpi = 200}


vr <- "V42a"
df_trial <- new_data$orgs_atributos %>% 
  dplyr::select(ID, Nome, V1, !!vr) %>% 
  tidyr::drop_na() %>% 
  dplyr::mutate(Q_lab = case_when(
    !!parse_quo(vr, env = caller_env()) == 0  ~"No information",
    !!parse_quo(vr, env = caller_env()) == 1 	~"1 to 19",
    !!parse_quo(vr, env = caller_env())	== 2  ~"20 to 99",
    !!parse_quo(vr, env = caller_env()) == 3	~"100 to 499" ,
    !!parse_quo(vr, env = caller_env()) == 4	~"500 to 9,999" ,
    !!parse_quo(vr, env = caller_env()) == 5	~"10,000 to 99,999" ,
    !!parse_quo(vr, env = caller_env()) == 6	~"100,000 and above" ,
    TRUE                ~"Not avaliable"
  )) %>% 
  dplyr::filter(Q_lab != "Not avaliable") %>% 
  dplyr::filter(!Nome %in% c("Nenhuma", "Não se aplica"))


  
df_trial %>% 
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
  dplyr::group_by(V1) %>% 
  dplyr::mutate(tot = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(V1, Q_lab) %>% 
  dplyr::summarise(Count = n(), tot = unique(tot),freq = round(Count/tot,3)*100, Frequency = paste0(freq, "%")) %>% 
  ggplot(aes(x = 2, y = freq, fill = factor(Q_lab)))+
  geom_bar(stat = "identity", width = 1, color = "white")+
  coord_polar("y", start= 0) +
  facet_wrap(~V1)+
  scale_fill_manual(values = c("#d8b365",
"#377eb8",
"#4daf4a",
"#e9a3c9",
"#ff7f00",
"#5ab4ac",
"#bdbdbd"))+ #c("#CD534CFF", "#0073C2FF", "#EFC000FF",  )
  geom_text(aes(label = Frequency),
            position = position_stack(vjust  = 0.5), size = 4)+
  xlim(0.5, 2.5)+
  theme_bw()+
  labs(x= element_blank(), y = element_blank(), title = paste("Question V42a - Number of employees"), fill = element_blank())+
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  theme(legend.position= "bottom", 
        axis.text.x=element_blank(),
        axis.text.y=element_blank(), 
        axis.ticks=element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank())

non_response <- df_trial %>% 
 dplyr::filter(!!parse_quo(vr, env = caller_env()) == "0") %>%
  nrow()
non_res_frq <- round(non_response/nrow(df_trial)*100)

#dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
#ungroup() %>% 
# add_row(V1 = "No information", Q_lab = "No information Rate",  Count = non_response, tot = Count, freq = non_res_frq,Frequency = paste0(non_res_frq,"%"))

df_trial %>% 
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
  dplyr::group_by(V1) %>% 
  dplyr::mutate(tot = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(V1, Q_lab) %>% 
  dplyr::summarise(Count = n(), tot = unique(tot),freq = round(Count/tot,3)*100, Frequency = paste0(freq, "%")) %>%
  ungroup() %>% 
  add_row(V1 = "No information", Q_lab = "No information Rate",  Count = non_response, tot = Count, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>% 
  dplyr::select(Group = V1, "Number of employees" = Q_lab, Count, Percentage = Frequency) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V42a(Number of employees)_by_gr", ".csv")) %>%  
  flextable(., cwidth = 2) %>% 
  set_caption(., caption = "Frequency by Group")


df_trial %>%
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
  dplyr::group_by(Q_lab) %>% 
  dplyr::summarise(Count = n(), freq = round(Count/nrow(.),3)*100, Frequency = paste0(freq, "%")) %>%
  ungroup() %>% 
  add_row(Q_lab = "No information Rate",  Count = non_response, freq = non_res_frq, Frequency = paste0(non_res_frq,"%")) %>% 
  dplyr::select("Number of employees" = Q_lab, Count, Percentage = Frequency ) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V42a(Number of employees)", ".csv")) %>%
  flextable(., cwidth = 2) 

```

\pagebreak

## Question V42a - Number of employees (Interviewed)


```{r v42a_entrev,echo=FALSE,warning=FALSE,fig.width=11, fig.height=8, cache = F, dpi = 200}


vr <- "V42a"
df_trial <- new_data$orgs_atributos %>% 
  dplyr::select(ID, Nome, V1, !!vr) %>% 
  tidyr::drop_na() %>% 
  dplyr::mutate(Q_lab = case_when(
    !!parse_quo(vr, env = caller_env()) == 0  ~"No information",
    !!parse_quo(vr, env = caller_env()) == 1 	~"1 to 19",
    !!parse_quo(vr, env = caller_env())	== 2  ~"20 to 99",
    !!parse_quo(vr, env = caller_env()) == 3	~"100 to 499" ,
    !!parse_quo(vr, env = caller_env()) == 4	~"500 to 9,999" ,
    !!parse_quo(vr, env = caller_env()) == 5	~"10,000 to 99,999" ,
    !!parse_quo(vr, env = caller_env()) == 6	~"100,000 and above" ,
    TRUE                ~"Not avaliable"
  )) %>% 
  dplyr::filter(Q_lab != "Not avaliable") %>% 
  dplyr::filter(!Nome %in% c("Nenhuma", "Não se aplica"))

df_trial <-df_trial %>% 
  dplyr::left_join(., groups %>%  dplyr::select(ID, Rodada_2019), by = c("ID" = "ID")) %>% 
  dplyr::filter(Rodada_2019 == "1") %>% 
  dplyr::select(-Rodada_2019)

df_trial %>% 
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
  dplyr::group_by(V1) %>% 
  dplyr::mutate(tot = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(V1, Q_lab) %>% 
  dplyr::summarise(Count = n(), tot = unique(tot),freq = round(Count/tot,3)*100, Frequency = paste0(freq, "%")) %>% 
  ggplot(aes(x = 2, y = freq, fill = factor(Q_lab)))+
  geom_bar(stat = "identity", width = 1, color = "white")+
  coord_polar("y", start= 0) +
  facet_wrap(~V1)+
  scale_fill_manual(values = c("#d8b365",
"#377eb8",
"#4daf4a",
"#e9a3c9",
"#ff7f00",
"#5ab4ac",
"#bdbdbd"))+ #c("#CD534CFF", "#0073C2FF", "#EFC000FF",  )
  geom_text(aes(label = Frequency),
            position = position_stack(vjust  = 0.5), size = 4)+
  xlim(0.5, 2.5)+
  theme_bw()+
  labs(x= element_blank(), y = element_blank(), title = paste("Question V42a - Number of employees"), fill = element_blank())+
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  theme(legend.position= "bottom", 
        axis.text.x=element_blank(),
        axis.text.y=element_blank(), 
        axis.ticks=element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank())

non_response <- df_trial %>% 
 dplyr::filter(!!parse_quo(vr, env = caller_env()) == "0") %>%
  nrow()
non_res_frq <- round(non_response/nrow(df_trial)*100)

#dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
#ungroup() %>% 
# add_row(V1 = "No information", Q_lab = "No information Rate",  Count = non_response, tot = Count, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>% 

df_trial %>% 
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
  dplyr::group_by(V1) %>% 
  dplyr::mutate(tot = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(V1, Q_lab) %>% 
  dplyr::summarise(Count = n(), tot = unique(tot),freq = round(Count/tot,3)*100, Frequency = paste0(freq, "%")) %>%
  ungroup() %>% 
  add_row(V1 = "No information", Q_lab = "No information Rate",  Count = non_response, tot = Count, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>% 
  dplyr::select(Group = V1, "Number of employees" = Q_lab, Count, Percentage = Frequency) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V42a(Number of employees)_by_gr_entrev", ".csv")) %>%  
  flextable(., cwidth = 2) %>% 
  set_caption(., caption = "Frequency by Group")


df_trial %>%
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
  dplyr::group_by(Q_lab) %>% 
  dplyr::summarise(Count = n(), freq = round(Count/nrow(.),3)*100, Frequency = paste0(freq, "%")) %>% 
  ungroup() %>% 
  add_row(Q_lab = "No information Rate",  Count = non_response, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>% 
  dplyr::select("Number of employees" = Q_lab, Count, Percentage = Frequency ) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V42a(Number of employees)_entrev", ".csv")) %>%
  flextable(., cwidth = 2) 

```

\pagebreak

## Question V42b - Year of foundation

```{r v42b,echo=FALSE,warning=FALSE,fig.width=11, fig.height=8, cache = F}


vr <- "V42b"
df_trial <- new_data$orgs_atributos %>% 
  dplyr::select(ID, Nome, V1, !!vr) %>% 
  tidyr::drop_na() %>% 
  dplyr::mutate(Q_lab = case_when(
    !!parse_quo(vr, env = caller_env()) == 0  ~"No information",
    !!parse_quo(vr, env = caller_env()) == 1 	~"2013 to 2018",
    !!parse_quo(vr, env = caller_env())	== 2  ~"2000 to 2012",
    !!parse_quo(vr, env = caller_env()) == 3	~"1990 to 1999" ,
    !!parse_quo(vr, env = caller_env()) == 4	~"1980 to 1989" ,
    !!parse_quo(vr, env = caller_env()) == 5	~"1979 to 1900" ,
    !!parse_quo(vr, env = caller_env()) == 6	~"Before 1900" ,
    TRUE                ~"Not avaliale"
  )) %>% 
  dplyr::filter(Q_lab != "Not avaliale") %>% 
  dplyr::filter(!Nome %in% c("Nenhuma", "Não se aplica"))

df_trial %>% 
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
  dplyr::group_by(V1) %>% 
  dplyr::mutate(tot = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(V1, Q_lab) %>% 
  dplyr::summarise(Count = n(), tot = unique(tot),freq = round(Count/tot,3)*100, Frequency = paste0(freq, "%")) %>% 
  ggplot(aes(x = reorder(Q_lab, freq), y = freq, fill = V1)) + 
  geom_bar(position = position_dodge2(preserve = "single"), stat = "identity")+
  coord_flip() + 
  scale_fill_manual(values = gr_colors$color) +
  geom_text(aes(label = Frequency),
                position = position_dodge(width  = 1), size = 3)+
  labs(x= "Year of foundation", y = "Frequency", title = paste("Question", vr, " Year of foundation, by group"), fill = "Groups")+
  scale_y_continuous(limits=c(0,101), breaks= seq(0,101, by=10)) + 
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  theme(legend.position= "right")
 

non_response <- df_trial %>% 
 dplyr::filter(!!parse_quo(vr, env = caller_env()) == "0") %>%
  nrow()
non_res_frq <- round(non_response/nrow(df_trial)*100)

#dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
#ungroup() %>% 
# add_row(V1 = "No information", Q_lab = "No information Rate",  Count = non_response, tot = Count, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>% 

df_trial %>% 
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
  dplyr::group_by(V1) %>% 
  dplyr::mutate(tot = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(V1, Q_lab) %>% 
  dplyr::summarise(Count = n(), tot = unique(tot),freq = round(Count/tot,3)*100, Frequency = paste0(freq, "%")) %>% 
  ungroup() %>% 
  dplyr::select(Groups = V1, "Year of foundation" = Q_lab, Count, Frequency) %>% 
  add_row(Groups = "No information",    "Year of foundation" = "No information Rate",  Count = non_response,  Frequency = paste0(non_res_frq,"%") ) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V42b(Year of foundation)", ".csv")) %>%
  flextable(.) 
  

```

### Soporte de interpretación

El 40% de las empresas que conforman el grupo A2 fundaron su empresa entre los años 2000 y 2012, el otro 40% fundó su empresa en los años 1900 y 1979, el 20% restantes entre 1990 y 1999.

\pagebreak

## Question V42b - Year of foundation (Interviewed)

```{r v42b_entrev,echo=FALSE,warning=FALSE,fig.width=11, fig.height=8, cache = F}


vr <- "V42b"
df_trial <- new_data$orgs_atributos %>% 
  dplyr::select(ID, Nome, V1, !!vr) %>% 
  tidyr::drop_na() %>% 
  dplyr::mutate(Q_lab = case_when(
    !!parse_quo(vr, env = caller_env()) == 0  ~"No information",
    !!parse_quo(vr, env = caller_env()) == 1 	~"2013 to 2018",
    !!parse_quo(vr, env = caller_env())	== 2  ~"2000 to 2012",
    !!parse_quo(vr, env = caller_env()) == 3	~"1990 to 1999" ,
    !!parse_quo(vr, env = caller_env()) == 4	~"1980 to 1989" ,
    !!parse_quo(vr, env = caller_env()) == 5	~"1979 to 1900" ,
    !!parse_quo(vr, env = caller_env()) == 6	~"Before 1900" ,
    TRUE                ~"Not avaliale"
  )) %>% 
  dplyr::filter(Q_lab != "Not avaliale") %>% 
  dplyr::filter(!Nome %in% c("Nenhuma", "Não se aplica"))

df_trial <-df_trial %>% 
  dplyr::left_join(., groups %>%  dplyr::select(ID, Rodada_2019), by = c("ID" = "ID")) %>% 
  dplyr::filter(Rodada_2019 == "1") %>% 
  dplyr::select(-Rodada_2019)

df_trial %>% 
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
  dplyr::group_by(V1) %>% 
  dplyr::mutate(tot = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(V1, Q_lab) %>% 
  dplyr::summarise(Count = n(), tot = unique(tot),freq = round(Count/tot,3)*100, Frequency = paste0(freq, "%")) %>% 
  ggplot(aes(x = reorder(Q_lab, freq), y = freq, fill = V1)) + 
  geom_bar(position = position_dodge2(preserve = "single"), stat = "identity")+
  coord_flip() + 
  scale_fill_manual(values = gr_colors$color) +
  geom_text(aes(label = Frequency),
                position = position_dodge(width  = 1), size = 3)+
  labs(x= "Year of foundation", y = "Frequency", title = paste("Question", vr, " Year of foundation, by group"), fill = "Groups")+
  scale_y_continuous(limits=c(0,101), breaks= seq(0,101, by=10)) + 
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  theme(legend.position= "right")
 

non_response <- df_trial %>% 
 dplyr::filter(!!parse_quo(vr, env = caller_env()) == "0") %>%
  nrow()
non_res_frq <- round(non_response/nrow(df_trial)*100)

#dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
#ungroup() %>% 
# add_row(V1 = "No information", Q_lab = "No information Rate",  Count = non_response, tot = Count, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>% 


df_trial %>% 
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
  dplyr::group_by(V1) %>% 
  dplyr::mutate(tot = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(V1, Q_lab) %>% 
  dplyr::summarise(Count = n(), tot = unique(tot),freq = round(Count/tot,3)*100, Frequency = paste0(freq, "%")) %>% 
  ungroup() %>% 
  dplyr::select(Groups = V1, "Year of foundation" = Q_lab, Count, Frequency) %>% 
 add_row(Groups = "No information",    "Year of foundation" = "No information Rate",  Count = non_response,  Frequency = paste0(non_res_frq,"%") ) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V42b(Year of foundation)_by_gr_entrev", ".csv")) %>%
  flextable(.) 
  

```


## Question V42b time-serie

```{r v42b_tms,echo=FALSE,warning=FALSE,fig.width=11, fig.height=8, cache = F}

vr <- "V42b"
df_trial <- new_data$orgs_atributos %>% 
  dplyr::select(ID, Nome, V1, !!vr) %>% 
  tidyr::drop_na() %>% 
  dplyr::mutate(Q_lab = case_when(
   !!parse_quo(vr, env = caller_env()) == 0  ~"No information",
   !!parse_quo(vr, env = caller_env()) == 1 	~"2013 to 2018",
   !!parse_quo(vr, env = caller_env())	== 2  ~"2000 to 2012",
   !!parse_quo(vr, env = caller_env()) == 3	~"1990 to 1999" ,
   !!parse_quo(vr, env = caller_env()) == 4	~"1980 to 1989" ,
   !!parse_quo(vr, env = caller_env()) == 5	~"1979 to 1900" ,
   !!parse_quo(vr, env = caller_env()) == 6	~"Before 1900" ,
    TRUE                ~"Not avaliale"
  )) %>% 
  dplyr::filter(Q_lab != "Not avaliale") %>% 
  dplyr::filter(!Nome %in% c("Nenhuma", "Não se aplica"))

df_trial %>% 
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
  dplyr::group_by( Q_lab) %>% 
  dplyr::summarise(Count = n()) %>%
  dplyr::mutate(freq = round(Count/sum(Count),3)*100, Frequency  = paste0(freq, "%")) %>% 
  dplyr::filter(Q_lab != "No information") %>% 
  dplyr::mutate(var = "All") %>% 
  ggplot(aes(x = Q_lab, y = freq)) + 
  geom_line(aes(group = 1), size=1, color="steelblue")+
  geom_point()+
  geom_text(aes(label = Frequency),
                position = position_stack(vjust = 1.2), size = 3)+
  labs(x= "Year of foundation", y = "Frequency", title = paste("Question", vr, "Year of foundation"), fill = "Groups")+
  scale_y_continuous(limits=c(0,40), breaks= seq(0,40, by=5)) + 
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  theme(legend.position= "right")


non_response <- df_trial %>% 
 dplyr::filter(!!parse_quo(vr, env = caller_env()) == "0") %>%
 nrow()
non_res_frq <- round(non_response/nrow(df_trial)*100)

#dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
#ungroup() %>% 
# add_row(V1 = "No information", Q_lab = "No information Rate",  Count = non_response, tot = Count, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>% 
 

df_trial %>% 
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
  dplyr::group_by( Q_lab) %>% 
  dplyr::summarise(Count = n()) %>%
  dplyr::mutate(freq = round(Count/sum(Count),3)*100, Frequency  = paste0(freq, "%")) %>%
  ungroup() %>%
  add_row( Q_lab = "No information Rate",  Count = non_response,  freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>% 
  dplyr::select("Year of foundationo" = Q_lab, Count, Frequency) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V42b(Year of foundation)_entrev", ".csv")) %>% 
  flextable(.) 
  

```

### Soporte de interpretación

Este groupsáfico muestra el porcentaje de empresas que fueron fundadas en cada intervalo de tiempo. El 3.6% de los miembros de la PPA fundaron su empresa antes del año 1900. Entre 1979 y 1900 se fundó el 9.6% de las empresas meinbro de la PPA. El intervalo de tiempo en el cual se fundaron la mayor cantidad de empresas fue entre el 2000 y el 2012.


\pagebreak

## Question V42c - Number of countries where present

```{r v42c,echo=FALSE,warning=FALSE,fig.width=11, fig.height=8, cache = F, dpi = 200}


vr <- "V42c"
df_trial <- new_data$orgs_atributos %>% 
  dplyr::select(ID, Nome, V1, !!vr) %>% 
  tidyr::drop_na() %>% 
  dplyr::mutate(Q_lab = case_when(
    !!parse_quo(vr, env = caller_env()) == 0  ~"No information",
    !!parse_quo(vr, env = caller_env()) == 1 	~"2 to 10",
    !!parse_quo(vr, env = caller_env())	== 2  ~"11 to 50",
    !!parse_quo(vr, env = caller_env()) == 3	~"51 a 100" ,
    !!parse_quo(vr, env = caller_env()) == 4	~"More than 101" ,
    !!parse_quo(vr, env = caller_env()) == 5	~"Only national presence" ,
    TRUE                ~"Not avaliable"
  )) %>% 
  dplyr::filter(Q_lab != "Not avaliable") %>% 
  dplyr::filter(!Nome %in% c("Nenhuma", "Não se aplica"))

  
df_trial %>% 
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>%
  dplyr::group_by(V1) %>% 
  dplyr::mutate(tot = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(V1, Q_lab) %>% 
  dplyr::summarise(Count = n(), tot = unique(tot),freq = round(Count/tot,3)*100, Frequency = paste0(freq, "%")) %>% 
  ggplot(aes(x = 2, y = freq, fill = factor(Q_lab)))+
  geom_bar(stat = "identity", width = 1, color = "white")+
  coord_polar("y", start= 0) +
  facet_wrap(~V1)+
  scale_fill_manual(values = c("#d8b365",
"#377eb8",
"#4daf4a",
"#e9a3c9",
"#ff7f00",
"#5ab4ac",
"#bdbdbd"))+ #c("#CD534CFF", "#0073C2FF", "#EFC000FF",  )
  geom_text(aes(label = Frequency),
            position = position_stack(vjust  = 0.5), size = 4)+
  xlim(0.5, 2.5)+
  theme_bw()+
  labs(x= element_blank(), y = element_blank(), title = paste("Question V42c - Number of countries where present"), fill = element_blank())+
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  theme(legend.position= "bottom", 
        axis.text.x=element_blank(),
        axis.text.y=element_blank(), 
        axis.ticks=element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank())

non_response <- df_trial %>% 
 dplyr::filter(!!parse_quo(vr, env = caller_env()) == "0") %>%
 nrow()
non_res_frq <- round(non_response/nrow(df_trial)*100)

#dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
#ungroup() %>% 
# add_row(V1 = "No information", Q_lab = "No information Rate",  Count = non_response, tot = Count, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>% 

df_trial %>% 
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>%
  dplyr::group_by(V1) %>% 
  dplyr::mutate(tot = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(V1, Q_lab) %>% 
  dplyr::summarise(Count = n(), tot = unique(tot),freq = round(Count/tot,3)*100, Frequency = paste0(freq, "%")) %>% 
  ungroup() %>%
  add_row(V1 = "No information", Q_lab = "No information Rate",  Count = non_response, tot = Count, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>% 
  dplyr::select(Group = V1, "Number of countries where present" = Q_lab, Count, Percentage = Frequency) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V42(Number of countries where present)c_by_gr", ".csv")) %>% 
  flextable(., cwidth = 2) %>% 
  set_caption(., caption = "Frequency by Group")


df_trial %>%
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>%
  dplyr::group_by(Q_lab) %>% 
  dplyr::summarise(Count = n(), freq = round(Count/nrow(.),3)*100, Frequency = paste0(freq, "%")) %>%
   ungroup() %>%
  add_row( Q_lab = "No information Rate",  Count = non_response, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>% 
  dplyr::select("Number of countries where present" = Q_lab, Count,Percentage = Frequency ) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V42c(Number of countries where present)", ".csv")) %>% 
  flextable(., cwidth = 2) %>% 
  set_caption(., caption = "Frequency by category")

```

### Soporte de interpretación

Estos graficos muestran los porcentajes de la cantidad de paises en los que los miembros de la PPA actúan, discrimiados por el grupo al que pertenecen. En el grupo A2 el 60% de los miebros de la PPA que conforman este grupo respondieron Nao se aplica, por otro lado un 20% actua en mas de 11 paises, mientras que, el 20% restante actuan en mas de 51 paises.

En la tabla "Frequency by category" estan los porcentajes de respuesta por cada categoría, el 6% o 6 de cada 100 empresas actuan en menos de 10 paises, el 7.2% de las empresas miembros de la PPA actúan entre 11 u 50 paises. Es importante notar que el 67.5%  o 6 de cada 10 empresas responden Não se aplica.


\pagebreak

## Question V42c - Number of countries where present(Interviewed)

```{r v42c_entrev,echo=FALSE,warning=FALSE,fig.width=11, fig.height=8, cache = F, dpi = 200}


vr <- "V42c"
df_trial <- new_data$orgs_atributos %>% 
  dplyr::select(ID, Nome, V1, !!vr) %>% 
  tidyr::drop_na() %>% 
  dplyr::mutate(Q_lab = case_when(
    !!parse_quo(vr, env = caller_env()) == 0  ~"No information",
    !!parse_quo(vr, env = caller_env()) == 1 	~"2 to 10",
    !!parse_quo(vr, env = caller_env())	== 2  ~"11 to 50",
    !!parse_quo(vr, env = caller_env()) == 3	~"51 a 100" ,
    !!parse_quo(vr, env = caller_env()) == 4	~"More than 101" ,
    !!parse_quo(vr, env = caller_env()) == 5	~"Only national presence" ,
    TRUE                ~"Not avaliable"
  )) %>% 
  dplyr::filter(Q_lab != "Not avaliable") %>% 
  dplyr::filter(!Nome %in% c("Nenhuma", "Não se aplica"))

df_trial <-df_trial %>% 
  dplyr::left_join(., groups %>%  dplyr::select(ID, Rodada_2019), by = c("ID" = "ID")) %>% 
  dplyr::filter(Rodada_2019 == "1") %>% 
  dplyr::select(-Rodada_2019) 
 
df_trial %>% 
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>%
  dplyr::group_by(V1) %>% 
  dplyr::mutate(tot = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(V1, Q_lab) %>% 
  dplyr::summarise(Count = n(), tot = unique(tot),freq = round(Count/tot,3)*100, Frequency = paste0(freq, "%")) %>% 
  ggplot(aes(x = 2, y = freq, fill = factor(Q_lab)))+
  geom_bar(stat = "identity", width = 1, color = "white")+
  coord_polar("y", start= 0) +
  facet_wrap(~V1)+
  scale_fill_manual(values = c("#d8b365",
"#377eb8",
"#4daf4a",
"#e9a3c9",
"#ff7f00",
"#5ab4ac",
"#bdbdbd"))+ #c("#CD534CFF", "#0073C2FF", "#EFC000FF",  )
  geom_text(aes(label = Frequency),
            position = position_stack(vjust  = 0.5), size = 4)+
  xlim(0.5, 2.5)+
  theme_bw()+
  labs(x= element_blank(), y = element_blank(), title = paste("Question V42c - Number of countries where present"), fill = element_blank())+
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  theme(legend.position= "bottom", 
        axis.text.x=element_blank(),
        axis.text.y=element_blank(), 
        axis.ticks=element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank())

non_response <- df_trial %>% 
 dplyr::filter(!!parse_quo(vr, env = caller_env()) == "0") %>%
 nrow()
non_res_frq <- round(non_response/nrow(df_trial)*100)

#dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
#ungroup() %>% 
# add_row(V1 = "No information", Q_lab = "No information Rate",  Count = non_response, tot = Count, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>% 

df_trial %>% 
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>%
  dplyr::group_by(V1) %>% 
  dplyr::mutate(tot = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(V1, Q_lab) %>% 
  dplyr::summarise(Count = n(), tot = unique(tot),freq = round(Count/tot,3)*100, Frequency = paste0(freq, "%")) %>% 
  ungroup() %>%
  add_row(V1 = "No information", Q_lab = "No information Rate",  Count = non_response, tot = Count, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>% 
  dplyr::select(Group = V1, "Number of countries where present" = Q_lab, Count, Percentage = Frequency) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V42(Number of countries where present)c_by_gr_entrev", ".csv")) %>% 
  flextable(., cwidth = 2) %>% 
  set_caption(., caption = "Frequency by Group")


df_trial %>%
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>%
  dplyr::group_by(Q_lab) %>% 
  dplyr::summarise(Count = n(), freq = round(Count/nrow(.),3)*100, Frequency = paste0(freq, "%")) %>%
   ungroup() %>%
  add_row( Q_lab = "No information Rate",  Count = non_response, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>% 
  dplyr::select("Number of countries where present" = Q_lab,Percentage = Frequency ) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V42c(Number of countries where present)_entrev", ".csv")) %>% 
  flextable(., cwidth = 2) %>% 
  set_caption(., caption = "Frequency by category")

```


\pagebreak

## Question V42d - Number of Brazilian states where present

```{r v42d,echo=FALSE,warning=FALSE,fig.width=11, fig.height=8, cache = F, dpi = 200}


vr <- "V42d"
df_trial <- new_data$orgs_atributos %>% 
  dplyr::select(ID, Nome, V1, !!vr) %>% 
  tidyr::drop_na() %>% 
  dplyr::mutate(Q_lab = case_when(
    !!parse_quo(vr, env = caller_env()) == 0  ~"No information",
    !!parse_quo(vr, env = caller_env()) == 1 	~"2 to 5",
    !!parse_quo(vr, env = caller_env())	== 2  ~"6 to 10",
    !!parse_quo(vr, env = caller_env()) == 3	~"11 to 20" ,
    !!parse_quo(vr, env = caller_env()) == 4	~"21 or more" ,
    !!parse_quo(vr, env = caller_env()) == 5	~"Does not apply" ,
    TRUE                ~"Not avaliable"
  )) %>% 
  dplyr::filter(Q_lab != "Not avaliable") %>% 
  dplyr::filter(!Nome %in% c("Nenhuma", "Não se aplica"))

  
df_trial %>%
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
  dplyr::group_by(V1) %>% 
  dplyr::mutate(tot = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(V1, Q_lab) %>% 
  dplyr::summarise(Count = n(), tot = unique(tot),freq = round(Count/tot,3)*100, Frequency = paste0(freq, "%")) %>% 
  ggplot(aes(x = 2, y = freq, fill = factor(Q_lab)))+
  geom_bar(stat = "identity", width = 1, color = "white")+
  coord_polar("y", start= 0) +
  facet_wrap(~V1)+
  scale_fill_manual(values = c("#d8b365",
"#377eb8",
"#4daf4a",
"#e9a3c9",
"#ff7f00",
"#5ab4ac",
"#bdbdbd"))+ #c("#CD534CFF", "#0073C2FF", "#EFC000FF",  )
  geom_text(aes(label = Frequency),
            position = position_stack(vjust  = 0.5), size = 4)+
  xlim(0.5, 2.5)+
  theme_bw()+
  labs(x= element_blank(), y = element_blank(), title = paste("Question V42d - Number of Brazilian states where present"), fill = element_blank())+
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  theme(legend.position= "bottom", 
        axis.text.x=element_blank(),
        axis.text.y=element_blank(), 
        axis.ticks=element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank())

non_response <- df_trial %>% 
 dplyr::filter(!!parse_quo(vr, env = caller_env()) == "0") %>%
 nrow()
non_res_frq <- round(non_response/nrow(df_trial)*100)

#dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
#ungroup() %>% 
# add_row(V1 = "No information", Q_lab = "No information Rate",  Count = non_response, tot = Count, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>% 

df_trial %>%
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
  dplyr::group_by(V1) %>% 
  dplyr::mutate(tot = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(V1, Q_lab) %>% 
  dplyr::summarise(Count = n(), tot = unique(tot),freq = round(Count/tot,3)*100, Frequency = paste0(freq, "%")) %>%
  ungroup() %>% 
  add_row(V1 = "No information", Q_lab = "No information Rate",  Count = non_response, tot = Count, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>% 
  dplyr::select(Group = V1, "Number of Brazilian states where present" = Q_lab, Count, Percentage = Frequency) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V42d(Number of Brazilian states where present)_br_gr", ".csv")) %>% 
  flextable(., cwidth = 2) %>% 
  set_caption(., caption = "Frequency by Group")


df_trial %>% 
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
  dplyr::group_by(Q_lab) %>% 
  dplyr::summarise(Count = n(), freq = round(Count/nrow(.),3)*100, Frequency = paste0(freq, "%")) %>% 
  dplyr::select("Number of Brazilian states where present" = Q_lab,Percentage = Frequency ) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V42d(Number of Brazilian states where present)", ".csv")) %>% 
  flextable(., cwidth = 2) %>% 
  set_caption(., caption = "Frequency by category")

```

\pagebreak

## Question V42d - Number of Brazilian states where present (Interviewed)

```{r v42d_entrev,echo=FALSE,warning=FALSE,fig.width=11, fig.height=8, cache = F, dpi = 200}

vr <- "V42d"
df_trial <- new_data$orgs_atributos %>% 
  dplyr::select(ID, Nome, V1, !!vr) %>% 
  tidyr::drop_na() %>% 
  dplyr::mutate(Q_lab = case_when(
    !!parse_quo(vr, env = caller_env()) == 0  ~"No information",
    !!parse_quo(vr, env = caller_env()) == 1 	~"2 to 5",
    !!parse_quo(vr, env = caller_env())	== 2  ~"6 to 10",
    !!parse_quo(vr, env = caller_env()) == 3	~"11 to 20" ,
    !!parse_quo(vr, env = caller_env()) == 4	~"21 or more" ,
    !!parse_quo(vr, env = caller_env()) == 5	~"Does not apply" ,
    TRUE                ~"Not avaliable"
  )) %>% 
  dplyr::filter(Q_lab != "Not avaliable") %>% 
  dplyr::filter(!Nome %in% c("Nenhuma", "Não se aplica"))

df_trial <-df_trial %>% 
  dplyr::left_join(., groups %>%  dplyr::select(ID, Rodada_2019), by = c("ID" = "ID")) %>% 
  dplyr::filter(Rodada_2019 == "1") %>% 
  dplyr::select(-Rodada_2019)
  
df_trial %>%
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
  dplyr::group_by(V1) %>% 
  dplyr::mutate(tot = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(V1, Q_lab) %>% 
  dplyr::summarise(Count = n(), tot = unique(tot),freq = round(Count/tot,3)*100, Frequency = paste0(freq, "%")) %>% 
  ggplot(aes(x = 2, y = freq, fill = factor(Q_lab)))+
  geom_bar(stat = "identity", width = 1, color = "white")+
  coord_polar("y", start= 0) +
  facet_wrap(~V1)+
  scale_fill_manual(values = c("#d8b365",
"#377eb8",
"#4daf4a",
"#e9a3c9",
"#ff7f00",
"#5ab4ac",
"#bdbdbd"))+ #c("#CD534CFF", "#0073C2FF", "#EFC000FF",  )
  geom_text(aes(label = Frequency),
            position = position_stack(vjust  = 0.5), size = 4)+
  xlim(0.5, 2.5)+
  theme_bw()+
  labs(x= element_blank(), y = element_blank(), title = paste("Question V42d - Number of Brazilian states where present"), fill = element_blank())+
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  theme(legend.position= "bottom", 
        axis.text.x=element_blank(),
        axis.text.y=element_blank(), 
        axis.ticks=element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank())

non_response <- df_trial %>% 
 dplyr::filter(!!parse_quo(vr, env = caller_env()) == "0") %>%
 nrow()
non_res_frq <- round(non_response/nrow(df_trial)*100)

#dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
#ungroup() %>% 
# add_row(V1 = "No information", Q_lab = "No information Rate",  Count = non_response, tot = Count, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>% 

df_trial %>%
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
  dplyr::group_by(V1) %>% 
  dplyr::mutate(tot = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(V1, Q_lab) %>% 
  dplyr::summarise(Count = n(), tot = unique(tot),freq = round(Count/tot,3)*100, Frequency = paste0(freq, "%")) %>%
  ungroup() %>% 
  add_row(V1 = "No information", Q_lab = "No information Rate",  Count = non_response, tot = Count, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>% 
  dplyr::select(Group = V1, "Number of Brazilian states where present" = Q_lab, Count, Percentage = Frequency) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V42d(Number of Brazilian states where present)_br_gr_entrev", ".csv")) %>% 
  flextable(., cwidth = 2) %>% 
  set_caption(., caption = "Frequency by Group")


df_trial %>% 
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
  dplyr::group_by(Q_lab) %>% 
  dplyr::summarise(Count = n(), freq = round(Count/nrow(.),3)*100, Frequency = paste0(freq, "%")) %>% 
  ungroup() %>% 
  add_row( Q_lab = "No information Rate",  Count = non_response, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>%
  dplyr::select("Number of Brazilian states where present" = Q_lab,Percentage = Frequency ) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V42d(Number of Brazilian states where present)_entrev", ".csv")) %>% 
  flextable(., cwidth = 2) %>% 
  set_caption(., caption = "Frequency by category")

```


\pagebreak

## Question V43 - Territorial scope

```{r v43,echo=FALSE,warning=FALSE,fig.width=11, fig.height=8, cache = F}


vr <- paste0("V43_", 0:6)
df_trial <- new_data$orgs_atributos %>% 
  dplyr::select(ID, Nome, V1, !!vr) %>% 
  tidyr::drop_na() %>% 
  pivot_longer(cols = !!vr) %>% 
  dplyr::mutate(Q_lab = case_when(
    name == vr[1]       ~"No information",
    name == vr[2] 	    ~"Local",
    name == vr[3]	      ~"Region of a single state",
    name == vr[4] 	    ~"State",
    name == vr[5] 	    ~"More than one Amazonian state",
    name == vr[6] 	    ~"National",
    name == vr[7] 	    ~"International",
    TRUE                ~"Not avaliable"
  )) %>% 
  dplyr::filter(Q_lab != "Not avaliable") 
  

tots <- new_data$orgs_atributos %>% 
  dplyr::filter(!!parse_quo(vr[1], env = caller_env()) != "1") %>% 
  dplyr::select(ID, Nome, V1, !!vr) %>% 
  tidyr::drop_na() %>% 
  group_by(V1) %>% 
  tally()

# df_trial %>% 
#   group_by( V1, Q_lab) %>% 
#   dplyr::summarise( Count = sum(as.numeric(value))) %>%
#   ungroup %>% 
#   dplyr::left_join(., tots , by ="V1") %>% 
#   dplyr::mutate(freq = round(Count/n,3), n = NULL) %>%
#   pivot_wider(id_cols = V1, names_from = Q_lab, values_from = freq) %>%
#   ggradar(., group.colours  = c("olivedrab3", "tomato", "gold"),group.line.width = 1,  group.point.size = 3)

non_response <- df_trial %>% 
 dplyr::filter(name == vr[1], value == "1") %>%
 nrow()
non_res_frq <- round(non_response/length(unique(df_trial$Nome))*100)

#dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
#ungroup() %>% 
# add_row(V1 = "No information", Q_lab = "No information Rate",  Count = non_response, tot = Count, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>% 

  
    
df_trial %>% 
  dplyr::filter(name != vr[1]) %>% 
  group_by( V1, Q_lab) %>% 
  dplyr::summarise( Count = sum(as.numeric(value))) %>%
  ungroup %>% 
  dplyr::left_join(., tots , by ="V1") %>% 
  dplyr::mutate(freq = round(Count/n,3)*100, Frequency = paste0(freq, "%")) %>% 
  dplyr::filter(Count != 0) %>% 
  ggplot(aes(x = reorder(Q_lab, freq), y = freq, fill = V1)) +
  geom_bar(position = position_dodge2(preserve = "single", width = 1), stat = "identity", width = 0.8)+
  coord_flip() +
  scale_fill_manual(values = gr_colors$color) +
  geom_text(aes(label = Frequency),
                position = position_dodge(width  = 0.8), size = 3)+
  labs(x= element_blank(), y = "Frequency", title = paste("Question V43 - ", "Territorial scope"), fill = "Groups")+
  scale_y_continuous(limits=c(0,101), breaks= seq(0,101, by=10)) +
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  theme(legend.position= "right")
  
df_trial %>%
  dplyr::filter(name != vr[1]) %>% 
  group_by( V1, Q_lab) %>% 
  dplyr::summarise( Count = sum(as.numeric(value))) %>%
  ungroup %>% 
  dplyr::left_join(., tots , by ="V1") %>% 
  dplyr::mutate(freq = round(Count/n,3)*100, Frequency = paste0(freq, "%")) %>% 
  dplyr::filter(Count != 0) %>% 
  ungroup() %>% 
   add_row(V1 = "No information", Q_lab = "No information Rate",  Count = non_response,n = Count, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>% 
  dplyr::select(Group = V1, "Territorial scope" = Q_lab, Count, Frequency) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V43(Territorial scope)_by_gr", ".csv")) %>% 
  flextable(.) %>% 
  set_caption(., caption = "Frequency Territorial scope")


```

### Soporte de interpretación

Este groupsáfico muestra los porcentajes por cada grupo de los sectores económicos a los cuales pertenecen los miembros de la PPA. El 41.5% de los miembros de la PPA que pertenecen al grupo B tiene como sector de actuación las "Atividades profissionais, científicas e técnicas", en el grupo A2 el 40% de sus miembros se desenvuelve en este mismo sector, así como el 48.6% de los miembros de la PPA pertenecientes al grupo A. Notese que los porcentajes no suman 100% debido a que estas categorías son de multiple respuesta, es decir, una empresa puede tener mas de un sector de actuación. Por lo anterior, del 41.5% de las empresas pertenecientes al grupo B que actúan en el sector de "Atividades profissionais, científicas e técnicas" hay un 58.5% que no actúa.

\pagebreak

## Question V43 - Territorial scope (Interviewed)

```{r v43_entrev,echo=FALSE,warning=FALSE,fig.width=11, fig.height=8, cache = F}


vr <- paste0("V43_", 0:6)
df_trial <- new_data$orgs_atributos %>% 
  dplyr::select(ID, Nome, V1, !!vr) %>% 
  tidyr::drop_na() %>% 
  pivot_longer(cols = !!vr) %>% 
  dplyr::mutate(Q_lab = case_when(
    name == vr[1]       ~"No information",
    name == vr[2] 	    ~"Local",
    name == vr[3]	      ~"Region of a single state",
    name == vr[4] 	    ~"State",
    name == vr[5] 	    ~"More than one Amazonian state",
    name == vr[6] 	    ~"National",
    name == vr[7] 	    ~"International",
    TRUE                ~"Not avaliable"
  )) %>% 
  dplyr::filter(Q_lab != "Not avaliable") 

df_trial <-df_trial %>% 
  dplyr::left_join(., groups %>%  dplyr::select(ID, Rodada_2019), by = c("ID" = "ID")) %>% 
  dplyr::filter(Rodada_2019 == "1") %>% 
  dplyr::select(-Rodada_2019)  

tots <- new_data$orgs_atributos %>% 
  dplyr::filter(!!parse_quo(vr[1], env = caller_env()) != "1") %>% 
  dplyr::select(ID, Nome, V1, !!vr) %>%
  dplyr::left_join(., groups %>%  dplyr::select(ID, Rodada_2019), by = c("ID" = "ID")) %>% 
  dplyr::filter(Rodada_2019 == "1") %>% 
  dplyr::select(-Rodada_2019) %>% 
  tidyr::drop_na() %>% 
  group_by(V1) %>% 
  tally()

# df_trial %>% 
#   group_by( V1, Q_lab) %>% 
#   dplyr::summarise( Count = sum(as.numeric(value))) %>%
#   ungroup %>% 
#   dplyr::left_join(., tots , by ="V1") %>% 
#   dplyr::mutate(freq = round(Count/n,3), n = NULL) %>%
#   pivot_wider(id_cols = V1, names_from = Q_lab, values_from = freq) %>%
#   ggradar(., group.colours  = c("olivedrab3", "tomato", "gold"),group.line.width = 1,  group.point.size = 3)

non_response <- df_trial %>% 
 dplyr::filter(name == vr[1], value == "1") %>%
 nrow()
non_res_frq <- round(non_response/length(unique(df_trial$Nome))*100)

#dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
#ungroup() %>% 
# add_row(V1 = "No information", Q_lab = "No information Rate",  Count = non_response, tot = Count, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>% 

  
    
df_trial %>% 
  dplyr::filter(name != vr[1]) %>% 
  group_by( V1, Q_lab) %>% 
  dplyr::summarise( Count = sum(as.numeric(value))) %>%
  ungroup %>% 
  dplyr::left_join(., tots , by ="V1") %>% 
  dplyr::mutate(freq = round(Count/n,3)*100, Frequency = paste0(freq, "%")) %>% 
  dplyr::filter(Count != 0) %>% 
  ggplot(aes(x = reorder(Q_lab, freq), y = freq, fill = V1)) +
  geom_bar(position = position_dodge2(preserve = "single", width = 1), stat = "identity", width = 0.8)+
  coord_flip() +
  scale_fill_manual(values = gr_colors$color) +
  geom_text(aes(label = Frequency),
                position = position_dodge(width  = 0.8), size = 3)+
  labs(x= element_blank(), y = "Frequency", title = paste("Question V43 - ", "Territorial scope"), fill = "Groups")+
  scale_y_continuous(limits=c(0,101), breaks= seq(0,101, by=10)) +
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  theme(legend.position= "right")
  
df_trial %>%
  dplyr::filter(name != vr[1]) %>% 
  group_by( V1, Q_lab) %>% 
  dplyr::summarise( Count = sum(as.numeric(value))) %>%
  ungroup %>% 
  dplyr::left_join(., tots , by ="V1") %>% 
  dplyr::mutate(freq = round(Count/n,3)*100, Frequency = paste0(freq, "%")) %>% 
  dplyr::filter(Count != 0) %>% 
  ungroup() %>% 
   add_row(V1 = "No information", Q_lab = "No information Rate",  Count = non_response,n = Count, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>% 
  dplyr::select(Group = V1, "Territorial scope" = Q_lab, Count, Frequency) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V43(Territorial scope)_by_gr", ".csv")) %>% 
  flextable(.) %>% 
  set_caption(., caption = "Frequency Territorial scope")


```



\pagebreak

## Question V44a - Type of territories where active

```{r v44a,echo=FALSE,warning=FALSE,fig.width=11, fig.height=8, cache = F}


vr <- paste0("V44a_", 0:5)
df_trial <- new_data$orgs_atributos %>% 
  dplyr::select(ID, Nome, V1, !!vr) %>% 
  tidyr::drop_na() %>% 
  pivot_longer(cols = !!vr) %>% 
  dplyr::mutate(Q_lab = case_when(
    name == vr[1]       ~"No information",
    name == vr[2] 	    ~"Large urban centers",
    name == vr[3]	      ~"Amazonian state seats (capital cities)",
    name == vr[4] 	    ~"Cities of the Amazon interior",
    name == vr[5] 	    ~"Tradicional communities and protected areas",
    name == vr[6] 	    ~"Não se aplica",
    TRUE                ~"Not avaliable"
  )) %>% 
  dplyr::filter(Q_lab != "not avalable") 
  

tots <- new_data$orgs_atributos %>% 
  dplyr::select(ID, Nome, V1, !!vr) %>% 
  tidyr::drop_na() %>% 
  group_by(V1) %>% 
  tally()

non_response <- df_trial %>% 
 dplyr::filter(name == vr[1], value == "1") %>%
 nrow()
non_res_frq <- round(non_response/length(unique(df_trial$Nome))*100)

#dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
#ungroup() %>% 
# add_row(V1 = "No information", Q_lab = "No information Rate",  Count = non_response, tot = Count, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>%


df_trial %>% 
  dplyr::filter(name != vr[1]) %>%
  group_by( V1, Q_lab) %>% 
  dplyr::summarise( Count = sum(as.numeric(value))) %>%
  ungroup %>% 
  dplyr::left_join(., tots , by ="V1") %>% 
  dplyr::mutate(freq = round(Count/n,3)*100, Frequency = paste0(freq, "%")) %>% 
  dplyr::filter(Count != 0) %>% 
  ggplot(aes(x = reorder(Q_lab, freq), y = freq, fill = V1)) +
  geom_bar(position = position_dodge2(preserve = "single", width = 1), stat = "identity", width = 0.8)+
  coord_flip() +
  scale_fill_manual(values = gr_colors$color) +
  geom_text(aes(label = Frequency),
                position = position_dodge(width  = 0.8), size = 3)+
  labs(x= element_blank(), y = "Frequency", title = paste("Question V44a - ", "Type of territories where active"), fill = "Groups")+
  scale_y_continuous(limits=c(0,101), breaks= seq(0,101, by=10)) +
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  theme(legend.position= "right")
  
df_trial %>% 
  group_by( V1, Q_lab) %>% 
  dplyr::summarise( Count = sum(as.numeric(value))) %>%
  ungroup %>% 
  dplyr::left_join(., tots , by ="V1") %>% 
  dplyr::mutate(freq = round(Count/n,3)*100, Frequency = paste0(freq, "%")) %>% 
  dplyr::filter(Count != 0) %>% 
  ungroup() %>%
  add_row(V1 = "No information", Q_lab = "No information Rate",  Count = non_response, n = Count, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>%
  dplyr::select(Group = V1, "Type of territories where active" = Q_lab, Count, Frequency) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V44a(Type of territories where active)", ".csv")) %>% 
  flextable(.) %>% 
  set_caption(., caption = "Frecuencies of Type of territories where active")

```

\pagebreak

## Question V44a - Type of territories where active (Interviewed)

```{r v44a_entrev,echo=FALSE,warning=FALSE,fig.width=11, fig.height=8, cache = F}


vr <- paste0("V44a_", 0:5)
df_trial <- new_data$orgs_atributos %>% 
  dplyr::select(ID, Nome, V1, !!vr) %>% 
  tidyr::drop_na() %>% 
  pivot_longer(cols = !!vr) %>% 
  dplyr::mutate(Q_lab = case_when(
    name == vr[1]       ~"No information",
    name == vr[2] 	    ~"Large urban centers",
    name == vr[3]	      ~"Amazonian state seats (capital cities)",
    name == vr[4] 	    ~"Cities of the Amazon interior",
    name == vr[5] 	    ~"Tradicional communities and protected areas",
    name == vr[6] 	    ~"Não se aplica",
    TRUE                ~"Not avaliable"
  )) %>% 
  dplyr::filter(Q_lab != "not avalable") 
  

df_trial <-df_trial %>% 
  dplyr::left_join(., groups %>%  dplyr::select(ID, Rodada_2019), by = c("ID" = "ID")) %>% 
  dplyr::filter(Rodada_2019 == "1") %>% 
  dplyr::select(-Rodada_2019)  

tots <- new_data$orgs_atributos %>% 
  dplyr::filter(!!parse_quo(vr[1], env = caller_env()) != "1") %>% 
  dplyr::select(ID, Nome, V1, !!vr) %>%
  dplyr::left_join(., groups %>%  dplyr::select(ID, Rodada_2019), by = c("ID" = "ID")) %>% 
  dplyr::filter(Rodada_2019 == "1") %>% 
  dplyr::select(-Rodada_2019) %>% 
  tidyr::drop_na() %>% 
  group_by(V1) %>% 
  tally()


non_response <- df_trial %>% 
 dplyr::filter(name == vr[1], value == "1") %>%
 nrow()
non_res_frq <- round(non_response/length(unique(df_trial$Nome))*100)

#dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
#ungroup() %>% 
# add_row(V1 = "No information", Q_lab = "No information Rate",  Count = non_response, tot = Count, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>%


df_trial %>% 
  dplyr::filter(name != vr[1]) %>%
  group_by( V1, Q_lab) %>% 
  dplyr::summarise( Count = sum(as.numeric(value))) %>%
  ungroup %>% 
  dplyr::left_join(., tots , by ="V1") %>% 
  dplyr::mutate(freq = round(Count/n,3)*100, Frequency = paste0(freq, "%")) %>% 
  dplyr::filter(Count != 0) %>% 
  ggplot(aes(x = reorder(Q_lab, freq), y = freq, fill = V1)) +
  geom_bar(position = position_dodge2(preserve = "single", width = 1), stat = "identity", width = 0.8)+
  coord_flip() +
  scale_fill_manual(values = gr_colors$color) +
  geom_text(aes(label = Frequency),
                position = position_dodge(width  = 0.8), size = 3)+
  labs(x= element_blank(), y = "Frequency", title = paste("Question V44a - ", "Type of territories where active"), fill = "Groups")+
  scale_y_continuous(limits=c(0,101), breaks= seq(0,101, by=10)) +
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  theme(legend.position= "right")
  
df_trial %>% 
  group_by( V1, Q_lab) %>% 
  dplyr::summarise( Count = sum(as.numeric(value))) %>%
  ungroup %>% 
  dplyr::left_join(., tots , by ="V1") %>% 
  dplyr::mutate(freq = round(Count/n,3)*100, Frequency = paste0(freq, "%")) %>% 
  dplyr::filter(Count != 0) %>% 
  ungroup() %>%
  add_row(V1 = "No information", Q_lab = "No information Rate",  Count = non_response, n = Count, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>%
  dplyr::select(Group = V1, "Type of territories where active" = Q_lab, Count, Frequency) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V44a(Type of territories where active)_by_gr_entrev", ".csv")) %>% 
  flextable(.) %>% 
  set_caption(., caption = "Frecuencies of Type of territories where active")

```

\pagebreak

## Question V44b - Number of localities where active

```{r  v44b,echo=FALSE,warning=FALSE,fig.width=11, fig.height=8, cache = F, dpi = 200}

vr <- "V44b"
df_trial <- new_data$orgs_atributos %>% 
  dplyr::select(ID, Nome, V1, !!vr) %>% 
  tidyr::drop_na() %>% 
  dplyr::mutate(Q_lab = case_when(
    !!parse_quo(vr, env = caller_env()) == 0  ~"No information",
    !!parse_quo(vr, env = caller_env()) == 1 	~"One locality",
    !!parse_quo(vr, env = caller_env())	== 2  ~"2 to 5",
    !!parse_quo(vr, env = caller_env()) == 3	~"6 and over" ,
    !!parse_quo(vr, env = caller_env()) == 4	~"Does not apply" ,
    TRUE                ~"Not avaliable"
  )) %>% 
  dplyr::filter(Q_lab != "Not avaliable") %>% 
  dplyr::filter(!Nome %in% c("Nenhuma", "Não se aplica"))

non_response <- df_trial %>% 
 dplyr::filter(!!parse_quo(vr, env = caller_env()) == "0") %>%
 nrow()
non_res_frq <- round(non_response/nrow(df_trial)*100)

#dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
#ungroup() %>% 
# add_row(V1 = "No information", Q_lab = "No information Rate",  Count = non_response, tot = Count, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>% 


  
df_trial %>% 
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>%
  dplyr::group_by(V1) %>% 
  dplyr::mutate(tot = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(V1, Q_lab) %>% 
  dplyr::summarise(Count = n(), tot = unique(tot),freq = round(Count/tot,3)*100, Frequency = paste0(freq, "%")) %>% 
  ggplot(aes(x = 2, y = freq, fill = factor(Q_lab)))+
  geom_bar(stat = "identity", width = 1, color = "white")+
  coord_polar("y", start= 0) +
  facet_wrap(~V1)+
  scale_fill_manual(values = c("#d8b365",
"#377eb8",
"#4daf4a",
"#e9a3c9",
"#ff7f00",
"#5ab4ac",
"#bdbdbd"))+ #c("#CD534CFF", "#0073C2FF", "#EFC000FF",  )
  geom_text(aes(label = Frequency),
            position = position_stack(vjust  = 0.5), size = 4)+
  xlim(0.5, 2.5)+
  theme_bw()+
  labs(x= element_blank(), y = element_blank(), title = paste("Question V44b - Number of localities where active"), fill = element_blank())+
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  theme(legend.position= "bottom", 
        axis.text.x=element_blank(),
        axis.text.y=element_blank(), 
        axis.ticks=element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank())

df_trial %>% 
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>%
  dplyr::group_by(V1) %>% 
  dplyr::mutate(tot = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(V1, Q_lab) %>% 
  dplyr::summarise(Count = n(), tot = unique(tot),freq = round(Count/tot,3)*100, Frequency = paste0(freq, "%")) %>% 
  ungroup() %>% 
  add_row(V1 = "No information", Q_lab = "No information Rate",  Count = non_response, tot = Count, freq = non_res_frq,Frequency =   paste0(non_res_frq,"%")) %>% 
  dplyr::select(Group = V1, "Number of localities where active" = Q_lab, Count, Percentage = Frequency) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V44b(Number of localities where active)_by_gr", ".csv")) %>% 
  flextable(., cwidth = 2) %>% 
  set_caption(., caption = "Frequency by Group")


df_trial %>%
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>%
  dplyr::group_by(Q_lab) %>% 
  dplyr::summarise(Count = n(), freq = round(Count/nrow(.),3)*100, Frequency = paste0(freq, "%")) %>% 
  ungroup() %>% 
  add_row( Q_lab = "No information Rate",  Count = non_response, freq = non_res_frq,Frequency =   paste0(non_res_frq,"%")) %>% 
  dplyr::select("Number of localities where active" = Q_lab,Percentage = Frequency ) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V44b(Number of localities where active)", ".csv")) %>% 
  flextable(., cwidth = 2) %>% 
  set_caption(., caption = "Frequency by category")

``` 


\pagebreak

## Question V44b - Number of localities where active (Interviewed)

```{r  v44b_entrev,echo=FALSE,warning=FALSE,fig.width=11, fig.height=8, cache = F, dpi = 200}

vr <- "V44b"
df_trial <- new_data$orgs_atributos %>% 
  dplyr::select(ID, Nome, V1, !!vr) %>% 
  tidyr::drop_na() %>% 
  dplyr::mutate(Q_lab = case_when(
    !!parse_quo(vr, env = caller_env()) == 0  ~"No information",
    !!parse_quo(vr, env = caller_env()) == 1 	~"One locality",
    !!parse_quo(vr, env = caller_env())	== 2  ~"2 to 5",
    !!parse_quo(vr, env = caller_env()) == 3	~"6 and over" ,
    !!parse_quo(vr, env = caller_env()) == 4	~"Does not apply" ,
    TRUE                ~"Not avaliable"
  )) %>% 
  dplyr::filter(Q_lab != "Not avaliable") %>% 
  dplyr::filter(!Nome %in% c("Nenhuma", "Não se aplica"))


df_trial <-df_trial %>% 
  dplyr::left_join(., groups %>%  dplyr::select(ID, Rodada_2019), by = c("ID" = "ID")) %>% 
  dplyr::filter(Rodada_2019 == "1") %>% 
  dplyr::select(-Rodada_2019)  


non_response <- df_trial %>% 
 dplyr::filter(!!parse_quo(vr, env = caller_env()) == "0") %>%
 nrow()
non_res_frq <- round(non_response/nrow(df_trial)*100)

#dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
#ungroup() %>% 
# add_row(V1 = "No information", Q_lab = "No information Rate",  Count = non_response, tot = Count, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>% 


  
df_trial %>% 
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>%
  dplyr::group_by(V1) %>% 
  dplyr::mutate(tot = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(V1, Q_lab) %>% 
  dplyr::summarise(Count = n(), tot = unique(tot),freq = round(Count/tot,3)*100, Frequency = paste0(freq, "%")) %>% 
  ggplot(aes(x = 2, y = freq, fill = factor(Q_lab)))+
  geom_bar(stat = "identity", width = 1, color = "white")+
  coord_polar("y", start= 0) +
  facet_wrap(~V1)+
  scale_fill_manual(values = c("#d8b365",
"#377eb8",
"#4daf4a",
"#e9a3c9",
"#ff7f00",
"#5ab4ac",
"#bdbdbd"))+ #c("#CD534CFF", "#0073C2FF", "#EFC000FF",  )
  geom_text(aes(label = Frequency),
            position = position_stack(vjust  = 0.5), size = 4)+
  xlim(0.5, 2.5)+
  theme_bw()+
  labs(x= element_blank(), y = element_blank(), title = paste("Question V44b - Number of localities where active"), fill = element_blank())+
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  theme(legend.position= "bottom", 
        axis.text.x=element_blank(),
        axis.text.y=element_blank(), 
        axis.ticks=element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank())

df_trial %>% 
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>%
  dplyr::group_by(V1) %>% 
  dplyr::mutate(tot = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(V1, Q_lab) %>% 
  dplyr::summarise(Count = n(), tot = unique(tot),freq = round(Count/tot,3)*100, Frequency = paste0(freq, "%")) %>% 
  ungroup() %>% 
  add_row(V1 = "No information", Q_lab = "No information Rate",  Count = non_response, tot = Count, freq = non_res_frq,Frequency =   paste0(non_res_frq,"%")) %>% 
  dplyr::select(Group = V1, "Number of localities where active" = Q_lab, Count, Percentage = Frequency) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V44b(Number of localities where active)_by_gr", ".csv")) %>% 
  flextable(., cwidth = 2) %>% 
  set_caption(., caption = "Frequency by Group")


df_trial %>%
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>%
  dplyr::group_by(Q_lab) %>% 
  dplyr::summarise(Count = n(), freq = round(Count/nrow(.),3)*100, Frequency = paste0(freq, "%")) %>% 
  ungroup() %>% 
  add_row( Q_lab = "No information Rate",  Count = non_response, freq = non_res_frq,Frequency =   paste0(non_res_frq,"%")) %>% 
  dplyr::select("Number of localities where active" = Q_lab,Percentage = Frequency ) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V44b(Number of localities where active)", ".csv")) %>% 
  flextable(., cwidth = 2) %>% 
  set_caption(., caption = "Frequency by category")

``` 


\pagebreak

## Question V45 - Social & Environmental Corporate Comitment

```{r v45,echo=FALSE,warning=FALSE,fig.width=11, fig.height=8, cache = F, dpi = 200}
 

vr <- "V45"
df_trial <- new_data$orgs_atributos %>% 
  dplyr::select(ID, Nome, V1, !!vr) %>% 
  tidyr::drop_na() %>% 
  dplyr::mutate(Q_lab = case_when(
    !!parse_quo(vr, env = caller_env()) == 0  ~"No information",
    !!parse_quo(vr, env = caller_env()) == 1 	~"Social responsibility",
    !!parse_quo(vr, env = caller_env())	== 2  ~"Sustainability",
    !!parse_quo(vr, env = caller_env()) == 3	~"Both" ,
    TRUE                ~"Not avaliable"
  )) %>% 
  dplyr::filter(Q_lab != "Not avaliable") %>% 
  dplyr::filter(!Nome %in% c("Nenhuma", "Não se aplica"))

non_response <- df_trial %>% 
 dplyr::filter(!!parse_quo(vr, env = caller_env()) == "0") %>%
 nrow()
non_res_frq <- round(non_response/nrow(df_trial)*100)

#dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
#ungroup() %>% 
# add_row(V1 = "No information", Q_lab = "No information Rate",  Count = non_response, tot = Count, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>% 


  
df_trial %>%
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
  dplyr::group_by(V1) %>% 
  dplyr::mutate(tot = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(V1, Q_lab) %>% 
  dplyr::summarise(Count = n(), tot = unique(tot),freq = round(Count/tot,3)*100, Frequency = paste0(freq, "%")) %>% 
  ggplot(aes(x = 2, y = freq, fill = factor(Q_lab)))+
  geom_bar(stat = "identity", width = 1, color = "white")+
  coord_polar("y", start= 0) +
  facet_wrap(~V1)+
  scale_fill_manual(values = c("#ff7f00",
"#377eb8",
"#4daf4a",
"#d8b365",
"#e9a3c9",
"#5ab4ac",
"#bdbdbd"))+ #c("#CD534CFF", "#0073C2FF", "#EFC000FF",  )
  geom_text(aes(label = Frequency),
            position = position_stack(vjust  = 0.5), size = 4)+
  xlim(0.5, 2.5)+
  theme_bw()+
  labs(x= element_blank(), y = element_blank(), title = paste("Question V45 - Social & Environmental Corporate Comitment"), fill = element_blank())+
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  theme(legend.position= "bottom", 
        axis.text.x=element_blank(),
        axis.text.y=element_blank(), 
        axis.ticks=element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank())

df_trial %>% 
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
  dplyr::group_by(V1) %>% 
  dplyr::mutate(tot = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(V1, Q_lab) %>% 
  dplyr::summarise(Count = n(), tot = unique(tot),freq = round(Count/tot,3)*100, Frequency = paste0(freq, "%")) %>% 
  ungroup() %>% 
  add_row(V1 = "No information", Q_lab = "No information Rate",  Count = non_response, tot = Count, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>% 
  dplyr::select(Group = V1, "Social & Environmental Corporate Comitment" = Q_lab, Count, Percentage = Frequency) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V45(Social & Environmental Corporate Comitment)_by_gr", ".csv")) %>%
  flextable(., cwidth = 2) %>% 
  set_caption(., caption = "Frequency by Group")


df_trial %>%
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
  dplyr::group_by(Q_lab) %>% 
  dplyr::summarise(Count = n(), freq = round(Count/nrow(.),3)*100, Frequency = paste0(freq, "%")) %>% 
  ungroup() %>% 
  add_row( Q_lab = "No information Rate",  Count = non_response, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>% 
  dplyr::select("Social & Environmental Corporate Comitment" = Q_lab,Percentage = Frequency ) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V45(Social & Environmental Corporate Comitment)", ".csv")) %>% 
  flextable(., cwidth = 2) %>% 
  set_caption(., caption = "Frequency by category")

```


\pagebreak

## Question V45 - Social & Environmental Corporate Comitment (Interviewed)

```{r v45_entrev,echo=FALSE,warning=FALSE,fig.width=11, fig.height=8, cache = F, dpi = 200}
 

vr <- "V45"
df_trial <- new_data$orgs_atributos %>% 
  dplyr::select(ID, Nome, V1, !!vr) %>% 
  tidyr::drop_na() %>% 
  dplyr::mutate(Q_lab = case_when(
    !!parse_quo(vr, env = caller_env()) == 0  ~"No information",
    !!parse_quo(vr, env = caller_env()) == 1 	~"Social responsibility",
    !!parse_quo(vr, env = caller_env())	== 2  ~"Sustainability",
    !!parse_quo(vr, env = caller_env()) == 3	~"Both" ,
    TRUE                ~"Not avaliable"
  )) %>% 
  dplyr::filter(Q_lab != "Not avaliable") %>% 
  dplyr::filter(!Nome %in% c("Nenhuma", "Não se aplica"))

df_trial <-df_trial %>% 
  dplyr::left_join(., groups %>%  dplyr::select(ID, Rodada_2019), by = c("ID" = "ID")) %>% 
  dplyr::filter(Rodada_2019 == "1") %>% 
  dplyr::select(-Rodada_2019)  


non_response <- df_trial %>% 
 dplyr::filter(!!parse_quo(vr, env = caller_env()) == "0") %>%
 nrow()
non_res_frq <- round(non_response/nrow(df_trial)*100)

#dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
#ungroup() %>% 
# add_row(V1 = "No information", Q_lab = "No information Rate",  Count = non_response, tot = Count, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>% 


  
df_trial %>%
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
  dplyr::group_by(V1) %>% 
  dplyr::mutate(tot = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(V1, Q_lab) %>% 
  dplyr::summarise(Count = n(), tot = unique(tot),freq = round(Count/tot,3)*100, Frequency = paste0(freq, "%")) %>% 
  ggplot(aes(x = 2, y = freq, fill = factor(Q_lab)))+
  geom_bar(stat = "identity", width = 1, color = "white")+
  coord_polar("y", start= 0) +
  facet_wrap(~V1)+
  scale_fill_manual(values = c("#ff7f00",
"#377eb8",
"#4daf4a",
"#d8b365",
"#e9a3c9",
"#5ab4ac",
"#bdbdbd"))+ #c("#CD534CFF", "#0073C2FF", "#EFC000FF",  )
  geom_text(aes(label = Frequency),
            position = position_stack(vjust  = 0.5), size = 4)+
  xlim(0.5, 2.5)+
  theme_bw()+
  labs(x= element_blank(), y = element_blank(), title = paste("Question V45 - Social & Environmental Corporate Comitment"), fill = element_blank())+
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  theme(legend.position= "bottom", 
        axis.text.x=element_blank(),
        axis.text.y=element_blank(), 
        axis.ticks=element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank())

df_trial %>% 
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
  dplyr::group_by(V1) %>% 
  dplyr::mutate(tot = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(V1, Q_lab) %>% 
  dplyr::summarise(Count = n(), tot = unique(tot),freq = round(Count/tot,3)*100, Frequency = paste0(freq, "%")) %>% 
  ungroup() %>% 
  add_row(V1 = "No information", Q_lab = "No information Rate",  Count = non_response, tot = Count, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>% 
  dplyr::select(Group = V1, "Social & Environmental Corporate Comitment" = Q_lab, Count, Percentage = Frequency) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V45(Social & Environmental Corporate Comitment)_by_gr_entrev", ".csv")) %>%
  flextable(., cwidth = 2) %>% 
  set_caption(., caption = "Frequency by Group")


df_trial %>%
  dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
  dplyr::group_by(Q_lab) %>% 
  dplyr::summarise(Count = n(), freq = round(Count/nrow(.),3)*100, Frequency = paste0(freq, "%")) %>% 
  ungroup() %>% 
  add_row( Q_lab = "No information Rate",  Count = non_response, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>% 
  dplyr::select("Social & Environmental Corporate Comitment" = Q_lab,Percentage = Frequency ) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V45(Social & Environmental Corporate Comitment)_entrev", ".csv")) %>% 
  flextable(., cwidth = 2) %>% 
  set_caption(., caption = "Frequency by category")

```


\pagebreak

# Informer sección

this section shows the results of the questions V10 to V14 in the **Informer** section.

\pagebreak

## Identificação – V10  Type of sector in organization



```{r v10,echo=FALSE,warning=FALSE,fig.width=8, fig.height=6, cache = TRUE}

v10 <- new_data$Informer %>%
  dplyr::mutate(ID = as.character(ID)) %>%
  dplyr::inner_join(., groups, by = c("ID" = "ID")) %>%
  dplyr::mutate(V10 = replace(V10, is.na(V10), "2"))%>%
  group_by(V1, V10) %>% 
  tally() %>% 
  dplyr::mutate( Q_lab = case_when(
    V10   ==  "0" ~	"Not explicitly related to sustainability",
    V10   ==  "1"	~ "Related to sustainability",
    V10   ==  "2"	~ "No response",
    TRUE ~ "Not avaliable"
  ) ) 



non_response <- v10 %>% 
  dplyr::filter(Q_lab == "No response") %>% 
  pull(n) %>% 
  sum

non_res_frq <- round(non_response/sum(v10$n)*100)

#dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
#ungroup() %>% 
#  add_row(V1 = "No information", Q_lab = "No information Rate",  n = non_response, fr1=  paste0(non_res_frq,"%")) %>% 


v10 %>%
  dplyr::filter(Q_lab != "No response") %>% 
  mutate(fr1 = round(n/sum(n), 2)*100) %>% 
  ggplot(aes(x = V1, y = fr1, fill = factor(Q_lab)))+
  geom_bar(stat= "identity")+
  geom_text(aes(label = paste0(fr1, "%")),
                position = position_stack(vjust = .5), size = 3)+
  labs(x= "Group", y = "Frequency", title = "Question V10 - Type of sector in organization")+
  scale_fill_discrete(name = element_blank())+
  scale_y_continuous(limits=c(0,101), breaks= seq(0,100, by=10)) + 
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  theme(legend.position="bottom")

v10 %>%
  dplyr::filter(Q_lab != "No response") %>% 
   mutate(fr1 = round(n/sum(n), 2)*100) %>% 
  dplyr::mutate(fr1 = paste0(fr1, "%")) %>%
  ungroup() %>% 
   add_row(V1 = "No information", Q_lab = "No information Rate",  n = non_response, fr1=  paste0(non_res_frq,"%")) %>% 
  dplyr::select(Group = V1, "Type of sector in organization" = Q_lab, Count = n, Frequency = fr1)%T>%
  write_csv(., paste0(tbl_questions, "pregunta_V10(Type of sector in organization)", ".csv")) %>%
 flextable(., cwidth = 2)
```


#### Soporte de interpretación

En está grafica se observa que de los miembros pertenecientes al grupo A, `r v10$fr1[1]` de ellos se desenvuelven dentro de la empresa en el sector generalmente No asociado a sustentabilidad, mientras que un `r v10$fr1[2]` lo hace en el sector relacionado a sustentabilidad socio ambiental y un `r v10$fr1[3]` de los miembros no se identifica con ninguna de estas categorías o no aplica esta pregunta. Es de notar que un `r v10$fr1[4]` de los miembros entrevistados no tienen datos en este campo.

\pagebreak

## Identificação V11 - Position in organization

**Que cargo você ocupa na empresa ou organização?** 

```{r v11,echo=FALSE,warning=FALSE,fig.width=8, fig.height=6,strip.white=FALSE, cache = TRUE}

 v11 <- new_data$Informer %>%
  dplyr::mutate(ID = as.character(ID)) %>%
  dplyr::inner_join(., groups, by = c("ID" = "ID")) %>%
  dplyr::mutate(V11 = replace(V11, is.na(V11), "2"))%>%
  group_by(V1, V11) %>%
   tally() %>% 
  dplyr::mutate(Q_lab = case_when(
    V11 == "1" ~ "Executive board", 
    V11 == "2" ~ "Other",
    V11 == "3" ~ "No response",
    TRUE ~ "Not avaliable"
    ) ) 

  
non_response <- v11 %>% 
  dplyr::filter(Q_lab == "No response") %>% 
  pull(n) %>% 
  sum

non_res_frq <- round(non_response/sum(v10$n)*100)

#dplyr::filter(Q_lab != "No response") %>% mutate(fr1 = round(n/sum(n), 2)*100) %>%
#mutate(fr1 = round(n/sum(n), 2)*100) %>%
#ungroup() %>% 
#  add_row(V1 = "No information", Q_lab = "No information Rate",  n = non_response, fr1=  paste0(non_res_frq,"%")) %>% 




v11 %>%
  dplyr::filter(Q_lab != "No response") %>%
  mutate(fr1 = round(n/sum(n), 2)*100) %>%
  ggplot(aes(x = V1, y = fr1, fill = Q_lab))+
  geom_bar(stat= "identity")+
  geom_text(aes(label = paste0(fr1, "%")),
                position = position_stack(vjust = .5), size = 3)+
  labs(x= "Group", y = "Frequency", title = "Question V11 - Position in organization")+
  scale_y_continuous(limits=c(0,101), breaks= seq(0,100, by=10)) + 
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  theme(legend.position="bottom")



v11 %>%
  dplyr::filter(Q_lab != "No response") %>%
  mutate(fr1 = round(n/sum(n), 2)*100) %>%
  dplyr::mutate(fr1 = paste0(fr1, "%"))%>%
  ungroup() %>% 
  add_row(V1 = "No information", Q_lab = "No information Rate",  n = non_response, fr1=  paste0(non_res_frq,"%")) %>% 
  dplyr::filter(Q_lab != "Not avaliable") %>% 
  dplyr::select(Group = V1, "Position in organization" = Q_lab, Count =n,  Frequency = fr1)%T>%
  write_csv(., paste0(tbl_questions, "pregunta_V11(Position in organization)", ".csv")) %>%
 flextable(.)

```

#### Soporte de interpretación

En está grafica observamos que los miembros pertenecientes al grupo A el `r v11$fr1[1]` ocupa un cargo dentro de la empresa como director, mientras que un `r v11$fr1[2]` lo hace en el cargo de Otros y un `r v11$fr1[3]` de los miembros no se identifica con ninguna de estas categorías o no aplica esta pregunta.

\pagebreak

## Identificação – V12 Date interaction with PPA began (organization)

**Início da interação com a PPA - empresa**

```{r v12,echo=FALSE,warning=FALSE,fig.width=8, fig.height=6,strip.white=FALSE}
new_data$Informer %>%
  dplyr::mutate(ID = as.character(ID)) %>% 
  dplyr::inner_join(., groups, by = c("ID" = "ID")) %>%
  dplyr::mutate(year = lubridate::year(V12)) %>%
  group_by(ID)%>%
  dplyr::slice(which.min(V12)) %>%
  ungroup() %>%
  group_by(year) %>%
  dplyr::count(ID) %>%
  dplyr::summarise(suma = sum(n)) %>%
  ggplot(aes(x = year, y = suma))+
  geom_line(aes(group = 1),size=1, color="steelblue") +
  geom_point() +
  xlab("Año") + 
  ylab("Company count")+
  geom_text(aes(label = suma),  hjust=1.5, vjust=0, size = 3)+
  labs(title = "Question V12")+
  scale_y_continuous(limits=c(2, 40),breaks=seq(0,40,10)) +
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  scale_color_brewer(palette = "Dark2")+ theme(aspect.ratio = 0.6)+
  theme_light()+
  theme(legend.position="none")

new_data$Informer %>%
  dplyr::mutate(ID = as.character(ID)) %>% 
  dplyr::inner_join(., groups, by = c("ID" = "ID")) %>%
  dplyr::mutate(year = lubridate::year(V12)) %>% 
  group_by(ID)%>%
  dplyr::slice(which.min(V12)) %>%
  ungroup() %>% 
   group_by(year) %>%
  dplyr::count(ID) %>%
  left_join(., groups %>% dplyr::select(ID, Nome), by = c("ID" = "ID")) %>% 
  dplyr::select(ID, Nome, year) %>% 
  write.csv(., paste0(tbl_questions, "pregunta_V12(Date interaction with PPA began (organization))", ".csv") )

```

#### Soporte de interpretación

En esta grafica se observa la serie de tiempo anual de inicio de interacción de las empresas dentro del contexto de la PPA, lo más destacable es el hecho que en el año 2018 fue donde la mayor cantidad de empresas comenzaron a interactuar con la Plataforma.

\pagebreak

## Identificação – V13 Date interaction with PPA began (respondent)


**Em que mês e ano você começou a interagir com a PPA? Se não souber o mês, o ano é suficiente.**


```{r v13, echo=FALSE,warning=FALSE,fig.width=16, fig.height=9,strip.white=FALSE}
new_data$Informer %>%
  dplyr::mutate(ID = as.character(ID)) %>% 
  dplyr::inner_join(., groups, by = c("ID" = "ID")) %>%
  dplyr::mutate(month = as.yearmon(V13), ID_ego =paste0(ID, ID_ego)) %>%
  group_by(ID_ego) %>% 
  group_by(month) %>%
  dplyr::count(ID) %>%
  drop_na() %>% 
  dplyr::summarise(suma = sum(n)) %>%
  drop_na() %>% 
  dplyr::mutate(csuma = cumsum(suma)) %>%
  dplyr::mutate(month = as.Date(month)) %>%
  dplyr::filter(!is.na(month)) %>%
  ggplot(aes(x = month, y = csuma))+
  geom_line(size=1, color="steelblue") +
  geom_point(size = 2) +
  xlab("Años") + 
  ylab("Numero de empresas")+
  labs(title = "Question V13")+
  scale_y_continuous(limits=c(1, 66),breaks=seq(1,66,10)) + 
  scale_x_date(date_breaks = "1 month", date_labels = "%b-%y")+
  geom_text(aes(label = csuma),  hjust=1.8, vjust=0, size = 3)+
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  scale_color_brewer(palette = "Dark2")+ theme(aspect.ratio = 0.6)+
  theme_light()+
  theme(legend.position="none", axis.text.x=element_text(angle=60, hjust=1))

non_response <- new_data$Informer %>%
  dplyr::mutate(ID = as.character(ID)) %>% 
  dplyr::inner_join(., groups, by = c("ID" = "ID")) %>%
  dplyr::mutate(month = as.yearmon(V13), ID_ego =paste0(ID, ID_ego)) %>%
  group_by(ID_ego) %>% 
  group_by(month) %>%
  dplyr::count(ID) %>%
  dplyr::filter_all(any_vars(is.na(.))) %>% 
  nrow()
 
tot <- new_data$Informer %>%
  dplyr::mutate(ID = as.character(ID)) %>% 
  dplyr::inner_join(., groups, by = c("ID" = "ID")) %>%
  dplyr::mutate(month = as.yearmon(V13), ID_ego =paste0(ID, ID_ego)) %>%
  group_by(ID_ego) %>% 
  group_by(month) %>%
  dplyr::count(ID) %>% 
  nrow()
            
non_res_frq <- paste0(round(non_response/tot*100), "%")



new_data$Informer %>%
  dplyr::mutate(ID = as.character(ID)) %>% 
  dplyr::inner_join(., groups, by = c("ID" = "ID")) %>%
  dplyr::mutate(month = as.yearmon(V13), ID_ego =paste0(ID, ID_ego)) %>%
  group_by(ID_ego) %>% 
  group_by(month) %>%
  dplyr::count(ID) %>%
  ungroup() %>% 
  drop_na() %>% 
  left_join(., groups %>% dplyr::select(ID, Nome, Rodada_2019, V1), by = c("ID" = "ID")) %>% 
  # add_row(month = "No response", ID = "No response rate", n = non_response, Nome = "No response", Rodada_2019 = Nome, V1 = Nome) %>% 
  dplyr::select(ID, Nome, "Group" = V1, "date"= month, "Count" = n ) %>% 
  write.csv(., paste0(tbl_questions, "pregunta_V13(Date interaction with PPA began (respondent))", ".csv") )

```

#### Soporte de interpretación

Esta serie de tiempo muestra el mes en el que el entrevistado comenzó a integrar la PPA, al igual que en el groupsáfico de la pregunta V12 hay un incremento en los nuevos miembros que empezaron a actuar en la plataforma durante el año 2018. En la segunda grafica se muestra la misma serie de tiempo solo que los valores ahora representan la suma acumulada del número de miembro integrantes de la PPA, es destacable el hecho que a partir del mes de mayo del 2018 se presentó un gran incremento en el número de nuevos miembros que empezaron a integrar la PPA pasando de 21 a 43 en tan solo 5 meses. 

\pagebreak

## Identificação – V14 Role of respondent in the PPA

**Qual seu papel ou contribuiçao na PPA como colaborador da empresa? Indicar todas as opções aplicáveis.**

```{r v14, echo=FALSE,warning=FALSE,fig.width=11, fig.height=8,strip.white=FALSE, cache = F }


labs <- c("PPA Governance Committee (2019)", 
         "PPA Assembly", 
         "Executive Coordination",
         "WG1 - Enterpreneurship & acceleration",
         "WG2 - Bioeconomy",
         "WG3 - Local value chains",
         "WG4 - Public policy & legal responsibilities",
         "Acceleration Program",
         "Other")

vr <- paste0("V14_", 1:9)
df_trial <- new_data$Informer %>% 
  dplyr::mutate(ID= as.character(ID)) %>% 
  dplyr::select(ID, ID_ego, !!vr) %>% 
  dplyr::left_join(., groups, by = "ID") %>% 
  tidyr::drop_na() %>% 
  pivot_longer(cols = !!vr) %>% 
  dplyr::mutate(Q_lab = case_when(
    name == vr[1]       ~ labs[1],
    name == vr[2] 	    ~ labs[2],
    name == vr[3]	      ~labs[3],
    name == vr[4] 	    ~labs[4],
    name == vr[5] 	    ~labs[5],
    name == vr[6] 	    ~labs[6],
    name == vr[7]       ~labs[7],
    name == vr[8]       ~labs[8],
    name == vr[9]       ~labs[9],
    TRUE                ~"Not_avaliable"
  )) %>% 
  dplyr::filter(Q_lab != "Not_avaliable") 
  

non_response <- df_trial %>% 
 dplyr::filter(Q_lab == "Not_avaliable") %>%
 nrow()
non_res_frq <- round(non_response/length(unique(df_trial))*100)

#dplyr::filter(!!parse_quo(vr, env = caller_env()) != "0") %>% 
#ungroup() %>% 
# add_row(V1 = "No information", Q_lab = "No information Rate",  Count = non_response, tot = Count, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>% 



tots <-new_data$Informer %>% 
  dplyr::mutate(ID= as.character(ID)) %>% 
  dplyr::left_join(., groups, by = "ID") %>% 
  dplyr::select(ID, Nome, V1, !!vr) %>% 
  tidyr::drop_na() %>% 
  group_by(V1) %>% 
  tally()

df_trial %>% 
  group_by( V1, Q_lab) %>% 
  dplyr::summarise( Count = sum(as.numeric(value))) %>%
  ungroup %>% 
  dplyr::left_join(., tots , by ="V1") %>% 
  dplyr::mutate(freq = round(Count/n,3)*100, Frequency = paste0(freq, "%")) %>% 
  dplyr::filter(Count != 0) %>% 
  ggplot(aes(x = reorder(Q_lab, freq), y = freq, fill = V1)) +
  geom_bar(position = position_dodge2(preserve = "single", width = 1), stat = "identity", width = 0.8)+
  coord_flip() +
  scale_fill_manual(values = gr_colors$color) +
  geom_text(aes(label = Frequency),
                position = position_dodge(width  = 0.8), size = 3)+
  labs(x= element_blank(), y = "Frequency", title = paste("Question V14 - Role of respondent in the PPA"), fill = "Groups")+
  scale_y_continuous(limits=c(0,101), breaks= seq(0,101, by=10)) +
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  theme(legend.position= "right")

df_trial %>% 
  group_by( V1, Q_lab) %>% 
  dplyr::summarise( Count = sum(as.numeric(value))) %>%
  ungroup %>% 
  dplyr::left_join(., tots , by ="V1") %>% 
  dplyr::mutate(freq = round(Count/n,3)*100, Frequency = paste0(freq, "%")) %>% 
  dplyr::filter(Count != 0) %>% 
  add_row(V1 = "No information", Q_lab = "No information Rate",  Count = non_response, n = Count, freq = non_res_frq,Frequency = paste0(non_res_frq,"%")) %>%
  dplyr::select(Group = V1, "Papel na PPA" = Q_lab, Count, Frequency)  %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V14(Role of respondent in the PPA)_by_gr", ".csv")) %>% 
  flextable(., cwidth = 2) %>% 
  set_caption(., caption = "Role of respondent in the PPA")

```

#### Soporte de interpretación

Se lee de la siguiente manera: el 93.5% de las empresas que componen el grupo B, tiene como papel dentro de la PPA el de "Programa de Aceleração", así como el 20% de los miembros del grupo A2 afirman que tiene este mismo rol dentro de la PPA. Por ultimo el 36% de las empresas que conforman al grupo A tienen un papel de "Programa de Aceleração" dentro de la PPA. 

\pagebreak

# Perceptions section

this section shows the results of the questions V17 to V38 in the **Percepcoes** section.

## ConhecimentoPPA V17 - Knowledge about the PPA

**Como você avalia o seu grau de conhecimento da PPA?**

```{r v17, echo=FALSE, fig.height=6, fig.width=8, warning=FALSE, strip.white=FALSE, cache = TRUE}


labs <- c("None",
"Low",
"Moderate",
"High",
"Very high")
# df_lkt <- to_likert%>% 
#       mutate_all(factor, levels = labs )%>%
#       data.frame() %>%
#       likert(items = . , nlevels = 5)
# plot(., type = "bar", text.size = 5, plot.percents = T, plot.percent.low = F, plot.percent.high = F, plot.percent.neutral = F)+ 
#     theme(text = element_text(size = 20) , legend.title = element_blank())
  # df_lkt$results %>% 
  #     dplyr::mutate_if(is.numeric, .funs = function(i)paste0(round(i), "%")) 

to_likert <- new_data$Percepcoes %>% 
      dplyr::mutate(ID = as.character(ID)) %>% 
      dplyr::inner_join(., groups, by = c("ID" = "ID")) %>%
      dplyr::select(ID, ID_ego, V17, V1) %>%
      dplyr::mutate(V17= replace(V17, V17 == "0", labs[1]), 
                    V17= replace(V17, V17 == "1",  labs[2]),
                    V17= replace(V17, V17 == "2",  labs[3]),
                    V17= replace(V17, V17 == "3",  labs[4]),
                    V17= replace(V17, V17 == "4",  labs[5])) %>%
      dplyr::select(V17,V1) %>%
      dplyr::mutate(id = 1:nrow(.)) %>%
      pivot_wider(id_cols = id, names_from = V1, values_from = V17)%>%
  dplyr::select(-id)


df_lkt <- to_likert%>% 
      mutate_all(factor, levels = labs )%>%
      data.frame() %>%
      likert(items = . , nlevels = 5)

  pl <-  df_lkt %>% 
      plot(., type = "bar", text.size = 5, plot.percents = T, plot.percent.low = F, plot.percent.high = F, plot.percent.neutral = F)+ 
    theme(text = element_text(size = 20), legend.title = element_blank())
  
    pl
    
    df_lkt$results %>% 
      dplyr::mutate_if(is.numeric, .funs = function(i)paste0(round(i), "%"))    %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V17(Knowledge about the PPA)", ".csv")) %>%
      flextable(.)
    
```

#### Soporte de interpretación

* El 50% de  los miembros de la PPA del grupo A tienen un grado de conocimiento Mediano en lo concerniente al (funcionamiento, misión, visión, etc.) de la plataforma, es interesante notar que existe un 15% de miembros que tiene un nivel de conocimiento bajo siendo este porcentaje el más alto entre los demás los grupos, por último, el 35% de los mimebros tienen un conocimiento alto y muy alto del funcionamiento de la plataforma. 

* Para el grupo B tenemos que: el 48% de sus miembros tiene un conocimiento mediano sobre el funcionamiento de la PPA, una pequeña proporción 3% de empresas tienen un conocimiento bajo o nulo sobre el funcionamiento de la PPA, el 48% de las empresas que conforman el grupo B tiene un conocimiento Alto y muy alto sobre el funcionamiento de la plataforma.

* Por último, el grupo A2, es el que en la mayoría de los miembros 90% tienen un conocimiento alto y muy alto de conocimiento acerca de la PPA, tan solo un 10% afirman tener un conocimiento mediano sobre la plataforma y ninguno de sus miembros percibe tener un conocimiento bajo o nulo sobre el funcionamiento de la plataforma.

\pagebreak

## ConhecimentoPPA – V18a Understanding of PPA's objective

```{r v18a,echo=FALSE,warning=FALSE,fig.width=11, fig.height=8, cache = F}


vr <- paste0("V18a_", 1:7)
df_trial <- raw_data$Objetivo_PPA %>% 
  dplyr::mutate(ID= as.character(ID)) %>% 
  dplyr::left_join(., groups, by = "ID") %>% 
  tidyr::drop_na() %>% 
  pivot_longer(cols = !!vr) %>% 
  dplyr::mutate(Q_lab = case_when(
    name == vr[1]       ~"Formed by organizations that operate in the Amazon",
    name == vr[2] 	    ~"Promotes environmental conservation",
    name == vr[3]	      ~"Promotes sustainable development",
    name == vr[4] 	    ~"Facilitates engagement, collaboration with partners",
    name == vr[5] 	    ~"Promotes the Amazon impact business ecosystem",
    name == vr[6] 	    ~"Promotes Private sector leadership",
    name == vr[7]       ~"Develop strategic solutions and innovation",
    TRUE                ~"Not avaliable"
  )) %>% 
  dplyr::filter(Q_lab != "Not avaliable") 
  

tots <- raw_data$Objetivo_PPA %>% 
  dplyr::mutate(ID= as.character(ID)) %>% 
  dplyr::left_join(., groups, by = "ID") %>% 
  dplyr::select(ID, Nome, V1, !!vr) %>% 
  tidyr::drop_na() %>% 
  group_by(V1) %>% 
  tally()

df_trial %>% 
  group_by( V1, Q_lab) %>% 
  dplyr::summarise( Count = sum(as.numeric(value))) %>%
  ungroup %>% 
  dplyr::left_join(., tots , by = "V1") %>% 
  dplyr::mutate(freq = round(Count/n,3)*100, Frequency = paste0(freq, "%")) %>% 
  dplyr::filter(Count != 0) %>% 
  ggplot(aes(x = reorder(Q_lab, freq), y = freq, fill = V1)) +
  geom_bar(position = position_dodge2(preserve = "single", width = 1), stat = "identity", width = 0.8)+
  coord_flip() +
  scale_fill_manual(values = gr_colors$color) +
  geom_text(aes(label = Frequency),
                position = position_dodge(width  = 0.8), size = 3)+
  labs(x= element_blank(), y = "Frequency", title = "Question. V18a - Understanding of PPA's objective", fill = "Groups")+
  scale_y_continuous(limits=c(0,101), breaks= seq(0,101, by=10)) +
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  theme(legend.position= "right")
  
df_trial %>% 
  group_by( V1, Q_lab) %>% 
  dplyr::summarise( Count = sum(as.numeric(value))) %>%
  ungroup %>% 
  dplyr::left_join(., tots , by ="V1") %>% 
  dplyr::mutate(freq = round(Count/n,3)*100, Frequency = paste0(freq, "%")) %>% 
  dplyr::filter(Count != 0) %>% 
  dplyr::select(Group = V1, "Understanding of PPA's objective" = Q_lab, Count, Frequency) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V18a(Understanding of PPA's objective)_by_gr", ".csv")) %>%
  flextable(.) %>% 
  set_caption(., caption = "Frecuency of Understanding of PPA's objective")

```

\pagebreak

##  ConhecimentoPPA – V19a Organization's objective with PPA

```{r v19a,echo=FALSE,warning=FALSE,fig.width=11, fig.height=8, cache = F}


vr <- paste0("V19a_", 1:9)
df_trial <- raw_data$Objetivo_org %>% 
  dplyr::mutate(ID= as.character(ID)) %>% 
  dplyr::left_join(., groups, by = "ID") %>% 
  tidyr::drop_na() %>% 
  pivot_longer(cols = !!vr) %>% 
  dplyr::mutate(Q_lab = case_when(
    name == vr[1]       ~"Promote sustainability in development and conservation",
    name == vr[2] 	    ~"Strengthen Amazonian protagonism and development",
    name == vr[3]	      ~"Received invitation by PPA CoEx partner",
    name == vr[4] 	    ~"Organization's mission is aligned with PPA goals",
    name == vr[5] 	    ~"Create synergy and complementarity with partners",
    name == vr[6] 	    ~"Strengthen private sector leadership on PPA themes",
    name == vr[7]       ~"Promote the Amazon impact business ecosystem",
    name == vr[8]       ~"Participate in PPA's diverse investment opportunities",
    name == vr[9]       ~"Generate innovation & solutions for the Amazon",
    TRUE                ~"Not avaliable"
  )) %>% 
  dplyr::filter(Q_lab != "Not avaliable") 
  

tots <- raw_data$Objetivo_org %>% 
  dplyr::mutate(ID= as.character(ID)) %>% 
  dplyr::left_join(., groups, by = "ID") %>% 
  dplyr::select(ID, Nome, V1, !!vr) %>% 
  tidyr::drop_na() %>% 
  group_by(V1) %>% 
  tally()

df_trial %>% 
  group_by( V1, Q_lab) %>% 
  dplyr::summarise( Count = sum(as.numeric(value))) %>%
  ungroup %>% 
  dplyr::left_join(., tots , by ="V1") %>% 
  dplyr::mutate(freq = round(Count/n,3)*100, Frequency = paste0(freq, "%")) %>% 
  dplyr::filter(Count != 0) %>% 
  ggplot(aes(x = reorder(Q_lab, freq), y = freq, fill = V1)) +
  geom_bar(position = position_dodge2(preserve = "single", width = 1), stat = "identity", width = 0.8)+
  coord_flip() +
  scale_fill_manual(values = gr_colors$color) +
  geom_text(aes(label = Frequency),
                position = position_dodge(width  = 0.8), size = 3)+
  labs(x= element_blank(), y = "Frequency", title ="Question V19a - Organization's objective with PPA", fill = "Groups")+
  scale_y_continuous(limits=c(0,101), breaks= seq(0,101, by=10)) +
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  theme(legend.position= "right")
  
df_trial %>% 
  group_by( V1, Q_lab) %>% 
  dplyr::summarise( Count = sum(as.numeric(value))) %>%
  ungroup %>% 
  dplyr::left_join(., tots , by ="V1") %>% 
  dplyr::mutate(freq = round(Count/n,3)*100, Frequency = paste0(freq, "%")) %>% 
  dplyr::filter(Count != 0) %>% 
  dplyr::select(Group = V1, "Organization's objective with PPA" = Q_lab, Count, Frequency) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V19a(Organization's objective with PPA)_by_gr", ".csv")) %>%
  flextable(.) %>% 
  set_caption(., caption = "Frequency Organization's objective with PPA")

```


## ConhecimentoPPA – V20 Areas of interest in the PPA

**Quais são as áreas de interesse da empresa para atuação na PPA? Selecione todas as opções aplicáveis. (lista suspensa)**

```{r v20, echo=FALSE,warning=FALSE,fig.width=10, fig.height=8,strip.white=FALSE, cache = TRUE}


labs <- c("Entrepreneurship and acceleration in the Amazon",
    "Positive models interaction company & communities",
    "Relation with local government",
    "Policy for private sector socioenvironmental initiatives",
    "Coordinated actions of private sector in territories",
    "Promotion of bioeconomy in the Amazon",
    "Local socioeconomic use of private conservation  areas",
    "Leveraging local procurement by companies",
    "Growth & visibility of sociobiodiversity economy",
    "Sustainability of Amazon sociobiodiversity products",
    "Tools for local management of royalties and compensations",
    "Private sector, government & communities partnership for territorial development",
    "Other")

vr <- paste0("V20_", 1:13)
df_trial <- new_data$Percepcoes %>% 
  dplyr::mutate(ID= as.character(ID)) %>% 
  dplyr::select(ID, ID_ego, !!vr) %>% 
  dplyr::left_join(., groups, by = "ID") %>% 
  tidyr::drop_na() %>% 
  pivot_longer(cols = !!vr) %>% 
  dplyr::mutate(Q_lab = case_when(
    name == vr[1]       ~ labs[1],
    name == vr[2] 	    ~ labs[2],
    name == vr[3]	      ~labs[3],
    name == vr[4] 	    ~labs[4],
    name == vr[5] 	    ~labs[5],
    name == vr[6] 	    ~labs[6],
    name == vr[7]       ~labs[7],
    name == vr[7]       ~labs[8],
    name == vr[7]       ~labs[9],
    name == vr[7]       ~labs[10],
    name == vr[7]       ~labs[11],
    name == vr[7]       ~labs[12],
    name == vr[7]       ~labs[13],
    TRUE                ~"not avalaible"
  )) %>% 
  dplyr::filter(Q_lab != "not avalaible") 
  

tots <- new_data$Percepcoes %>% 
  dplyr::mutate(ID= as.character(ID)) %>% 
  dplyr::left_join(., groups, by = "ID") %>% 
  dplyr::select(ID, Nome, V1, !!vr) %>% 
  tidyr::drop_na() %>% 
  group_by(V1) %>% 
  tally()

df_trial %>% 
  group_by( V1, Q_lab) %>% 
  dplyr::summarise( Count = sum(as.numeric(value))) %>%
  ungroup %>% 
  dplyr::left_join(., tots , by ="V1") %>% 
  dplyr::mutate(freq = round(Count/n,3)*100, Frequency = paste0(freq, "%")) %>% 
  dplyr::filter(Count != 0) %>% 
  ggplot(aes(x = reorder(Q_lab, freq), y = freq, fill = V1)) +
  geom_bar(position = position_dodge2(preserve = "single", width = 1), stat = "identity", width = 0.8)+
  coord_flip() +
  scale_fill_manual(values = gr_colors$color) +
  geom_text(aes(label = Frequency),
                position = position_dodge(width  = 0.8), size = 3)+
  labs(x= element_blank(), y = "Frequency", title = "Per. V20 - Areas of interest in the PPA", fill = "Groups")+
  scale_y_continuous(limits=c(0,101), breaks= seq(0,101, by=10)) +
  labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  theme(legend.position= "right")
  
df_trial %>% 
  group_by( V1, Q_lab) %>% 
  dplyr::summarise( Count = sum(as.numeric(value))) %>%
  ungroup %>% 
  dplyr::left_join(., tots , by ="V1") %>% 
  dplyr::mutate(freq = round(Count/n,3)*100, Frequency = paste0(freq, "%")) %>% 
  dplyr::filter(Count != 0) %>% 
  dplyr::select(Group = V1, "Areas of interest in the PPA" = Q_lab, Count, Frequency) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V20(Areas of interest in the PPA)", ".csv")) %>%
  flextable(.) %>% 
  set_caption(., caption = "Frequency of Areas of interest in the PPA")


```

#### Soporte de interpretación 

Se interpreta de la siguiente manera: el 87.1% de las empresas del grupo B tiene como prioridad o área de interes las "Ações que promovam o empreendedorismo, incubação ou aceleração de iniciativas de impacto", de igual manera el 70% de las empresas del grupo A2 y el 84% de las del grupo A ven reflejada en esta misma categoría sus prioridades o áreas de interes dentro de la PPA.

\pagebreak

# Percepção sobre a capacidade da PPA

## CapacidadePPA-V21 Ability to catalyze private sector action

**Em sua opinião, neste momento a capacidade da PPA de catalizar a atuação de empresas em benefício da sustentabilidade na Amazônia é:**

```{r v21,echo=FALSE,warning=FALSE,fig.width=8, fig.height=4,strip.white=FALSE}

labs <- c("None",
"Low",
"Moderate",
"High",
"Very high",
"No response")

 # dplyr::mutate(id = 1:nrow(.)) %>%
 #      pivot_wider(id_cols = id, names_from = V1, values_from = V21)%>%
 #  dplyr::select(-id)
# df_lkt <- to_likert%>% 
#        filter_all(., any_vars(. != labs[6])) %>% 
#       mutate_all(factor, levels = labs[-length(labs)] )%>%
#       data.frame() %>%
#       likert(items = . , nlevels = 5)
# plot(., type = "bar", text.size = 5, plot.percents = T, plot.percent.low = F, plot.percent.high = F, plot.percent.neutral = F)+ 
#     theme(text = element_text(size = 20) , legend.title = element_blank())
  # df_lkt$results %>% 
  #     dplyr::mutate_if(is.numeric, .funs = function(i)paste0(round(i), "%")) 

 to_likert <- new_data$Percepcoes %>% 
      dplyr::mutate(ID = as.character(ID)) %>% 
      dplyr::inner_join(., groups, by = c("ID" = "ID")) %>%
      dplyr::select(ID, ID_ego, V21, V1) %>%
      dplyr::mutate(V21= replace(V21, V21 == "1", labs[1]), 
                    V21= replace(V21, V21 == "2", labs[2]),
                    V21= replace(V21, V21 == "3", labs[3]),
                    V21= replace(V21, V21 == "4", labs[4]),
                    V21= replace(V21, V21 == "5", labs[5]),
                    V21= replace(V21, V21 == "0", labs[6])) %>%
      dplyr::select(V21,V1) %>% 
     dplyr::mutate(id = 1:nrow(.)) %>%
      pivot_wider(id_cols = id, names_from = V1, values_from = V21)%>%
  dplyr::select(-id)

 non_response <- to_likert%>%
      filter_all(., any_vars(. == labs[6])) %>% 
   nrow()
 
 non_res_frq <- paste0(round(non_response/nrow(to_likert)*100,1), "%")
 
 
 df_lkt <- to_likert%>%
      filter_all(., any_vars(. != labs[6])) %>% 
      mutate_all(factor, levels = labs[-length(labs)] )%>%
      data.frame() %>%
      likert(items = . , nlevels = 5)

  pl <-  df_lkt %>% 
      plot(., type = "bar", text.size = 5, plot.percents = T, plot.percent.low = F, plot.percent.high = F, plot.percent.neutral = F)+ 
    theme(text = element_text(size = 20), legend.title = element_blank())
  
    pl
    
    df_lkt$results %>% 
      dplyr::mutate_if(is.numeric, .funs = function(i)paste0(round(i), "%")) %>% 
      add_row(Item = "No response rate", None = non_res_frq , Low = None,  Moderate = None,  High = None, "Very high" = None) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V21(Ability to catalyze private sector action)", ".csv")) %>%
      flextable(.)
    

  

    
```

\pagebreak

## CapacidadePPA-V22 Ability to mobilize new funding sources

**a capacidade da PPA de mobilizar novas fontes de financiamento para o desenvolvimento sustentável e conservação na Amazônia é:**

```{r v22,echo=FALSE,warning=FALSE,fig.width=8, fig.height=4,strip.white=FALSE}

labs <- c("None",
"Low",
"Moderate",
"High",
"Very high",
"No response")


to_likert <- new_data$Percepcoes %>% 
        dplyr::mutate(ID = as.character(ID)) %>% 
      dplyr::inner_join(., groups, by = c("ID" = "ID")) %>% 
      dplyr::select(ID, ID_ego, V22, V1) %>%
      dplyr::mutate(V22= replace(V22, V22 == "1",labs[1] ), 
                    V22= replace(V22, V22 == "2",labs[2] ),
                    V22= replace(V22, V22 == "3",labs[3] ),
                    V22= replace(V22, V22 == "4",labs[4] ),
                    V22= replace(V22, V22 == "5",labs[5] ),
                    V22= replace(V22, V22 == "0",labs[6] )) %>%
      dplyr::select(V22,V1) %>%
  dplyr::mutate(id = 1:nrow(.)) %>%
      pivot_wider(id_cols = id, names_from = V1, values_from = V22)%>%
  dplyr::select(-id)

 non_response <- to_likert%>%
      filter_all(., any_vars(. == labs[6])) %>% 
   nrow()
 
 non_res_frq <- paste0(round(non_response/nrow(to_likert)*100,1), "%")
 
 
 df_lkt <- to_likert%>%
      filter_all(., any_vars(. != labs[6])) %>% 
      mutate_all(factor, levels = labs[-length(labs)] )%>%
      data.frame() %>%
      likert(items = . , nlevels = 5)

  pl <-  df_lkt %>% 
      plot(., type = "bar", text.size = 5, plot.percents = T, plot.percent.low = F, plot.percent.high = F, plot.percent.neutral = F)+ 
    theme(text = element_text(size = 20), legend.title = element_blank())
  
    pl
    
    df_lkt$results %>% 
      dplyr::mutate_if(is.numeric, .funs = function(i)paste0(round(i), "%")) %>% 
      add_row(Item = "No response rate", None = non_res_frq , Low = None,  Moderate = None,  High = None, "Very high" = None) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V22(Ability to mobilize new funding sources)", ".csv")) %>%
      flextable(.)
```

\pagebreak

## CapacidadePPA-V23 Ability to mobilize private investments

**a capacidade da PPA de mobilizar investimentos privados para negócios sustentáveis na Amazônia é:**

```{r v23,echo=FALSE,warning=FALSE,fig.width=8, fig.height=4,strip.white=FALSE}

labs <- c("None",
"Low",
"Moderate",
"High",
"Very high",
"No response")

to_likert <- new_data$Percepcoes %>% 
      dplyr::mutate(ID = as.character(ID)) %>% 
      dplyr::inner_join(., groups, by = c("ID" = "ID"))  %>%
      dplyr::select(ID, ID_ego, V23, V1) %>%
      dplyr::mutate(V23= replace(V23, V23 == "1", labs[1]), 
                    V23= replace(V23, V23 == "2", labs[2]),
                    V23= replace(V23, V23 == "3", labs[3]),
                    V23= replace(V23, V23 == "4", labs[4]),
                    V23= replace(V23, V23 == "5", labs[5]),
                    V23= replace(V23, V23 == "0", labs[6])) %>%
      dplyr::select(V23,V1) %>%
  dplyr::mutate(id = 1:nrow(.)) %>%
      pivot_wider(id_cols = id, names_from = V1, values_from = V23)%>%
  dplyr::select(-id)

 non_response <- to_likert%>%
      filter_all(., any_vars(. == labs[6])) %>% 
   nrow()
 
 non_res_frq <- paste0(round(non_response/nrow(to_likert)*100,1), "%")
 
 
 df_lkt <- to_likert%>%
      filter_all(., any_vars(. != labs[6])) %>% 
      mutate_all(factor, levels = labs[-length(labs)] )%>%
      data.frame() %>%
      likert(items = . , nlevels = 5)

  pl <-  df_lkt %>% 
      plot(., type = "bar", text.size = 5, plot.percents = T, plot.percent.low = F, plot.percent.high = F, plot.percent.neutral = F)+ 
    theme(text = element_text(size = 20), legend.title = element_blank())
  
    pl
    
    df_lkt$results %>% 
      dplyr::mutate_if(is.numeric, .funs = function(i)paste0(round(i), "%")) %>% 
      add_row(Item = "No response rate", None = non_res_frq , Low = None,  Moderate = None,  High = None, "Very high" = None) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V23(Ability to mobilize private investments)", ".csv")) %>%
      flextable(.)
    
```

\pagebreak

## CapacidadePPA-V24 Ability to give visibility to businesses

**a capacidade da PPA de dar visibilidade às empresas que desenvolvem negócios sustentáveis na Amazônia é:**

```{r v24, echo=FALSE,warning=FALSE,fig.width=8, fig.height=4,strip.white=FALSE}

labs <- c("None",
"Low",
"Moderate",
"High",
"Very high",
"No response")

to_likert <- new_data$Percepcoes %>% 
       dplyr::mutate(ID = as.character(ID)) %>% 
      dplyr::inner_join(., groups, by = c("ID" = "ID"))  %>%
      dplyr::select(ID, ID_ego, V24, V1) %>%
      dplyr::mutate(V24= replace(V24, V24 == "1", labs[1]), 
                    V24= replace(V24, V24 == "2", labs[2]),
                    V24= replace(V24, V24 == "3", labs[3]),
                    V24= replace(V24, V24 == "4", labs[4]),
                    V24= replace(V24, V24 == "5", labs[5]),
                    V24= replace(V24, V24 == "0", labs[6])) %>%
      dplyr::select(V24,V1) %>%
  dplyr::mutate(id = 1:nrow(.)) %>%
      pivot_wider(id_cols = id, names_from = V1, values_from = V24)%>%
  dplyr::select(-id)

 non_response <- to_likert%>%
      filter_all(., any_vars(. == labs[6])) %>% 
   nrow()
 
 non_res_frq <- paste0(round(non_response/nrow(to_likert)*100,1), "%")
 
 
 df_lkt <- to_likert%>%
      filter_all(., any_vars(. != labs[6])) %>% 
      mutate_all(factor, levels = labs[-length(labs)] )%>%
      data.frame() %>%
      likert(items = . , nlevels = 5)

  pl <-  df_lkt %>% 
      plot(., type = "bar", text.size = 5, plot.percents = T, plot.percent.low = F, plot.percent.high = F, plot.percent.neutral = F)+ 
    theme(text = element_text(size = 20), legend.title = element_blank())
  
    pl
    
    df_lkt$results %>% 
      dplyr::mutate_if(is.numeric, .funs = function(i)paste0(round(i), "%")) %>% 
      add_row(Item = "No response rate", None = non_res_frq , Low = None,  Moderate = None,  High = None, "Very high" = None) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V24(Ability to give visibility to businesses)", ".csv")) %>%
      flextable(.)
   
```

\pagebreak

## CapacidadePPA-V25 Ability to generate innovative solutions

**a capacidade da PPA de mobilizar soluções inovadoras para o desenvolvimento sustentável e conservação na Amazônia é:**

```{r v25, echo=FALSE,warning=FALSE,fig.width=8, fig.height=4,strip.white=FALSE}

labs <- c("None",
"Low",
"Moderate",
"High",
"Very high",
"No response")

to_likert <- new_data$Percepcoes %>% 
      dplyr::mutate(ID = as.character(ID)) %>% 
      dplyr::inner_join(., groups, by = c("ID" = "ID"))%>%
      dplyr::select(ID, ID_ego, V25, V1) %>%
      dplyr::mutate(V25= replace(V25, V25 == "1", labs[1]), 
                    V25= replace(V25, V25 == "2", labs[2]),
                    V25= replace(V25, V25 == "3", labs[3]),
                    V25= replace(V25, V25 == "4", labs[4]),
                    V25= replace(V25, V25 == "5", labs[5]),
                    V25= replace(V25, V25 == "0", labs[6])) %>%
      dplyr::select(V25,V1) %>%
  dplyr::mutate(id = 1:nrow(.)) %>%
      pivot_wider(id_cols = id, names_from = V1, values_from = V25)%>%
  dplyr::select(-id)

 non_response <- to_likert%>%
      filter_all(., any_vars(. == labs[6])) %>% 
   nrow()
 
 non_res_frq <- paste0(round(non_response/nrow(to_likert)*100,1), "%")
 
 
 df_lkt <- to_likert%>%
      filter_all(., any_vars(. != labs[6])) %>% 
      mutate_all(factor, levels = labs[-length(labs)] )%>%
      data.frame() %>%
      likert(items = . , nlevels = 5)

  pl <-  df_lkt %>% 
      plot(., type = "bar", text.size = 5, plot.percents = T, plot.percent.low = F, plot.percent.high = F, plot.percent.neutral = F)+ 
    theme(text = element_text(size = 20), legend.title = element_blank())
  
    pl
    
    df_lkt$results %>% 
      dplyr::mutate_if(is.numeric, .funs = function(i)paste0(round(i), "%")) %>% 
      add_row(Item = "No response rate", None = non_res_frq , Low = None,  Moderate = None,  High = None, "Very high" = None) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V25(Ability to generate innovative solutions)", ".csv")) %>%
      flextable(.)
    
```

\pagebreak

## CapacidadePPA-V26 Ability to create new businesses

**a capacidade da PPA de criar novos negócios alinhados com a conservação da floresta e bem estar de comunidades é:**

```{r v26, echo=FALSE,warning=FALSE,fig.width=8, fig.height=4,strip.white=FALSE}
labs <- c("None",
"Low",
"Moderate",
"High",
"Very high",
"No response")

to_likert <- new_data$Percepcoes %>% 
      dplyr::mutate(ID = as.character(ID)) %>% 
      dplyr::inner_join(., groups, by = c("ID" = "ID")) %>%
      dplyr::select(ID, ID_ego, V26, V1) %>%
      dplyr::mutate(V26= replace(V26, V26 == "1", labs[1]), 
                    V26= replace(V26, V26 == "2", labs[2]),
                    V26= replace(V26, V26 == "3", labs[3]),
                    V26= replace(V26, V26 == "4", labs[4]),
                    V26= replace(V26, V26 == "5", labs[5]),
                    V26= replace(V26, V26 == "0", labs[6])) %>%
      dplyr::select(V26,V1) %>%
  dplyr::mutate(id = 1:nrow(.)) %>%
      pivot_wider(id_cols = id, names_from = V1, values_from = V26)%>%
  dplyr::select(-id)

 non_response <- to_likert%>%
      filter_all(., any_vars(. == labs[6])) %>% 
   nrow()
 
 non_res_frq <- paste0(round(non_response/nrow(to_likert)*100,1), "%")
 
 
 df_lkt <- to_likert%>%
      filter_all(., any_vars(. != labs[6])) %>% 
      mutate_all(factor, levels = labs[-length(labs)] )%>%
      data.frame() %>%
      likert(items = . , nlevels = 5)

  pl <-  df_lkt %>% 
      plot(., type = "bar", text.size = 5, plot.percents = T, plot.percent.low = F, plot.percent.high = F, plot.percent.neutral = F)+ 
    theme(text = element_text(size = 20), legend.title = element_blank())
  
    pl
    
    df_lkt$results %>% 
      dplyr::mutate_if(is.numeric, .funs = function(i)paste0(round(i), "%")) %>% 
      add_row(Item = "No response rate", None = non_res_frq , Low = None,  Moderate = None,  High = None, "Very high" = None) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V26(Ability to create new businesses)", ".csv")) %>%
      flextable(.)
    
    
    
```

\pagebreak

## CapacidadePPA-V27 Abitity to create favorable political environment

**a capacidade da PPA de impulsionar um ambiente político favorável à conservação e desenvolvimento sustentável na Amazônia é:**

```{r v27, echo=FALSE,warning=FALSE,fig.width=8, fig.height=4,strip.white=FALSE}
labs <- c("None",
"Low",
"Moderate",
"High",
"Very high",
"No response")

to_likert <- new_data$Percepcoes %>% 
        dplyr::mutate(ID = as.character(ID)) %>% 
      dplyr::inner_join(., groups, by = c("ID" = "ID")) %>%
        dplyr::select(ID, ID_ego, V27, V1) %>%
        dplyr::mutate(V27= replace(V27, V27 == "1", labs[1]), 
                      V27= replace(V27, V27 == "2", labs[2]),
                      V27= replace(V27, V27 == "3", labs[3]),
                      V27= replace(V27, V27 == "4", labs[4]),
                      V27= replace(V27, V27 == "5", labs[5]),
                      V27= replace(V27, V27 == "0",labs[6])) %>%
        dplyr::select(V27,V1) %>%
  dplyr::mutate(id = 1:nrow(.)) %>%
      pivot_wider(id_cols = id, names_from = V1, values_from = V27)%>%
  dplyr::select(-id)

 non_response <- to_likert%>%
      filter_all(., any_vars(. == labs[6])) %>% 
   nrow()
 
 non_res_frq <- paste0(round(non_response/nrow(to_likert)*100,1), "%")
 
 
 df_lkt <- to_likert%>%
      filter_all(., any_vars(. != labs[6])) %>% 
      mutate_all(factor, levels = labs[-length(labs)] )%>%
      data.frame() %>%
      likert(items = . , nlevels = 5)

  pl <-  df_lkt %>% 
      plot(., type = "bar", text.size = 5, plot.percents = T, plot.percent.low = F, plot.percent.high = F, plot.percent.neutral = F)+ 
    theme(text = element_text(size = 20), legend.title = element_blank())
  
    pl
    
    df_lkt$results %>% 
      dplyr::mutate_if(is.numeric, .funs = function(i)paste0(round(i), "%")) %>% 
      add_row(Item = "No response rate", None = non_res_frq , Low = None,  Moderate = None,  High = None, "Very high" = None) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V27(Abitity to create favorable political environment)", ".csv")) %>%
      flextable(.)
    
```

\pagebreak

## CapacidadePPA-V28 Ability to reduce deforestation & conserve biodiversity 

**a capacidade da PPA de ter impacto na redução do desmatamento e na conservação da biodiversidade é:**

```{r v28, echo=FALSE,warning=FALSE,fig.width=8, fig.height=4,strip.white=FALSE}

labs <- c("None",
"Low",
"Moderate",
"High",
"Very high",
"No response")

to_likert <- new_data$Percepcoes %>% 
         dplyr::mutate(ID = as.character(ID)) %>% 
        dplyr::inner_join(., groups, by = c("ID" = "ID")) %>%
        dplyr::select(ID, ID_ego, V28, V1) %>%
        dplyr::mutate(V28= replace(V28, V28 == "1", labs[1]), 
                      V28= replace(V28, V28 == "2", labs[2]),
                      V28= replace(V28, V28 == "3", labs[3]),
                      V28= replace(V28, V28 == "4", labs[4]),
                      V28= replace(V28, V28 == "5", labs[5]),
                      V28= replace(V28, V28 == "0", labs[6])) %>%
        dplyr::select(V28,V1) %>%
  dplyr::mutate(id = 1:nrow(.)) %>%
      pivot_wider(id_cols = id, names_from = V1, values_from = V28)%>%
  dplyr::select(-id)

 non_response <- to_likert%>%
      filter_all(., any_vars(. == labs[6])) %>% 
   nrow()
 
 non_res_frq <- paste0(round(non_response/nrow(to_likert)*100,1), "%")
 
 
 df_lkt <- to_likert%>%
      filter_all(., any_vars(. != labs[6])) %>% 
      mutate_all(factor, levels = labs[-length(labs)] )%>%
      data.frame() %>%
      likert(items = . , nlevels = 5)

  pl <-  df_lkt %>% 
      plot(., type = "bar", text.size = 5, plot.percents = T, plot.percent.low = F, plot.percent.high = F, plot.percent.neutral = F)+ 
    theme(text = element_text(size = 20), legend.title = element_blank())
  
    pl
    
    df_lkt$results %>% 
      dplyr::mutate_if(is.numeric, .funs = function(i)paste0(round(i), "%")) %>% 
      add_row(Item = "No response rate", None = non_res_frq , Low = None,  Moderate = None,  High = None, "Very high" = None) %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V28(Ability to reduce deforestation & conserve biodiversity )", ".csv")) %>%
      flextable(.)
```

\pagebreak

## CapacidaddePPA - spider graph

```{r v21_v28_spider, echo=FALSE,warning=FALSE,fig.width=10, fig.height=11,strip.white=FALSE}

vs <- paste0("V", 21:28)
 labs <- c( "Ability to catalyze private sector action",
              "Ability to mobilize new funding sources",
              "Ability to mobilize private investments",
              "Ability to give visibility to businesses",
              "Ability to generate innovative solutions",
              "Ability to create new businesses",
              "Abitity to create favorable political environment",
              "Abitity to create favorable political environment")
labs <- data.frame(var_name = vs, Q_lab = labs, stringsAsFactors = F)

n_res <- new_data$Percepcoes %>% 
  dplyr::mutate(ID = as.character(ID)) %>% 
  dplyr::inner_join(., groups, by = c("ID" = "ID")) %>%
  dplyr::select(ID, ID_ego, vs , V1) %>% 
  dplyr::mutate_if(., is.numeric, .funs = function(i){ifelse(i == 0 | i == 6, NA, i)}) %>% 
  pivot_longer(., cols = vs)

non_response <- n_res %>% 
  dplyr::filter(is.na(value)) %>% 
  nrow()

non_res_frq <- paste0(round(non_response/nrow(n_res)*100, 1), "%")

to_plot <- n_res %>% 
  drop_na() %>% 
  dplyr::mutate(value = if_else(value <= 3, 0, 1)) %>% 
  group_by(V1, name) %>%
  dplyr::summarise( summ = sum(value), cnt = n()) %>% 
  ungroup() %>% 
  dplyr::mutate(Frequency = summ/cnt)

to_plot%>% 
  pivot_wider(id_cols = V1, names_from = name, values_from = Frequency)%>% 
  as.data.frame() %>% 
  ggradar(., group.colours  = gr_colors$color[-4], group.line.width = 1,  group.point.size = 3, base.size = 20)


   to_plot %>% 
    dplyr::left_join(., labs, by = c("name" = "var_name")) %>% 
     dplyr::mutate(Frequency= paste0(round(Frequency*100), "%")) %>% 
     add_row(V1 = "No response", name = "No response rate", summ = non_response, Frequency = non_res_frq, Q_lab = name) %>% 
     dplyr::select("Group" = V1, "Question ID" = name, "Question statement" = Q_lab, Count = summ,  Frequency) %T>%
     write.csv(., paste0(tbl_questions, "perceptions_capPPA_V21_V28_spider", ".csv")) %>% 
     flextable(.)
     
       
       
   
```

\pagebreak


# Grau de confiança na PPA

## Confiança_impacto -V29 Reliable governance to support investment

**A governança da PPA gera confiança entre seus membros para investir em ações desenvolvidas no âmbito da plataforma**

```{r v29, echo=FALSE,warning=FALSE,fig.width=8, fig.height=4,strip.white=FALSE}



labs <- c("Strongly disagree",
"Disagree",
"Uncertain",
"Agree",
"Strongly agree",
"No response")

to_likert <- new_data$Percepcoes %>% 
         dplyr::mutate(ID = as.character(ID)) %>% 
        dplyr::inner_join(., groups, by = c("ID" = "ID")) %>%
        dplyr::select(ID, ID_ego, V29, V1) %>%
        mutate(V29 = dplyr::recode(V29, 
                      `1` = labs[1], 
                      `2` = labs[2],
                      `3` = labs[3],
                      `4` = labs[4],
                      `5` = labs[5],
                      `0` = labs[6])) %>%
        dplyr::select(V29,V1) %>%
  dplyr::mutate(id = 1:nrow(.)) %>%
      pivot_wider(id_cols = id, names_from = V1, values_from = V29)%>%
  dplyr::select(-id)

 non_response <- to_likert%>%
      filter_all(., any_vars(. == labs[6])) %>% 
   nrow()
 
 non_res_frq <- paste0(round(non_response/nrow(to_likert)*100,1), "%")
 
 
 df_lkt <- to_likert%>%
      filter_all(., any_vars(. != labs[6])) %>% 
      mutate_all(factor, levels = labs[-length(labs)] )%>%
      data.frame() %>%
      likert(items = . , nlevels = 5)

  pl <-  df_lkt %>% 
      plot(., type = "bar", text.size = 5, plot.percents = T, plot.percent.low = F, plot.percent.high = F, plot.percent.neutral = F)+ 
    theme(text = element_text(size = 20), legend.title = element_blank())
  
    pl
    
    df_lkt$results %>% 
      dplyr::mutate_if(is.numeric, .funs = function(i)paste0(round(i), "%")) %>% 
      add_row(Item = "No response rate", "Strongly disagree" = non_res_frq , "Disagree"  = non_res_frq,  "Uncertain" = non_res_frq,  "Agree" = non_res_frq, "Strongly agree" = non_res_frq)  %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V29(Reliable governance to support investment)", ".csv")) %>%
      flextable(.)
```

\pagebreak

## Confiança_impacto -V30 Reliable management to participate

**A condução da PPA gera confiança para minha empresa participar da PPA**

```{r v30, echo=FALSE,warning=FALSE,fig.width=8, fig.height=4,strip.white=FALSE}

labs <- c("Strongly disagree",
"Disagree",
"Uncertain",
"Agree",
"Strongly agree",
"No response")

 to_likert <- new_data$Percepcoes %>% 
        dplyr::mutate(ID = as.character(ID)) %>% 
        dplyr::inner_join(., groups, by = c("ID" = "ID"))%>%
        dplyr::select(ID, ID_ego, V30, V1) %>%
        mutate(V30 = dplyr::recode(V30, 
                                   `1` = labs[1], 
                                   `2` = labs[2],
                                   `3` = labs[3],
                                   `4` = labs[4],
                                   `5` = labs[5],
                                   `0` = labs[6])) %>%
        dplyr::select(V30,V1) %>%
  dplyr::mutate(id = 1:nrow(.)) %>%
      pivot_wider(id_cols = id, names_from = V1, values_from = V30)%>%
  dplyr::select(-id)

 non_response <- to_likert%>%
      filter_all(., any_vars(. == labs[6])) %>% 
   nrow()
 
 non_res_frq <- paste0(round(non_response/nrow(to_likert)*100,1), "%")
 
 
 df_lkt <- to_likert%>%
      filter_all(., any_vars(. != labs[6])) %>% 
      mutate_all(factor, levels = labs[-length(labs)] )%>%
      data.frame() %>%
      likert(items = . , nlevels = 5)

  pl <-  df_lkt %>% 
      plot(., type = "bar", text.size = 5, plot.percents = F, plot.percent.low = T, plot.percent.high = T, plot.percent.neutral = T)+ 
    theme(text = element_text(size = 20), legend.title = element_blank())
  
    pl
    
    df_lkt$results %>% 
      dplyr::mutate_if(is.numeric, .funs = function(i)paste0(round(i), "%")) %>% 
      add_row(Item = "No response rate", "Strongly disagree" = non_res_frq , "Disagree"  = non_res_frq,  "Uncertain" = non_res_frq,  "Agree" = non_res_frq, "Strongly agree" = non_res_frq)  %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V30(Reliable management to participate)", ".csv")) %>%
      flextable(.)
```


\pagebreak

## Confiança_impacto -V31 Reliable space for business protagonism

**A PPA cria espaço confiável para o protagonismo e colaboração de empresas no desenvolvimento sustentável e conservação da Amazônia**

```{r v31, echo=FALSE,warning=FALSE,fig.width=8, fig.height=4,strip.white=FALSE}

labs <- c("Strongly disagree",
"Disagree",
"Uncertain",
"Agree",
"Strongly agree",
"No response")

 to_likert <- new_data$Percepcoes %>% 
        dplyr::mutate(ID = as.character(ID)) %>% 
        dplyr::inner_join(., groups, by = c("ID" = "ID")) %>%
        dplyr::select(ID, ID_ego, V31, V1) %>%
        mutate(V31 = dplyr::recode(V31, 
                                   `1` = labs[1], 
                                   `2` = labs[2],
                                   `3` = labs[3],
                                   `4` = labs[4],
                                   `5` = labs[5],
                                   `0` = labs[6])) %>%
        dplyr::select(V31,V1) %>%
  dplyr::mutate(id = 1:nrow(.)) %>%
      pivot_wider(id_cols = id, names_from = V1, values_from = V31)%>%
  dplyr::select(-id)

 non_response <- to_likert%>%
      filter_all(., any_vars(. == labs[6])) %>% 
   nrow()
 
 non_res_frq <- paste0(round(non_response/nrow(to_likert)*100,1), "%")
 
 
 df_lkt <- to_likert%>%
      filter_all(., any_vars(. != labs[6])) %>% 
      mutate_all(factor, levels = labs[-length(labs)] )%>%
      data.frame() %>%
      likert(items = . , nlevels = 5)

  pl <-  df_lkt %>% 
      plot(., type = "bar", text.size = 5, plot.percents = F, plot.percent.low = T, plot.percent.high = T, plot.percent.neutral = T) + 
    theme(text = element_text(size = 20), legend.title = element_blank())
  
    pl
    
    df_lkt$results %>% 
      dplyr::mutate_if(is.numeric, .funs = function(i)paste0(round(i), "%")) %>% 
      add_row(Item = "No response rate", "Strongly disagree" = non_res_frq , "Disagree"  = non_res_frq,  "Uncertain" = non_res_frq,  "Agree" = non_res_frq, "Strongly agree" = non_res_frq)  %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V31(Reliable space for business protagonism)", ".csv")) %>%
      flextable(.)
```


\pagebreak


# Percepções sobre empresas em relação à PPA

## Confiança_impacto -V32 Promotes commitment to socioenvironmental sustainability

**A PPA estimula o compromisso institucional das empresas e organizações membro com a sustentabilidade socioambiental**

```{r v32, echo=FALSE,warning=FALSE,fig.width=8, fig.height=4,strip.white=FALSE}
labs <- c("Strongly disagree",
"Disagree",
"Uncertain",
"Agree",
"Strongly agree",
"No response")

 to_likert <- new_data$Percepcoes %>% 
        dplyr::mutate(ID = as.character(ID)) %>% 
        dplyr::inner_join(., groups, by = c("ID" = "ID"))  %>%
        dplyr::select(ID, ID_ego, V32, V1) %>%
        mutate(V32 = dplyr::recode(V32, 
                                   `1` = labs[1], 
                                   `2` = labs[2],
                                   `3` = labs[3],
                                   `4` = labs[4],
                                   `5` = labs[5],
                                   `0` = labs[6])) %>%
        dplyr::select(V32,V1) %>%
  dplyr::mutate(id = 1:nrow(.)) %>%
      pivot_wider(id_cols = id, names_from = V1, values_from = V32)%>%
  dplyr::select(-id)

 non_response <- to_likert%>%
      filter_all(., any_vars(. == labs[6])) %>% 
   nrow()
 
 non_res_frq <- paste0(round(non_response/nrow(to_likert)*100,1), "%")
 
 
 df_lkt <- to_likert%>%
      filter_all(., any_vars(. != labs[6])) %>% 
      mutate_all(factor, levels = labs[-length(labs)] )%>%
      data.frame() %>%
      likert(items = . , nlevels = 5)

  pl <-  df_lkt %>% 
      plot(., type = "bar", text.size = 5, plot.percents = T, plot.percent.low = F, plot.percent.high = F, plot.percent.neutral = F) + 
    theme(text = element_text(size = 20), legend.title = element_blank())
  
    pl
    
    df_lkt$results %>% 
      dplyr::mutate_if(is.numeric, .funs = function(i)paste0(round(i), "%")) %>% 
      add_row(Item = "No response rate", "Strongly disagree" = non_res_frq , "Disagree"  = non_res_frq,  "Uncertain" = non_res_frq,  "Agree" = non_res_frq, "Strongly agree" = non_res_frq)  %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V32(Promotes commitment to socioenvironmental sustainability)", ".csv")) %>%
      flextable(.)
```

\pagebreak

## Confiança_impacto -V33 Companies strongly committed to the PPA

**As empresas membro da PPA têm forte compromisso com a Plataforma**

```{r v33, echo=FALSE,warning=FALSE,fig.width=8, fig.height=4,strip.white=FALSE}

labs <- c("Strongly disagree",
"Disagree",
"Uncertain",
"Agree",
"Strongly agree",
"No response")

to_likert <- new_data$Percepcoes %>% 
  dplyr::mutate(ID = as.character(ID)) %>% 
  dplyr::inner_join(., groups, by = c("ID" = "ID"))%>%
  dplyr::select(ID, ID_ego, V33, V1) %>%
  mutate(V33 = dplyr::recode(V33, 
                             `1` = labs[1], 
                             `2` = labs[2],
                             `3` = labs[3],
                             `4` = labs[4],
                             `5` = labs[5],
                             `0` = labs[6] )) %>%
  dplyr::select(V33,V1) %>%
  dplyr::mutate(id = 1:nrow(.)) %>%
  pivot_wider(id_cols = id, names_from = V1, values_from = V33)%>%
  dplyr::select(-id)

 non_response <- to_likert%>%
      filter_all(., any_vars(. == labs[6])) %>% 
   nrow()
 
 non_res_frq <- paste0(round(non_response/nrow(to_likert)*100,1), "%")
 
 
 df_lkt <- to_likert%>%
      filter_all(., any_vars(. != labs[6])) %>% 
      mutate_all(factor, levels = labs[-length(labs)] )%>%
      data.frame() %>%
      likert(items = . , nlevels = 5)

  pl <-  df_lkt %>% 
      plot(., type = "bar", text.size = 5, plot.percents = T, plot.percent.low = F, plot.percent.high = F, plot.percent.neutral = F) + 
    theme(text = element_text(size = 20), legend.title = element_blank())
  
    pl
    
    df_lkt$results %>% 
      dplyr::mutate_if(is.numeric, .funs = function(i)paste0(round(i), "%")) %>% 
      add_row(Item = "No response rate", "Strongly disagree" = non_res_frq , "Disagree"  = non_res_frq,  "Uncertain" = non_res_frq,  "Agree" = non_res_frq, "Strongly agree" = non_res_frq)  %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V33(Companies strongly committed to the PPA)", ".csv")) %>%
      flextable(.)
``` 

\pagebreak

## Confiança_impacto -V34 Company plays a leading role in PPA

**Minha empresa/orgnização exerce protagonismo na condução e/ou ações da PPA**

```{r v34, echo=FALSE,warning=FALSE,fig.width=8, fig.height=4,strip.white=FALSE}

labs <- c("Strongly disagree",
"Disagree",
"Uncertain",
"Agree",
"Strongly agree",
"No response")

to_likert <- new_data$Percepcoes %>% 
        dplyr::mutate(ID = as.character(ID)) %>% 
        dplyr::inner_join(., groups, by = c("ID" = "ID")) %>%
        dplyr::select(ID, ID_ego, V34, V1) %>%
        mutate(V34 = dplyr::recode(V34, 
                                   `1` = labs[1], 
                                   `2` = labs[2],
                                   `3` = labs[3],
                                   `4` = labs[4],
                                   `5` = labs[5],
                                   `0` = labs[6])) %>%
        dplyr::select(V34,V1) %>%
  dplyr::mutate(id = 1:nrow(.)) %>%
  pivot_wider(id_cols = id, names_from = V1, values_from = V34)%>%
  dplyr::select(-id)

 non_response <- to_likert%>%
      filter_all(., any_vars(. == labs[6])) %>% 
   nrow()
 
 non_res_frq <- paste0(round(non_response/nrow(to_likert)*100,1), "%")
 
 
 df_lkt <- to_likert%>%
      filter_all(., any_vars(. != labs[6])) %>% 
      mutate_all(factor, levels = labs[-length(labs)] )%>%
      data.frame() %>%
      likert(items = . , nlevels = 5)

  pl <-  df_lkt %>% 
      plot(., type = "bar", text.size = 5, plot.percents = T, plot.percent.low = F, plot.percent.high = F, plot.percent.neutral = F) + 
    theme(text = element_text(size = 20), legend.title = element_blank())
  
    pl
    
    df_lkt$results %>% 
      dplyr::mutate_if(is.numeric, .funs = function(i)paste0(round(i), "%")) %>% 
      add_row(Item = "No response rate", "Strongly disagree" = non_res_frq , "Disagree"  = non_res_frq,  "Uncertain" = non_res_frq,  "Agree" = non_res_frq, "Strongly agree" = non_res_frq)  %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V34(Company plays a leading role in PPA)", ".csv")) %>%
      flextable(.)
```

\pagebreak

## Confiança_impacto -V35 Positive influence in company's business

**A PPA influenciou positivamente os negócios ou iniciativas da minha empresa/organização na Amazônia até o momento**

```{r v35, echo=FALSE,warning=FALSE,fig.width=8, fig.height=4,strip.white=FALSE}
labs <- c("Strongly disagree",
"Disagree",
"Uncertain",
"Agree",
"Strongly agree",
"No response")

to_likert <- new_data$Percepcoes %>% 
        dplyr::mutate(ID = as.character(ID)) %>% 
        dplyr::inner_join(., groups, by = c("ID" = "ID")) %>%
        dplyr::select(ID, ID_ego, V35, V1) %>%
        mutate(V35 = dplyr::recode(V35, 
                                   `1` = labs[1], 
                                   `2` = labs[2],
                                   `3` = labs[3],
                                   `4` = labs[4],
                                   `5` = labs[5],
                                   `0` = labs[6])) %>%
        dplyr::select(V35,V1) %>%
  dplyr::mutate(id = 1:nrow(.)) %>%
  pivot_wider(id_cols = id, names_from = V1, values_from = V35)%>%
  dplyr::select(-id)

 non_response <- to_likert%>%
      filter_all(., any_vars(. == labs[6])) %>% 
   nrow()
 
 non_res_frq <- paste0(round(non_response/nrow(to_likert)*100,1), "%")
 
 
 df_lkt <- to_likert%>%
      filter_all(., any_vars(. != labs[6])) %>% 
      mutate_all(factor, levels = labs[-length(labs)] )%>%
      data.frame() %>%
      likert(items = . , nlevels = 5)

  pl <-  df_lkt %>% 
      plot(., type = "bar", text.size = 3.54, plot.percents = T, plot.percent.low = F, plot.percent.high = F, plot.percent.neutral = F) + 
    theme(text = element_text(size = 20), legend.title = element_blank())
  
    pl
    
    df_lkt$results %>% 
      dplyr::mutate_if(is.numeric, .funs = function(i)paste0(round(i), "%")) %>% 
      add_row(Item = "No response rate", "Strongly disagree" = non_res_frq , "Disagree"  = non_res_frq,  "Uncertain" = non_res_frq,  "Agree" = non_res_frq, "Strongly agree" = non_res_frq)  %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V35(Positive influence in company's business)", ".csv")) %>%
      flextable(.)
```

\pagebreak

## Confiança_impacto -V36

**A PPA influenciou positivamente as práticas socioambientais da minha empresa na Amazônia até o momento**

```{r v36, echo=FALSE,warning=FALSE,fig.width=8, fig.height=4,strip.white=FALSE}
labs <- c("Strongly disagree",
"Disagree",
"Uncertain",
"Agree",
"Strongly agree",
"No response")

 to_likert <- new_data$Percepcoes %>% 
        dplyr::mutate(ID = as.character(ID)) %>% 
        dplyr::inner_join(., groups, by = c("ID" = "ID")) %>%
        dplyr::select(ID, ID_ego, V36, V1) %>%
        mutate(V36 = dplyr::recode(V36, 
                                   `1` = labs[1], 
                                   `2` = labs[2],
                                   `3` = labs[3],
                                   `4` = labs[4],
                                   `5` = labs[5],
                                   `0` = labs[6])) %>%
        dplyr::select(V36,V1) %>%
  dplyr::mutate(id = 1:nrow(.)) %>%
  pivot_wider(id_cols = id, names_from = V1, values_from = V36)%>%
  dplyr::select(-id)

 non_response <- to_likert%>%
      filter_all(., any_vars(. == labs[6])) %>% 
   nrow()
 
 non_res_frq <- paste0(round(non_response/nrow(to_likert)*100,1), "%")
 
 
 df_lkt <- to_likert%>%
      filter_all(., any_vars(. != labs[6])) %>% 
      mutate_all(factor, levels = labs[-length(labs)] )%>%
      data.frame() %>%
      likert(items = . , nlevels = 5)

  pl <-  df_lkt %>% 
      plot(., type = "bar", text.size = 5, plot.percents = T, plot.percent.low = F, plot.percent.high = F, plot.percent.neutral = F) + 
    theme(text = element_text(size = 20), legend.title = element_blank())
  
    pl
    
    df_lkt$results %>% 
      dplyr::mutate_if(is.numeric, .funs = function(i)paste0(round(i), "%")) %>% 
      add_row(Item = "No response rate", "Strongly disagree" = non_res_frq , "Disagree"  = non_res_frq,  "Uncertain" = non_res_frq,  "Agree" = non_res_frq, "Strongly agree" = non_res_frq)  %T>%
  write_csv(., paste0(tbl_questions, "pregunta_V36(Positive influence in company's socioenvironmental practices)", ".csv")) %>%
      flextable(.)
```

\pagebreak

## Confiança  - sipder graph

```{r v29_v36_spider, echo=FALSE,warning=FALSE,fig.width=10, fig.height=11,strip.white=FALSE}
vs <- paste0("V", 29:36)

 labs <- c( "Reliable governance to support investment",
              "Reliable management to participate",
              "Reliable space for business protagonism",
              "Promotes commitment to socioenvironmental sustainability",
              "Companies strongly committed to the PPA",
              "Company plays a leading role in PPA",
              "Positive influence in company's business",
              "Positive influence in company's socioenvironmental practices")
labs <- data.frame(var_name = vs, Q_lab = labs, stringsAsFactors = F)

n_res <- new_data$Percepcoes %>% 
  dplyr::mutate(ID = as.character(ID)) %>% 
  dplyr::inner_join(., groups, by = c("ID" = "ID")) %>%
  dplyr::select(ID, ID_ego, vs , V1) %>% 
  dplyr::mutate_if(., is.numeric, .funs = function(i){ifelse(i == 0 | i == 6, NA, i)}) %>% 
  pivot_longer(., cols = vs)

non_response <- n_res %>% 
  dplyr::filter(is.na(value)) %>% 
  nrow()

non_res_frq <- paste0(round(non_response/nrow(n_res)*100, 1), "%")

to_plot <- n_res %>% 
  drop_na() %>% 
  dplyr::mutate(value = if_else(value <= 3, 0, 1)) %>% 
  group_by(V1, name) %>%
  dplyr::summarise( summ = sum(value), cnt = n()) %>% 
  ungroup() %>% 
  dplyr::mutate(Frequency = summ/cnt)

to_plot%>% 
  pivot_wider(id_cols = V1, names_from = name, values_from = Frequency)%>% 
  as.data.frame() %>% 
  ggradar(., group.colours  = gr_colors$color[-4], group.line.width = 1,  group.point.size = 3, base.size = 20)


   to_plot %>% 
    dplyr::left_join(., labs, by = c("name" = "var_name")) %>% 
     dplyr::mutate(Frequency= paste0(round(Frequency*100), "%")) %>% 
     add_row(V1 = "No response", name = "No response rate", summ = non_response, Frequency = non_res_frq, Q_lab = name) %>% 
     dplyr::select("Group" = V1, "Question ID" = name, "Question statement" = Q_lab, Count = summ,  Frequency) %T>%
     write.csv(., paste0(tbl_questions, "perceptions_capPPA_V29_V36_spider", ".csv")) %>% 
     flextable(.)
    

```

\pagebreak

# Resultados da PPA

## Confiança_impacto -V37a Participation in the PPA had positive results

**A participação na PPA gerou resultados positivos para sua empresa até o momento? Quais**

```{r v37a, echo=FALSE,warning=FALSE,fig.width=7, fig.height=5,strip.white=FALSE}

labs <- c("No",
          "Yes",
          "Uncertain",
          "No response")


f<- new_data$Percepcoes %>% 
        dplyr::mutate(ID = as.character(ID)) %>% 
        dplyr::inner_join(., groups, by = c("ID" = "ID")) %>%
        dplyr::select(V37a, V1)%>%
        dplyr::mutate_all(as.character) %>% 
        dplyr::mutate(V37a = case_when(
         V37a == "0" ~ labs[1],
         V37a == "1" ~ labs[2],
         V37a == "2" ~ labs[3],
         V37a == "3" ~ labs[4],
         TRUE ~ NA_character_))
   
tots <- f %>% 
  dplyr::filter(!is.na(V37a) , V37a != "No response") %>% 
  group_by(V1) %>% 
  tally()   


    v37 <-  f %>%
        dplyr::filter(!is.na(V37a) , V37a != "No response") %>% 
        group_by(V1, V37a) %>% 
        dplyr::summarise(Count = n()) %>% 
        dplyr::left_join(., tots ,by = c("V1" = "V1")) %>% 
        mutate(fr1 = round(Count/n*100)) 
    
    non_response <-  f %>%
        dplyr::filter(is.na(V37a) | V37a == "No response") %>% 
      nrow()
    
    non_res_frq <- paste0(round(non_response/nrow(f)*100), "%" )
      
    
    v37 %>%
        ggplot(aes(x = V1, y = fr1, fill = factor(V37a)))+
        geom_bar(stat= "identity")+
        geom_text(aes(label = paste0(fr1, "%")),
                 position = position_stack(vjust = .5), size = 3)+
        labs(x= "Group", y = "Frequency", title = "Question V37a - Participation in the PPA had positive results")+
        scale_y_continuous(limits=c(0,100), breaks= seq(0,100, by=10)) + 
        labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
        theme(legend.position="bottom", legend.title = element_blank())
     
    

     v37 %>%
       dplyr::mutate(fr1 = paste0(fr1, "%")) %>% 
       dplyr::mutate(freq = fr1 ) %>%
       dplyr::select(-fr1)%>%
       ungroup %>% 
       add_row(V1 = "No response", V37a = "No response rate", Count = non_response, freq = non_res_frq) %>% 
       dplyr::select(Group = V1, "Participation in the PPA had positive results" = V37a, Count  , Frequency = freq)%T>%
  write_csv(., paste0(tbl_questions, "pregunta_V37a(Participation in the PPA had positive results)", ".csv")) %>%
       flextable(.)
     
```

#### Soporte de interpretación 

El `r v37$fr1[2] ` de los miembros del grupo A manifiesta que han tenido resultados positivos al hacer parte integral de la plataforma, por otro lado un `r v37$fr1[1] ` de los miembros percibe que el pertenecer a la plataforma no les genera resultados negativos mientras que un `r v37$fr1[3] ` se mantiene imparcial o no sabe si ha obtenido resultados positivos.

Es interesante notar que para la totalidad de los miembros pertenecientes al grupo A2 (100%) perciben o manifiestan haber tenido resultados siempre positivos al pertenecer a la PPA.


\pagebreak

## Confiança_impacto -V38a Participation in the PPA had negative results

**A participação na PPA gerou resultados negativos para sua empresa até o momento? Quais?**

```{r v38a, echo=FALSE,warning=FALSE,fig.width=7, fig.height=5,strip.white=FALSE}
labs <- c("No",
          "Yes",
          "Uncertain",
          "No response")

f<- new_data$Percepcoes %>% 
       dplyr::mutate(ID = as.character(ID)) %>% 
       dplyr::inner_join(., groups, by = c("ID" = "ID")) %>%
       dplyr::select(V38a, V1) %>%
        dplyr::mutate_all(as.character) %>% 
        dplyr::mutate(V38a = case_when(
         V38a == "0" ~ labs[1],
         V38a == "1" ~ labs[2],
         V38a == "2" ~ labs[3],
         V38a == "3" ~ labs[4],
         TRUE ~ NA_character_))

  tots <- f %>% 
  dplyr::filter(!is.na(V38a) , V38a != "No response") %>% 
  group_by(V1) %>% 
  tally()   
 
  v38 <-  f %>%
        dplyr::filter(!is.na(V38a) , V38a != "No response") %>% 
        group_by(V1, V38a) %>% 
        dplyr::summarise(Count = n()) %>% 
        dplyr::left_join(., tots ,by = c("V1" = "V1")) %>% 
        mutate(fr1 = round(Count/n*100)) 
    
    non_response <-  f %>%
        dplyr::filter(is.na(V38a) | V38a == "No response") %>% 
      nrow()
    
    non_res_frq <- paste0(round(non_response/nrow(f)*100), "%" )
     
     v38 %>%
       ggplot(aes(x = V1, y = fr1, fill = factor(V38a)))+
        geom_bar(stat= "identity")+
        geom_text(aes(label = paste0(fr1, "%")),
                 position = position_stack(vjust = .5), size = 3)+
        labs(x= "Group", y = "Frequency", title = "Question V38a - Participation in the PPA had negative results")+
        scale_y_continuous(limits=c(0,100), breaks= seq(0,100, by=10)) + 
        labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
        theme(legend.position="bottom", legend.title = element_blank())
     
 v38 %>%
       dplyr::mutate(fr1 = paste0(fr1, "%")) %>% 
       dplyr::mutate(freq = fr1 ) %>%
       dplyr::select(-fr1)%>%
       ungroup %>% 
       add_row(V1 = "No response", V38a = "No response rate", Count = non_response, freq = non_res_frq) %>% 
       dplyr::select(Group = V1, "Participation in the PPA had negative results" = V38a, Count  , Frequency = freq) %T>%
       write_csv(., paste0(tbl_questions, "pregunta_V38a(Participation in the PPA had negative results)", ".csv")) %>% 
       flextable(.)
     
     
      
      
```

#### Soporte de interpretación

El 100% de los miembros del grupo A manifiesta que han No han tenido resultados negativos al hacer parte integral de la plataforma.

Es interesante notar que para la totalidad de los miembros pertenecientes al grupo A2 (100%) perciben o manifiestan NO haber tenido resultados negativos al pertenecer a la PPA. Sin embargo hay un 3% de los miembros del grupo B que si han tenido resultados negativos al hacer parte de la PPA.

Si tenemos en cuenta que para la pregunta V37a el grupo A hubo algunos miembros (`r v37$fr1[1] `) que no tuvieron o percibieron que el hacer parte de la PPA les haya generado algún tipo de beneficio, en esta pregunta observamos que no han obtenido tampoco resultados negativos por lo que se puede pensar que hay un factor que influye sobre…


\pagebreak


# Redes

La dinámica interna de PPA se capturará a través del número y la naturaleza de los miembros principales de PPA y la dinámica de integración de nuevos miembros en horas extras; las características de los lazos entre esos miembros de PPA y sus actividades. Se supervisará el capital de vinculación de PPA, la velocidad del flujo de información entre los miembros, la intensidad y la forma de cooperación entre los miembros (acción colectiva) y el cambio en los comportamientos y la narrativa de los miembros de PPA. El rol específico y las relaciones de los actores de apoyo también se evaluarán para capturar el grado de dependencia de las actividades de PPA con los actores de apoyo y el grado de autonomía de PPA.

\pagebreak

## Red de inversión

```{r redinvestimento, echo=FALSE,warning=FALSE, message = FALSE, cache = TRUE}


nt1 <- read_excel(xls.file, sheet = "R2_investimento")

d <- nt1 %>% 
  dplyr::select( R_Start_ID,  R_Destiny_ID, R2c, R2a, R2b) %>%
  dplyr::mutate(R2c = R2c+1, R2c = if_else(R2c == 7, 1, R2c)) %>%
  dplyr::mutate_all(as.character) 

d2 <- d %>% dplyr::mutate(start = case_when(
  R2b == "2" ~ R_Destiny_ID,
  TRUE ~ R_Start_ID 
),
end = case_when(
  R2b == "2" ~ R_Start_ID ,
  TRUE ~ R_Destiny_ID 
)) 
# duplicar e invertir las relacions recibio/aporto
dopler <- d2 %>% 
  dplyr::filter(R2b == "3") %>%
  dplyr::mutate(start =  R_Destiny_ID, 
                end = R_Start_ID) %>% 
  dplyr::select(start, end, R2c, R2a, R2b)
# adicionar filas duplicadas al edgelist
 d2 <- d2 %>% 
  bind_rows(., dopler) %>%
  dplyr::select(R_Start_ID = start, R_Destiny_ID = end, R2c, R2a, R2b)

 



 net <- graph_from_data_frame(d=  d,
                               vertices = groups %>% dplyr::select(ID, V1),
                               directed= T)%>%
  igraph::delete_vertices(., igraph::degree(.) == 0) %>% 
  igraph::delete_edges(., edges = which(igraph::which_multiple(.)))

 #save adjacency matrix
as_adjacency_matrix(net, type = "both", sparse = F) %>% 
  as.data.frame() %>% 
  write_csv(., path = paste0(tbl_pth, "adj_m_invst", ".csv"))



#contar egos
nt1 %>% 
  dplyr::mutate_all(as.character) %>%
  dplyr::left_join(., groups, by = c("R_Start_ID" = "ID")) %>%
  dplyr::mutate(dummy = paste0(R_Start_ID, R_Start_ID_ego)) %>% 
  dplyr::filter(!duplicated(dummy)) %>% 
  dplyr::group_by(V1, R_Start_ID_ego) %>% 
  tally() %>%
  dplyr::select(Groups = V1, Ego = R_Start_ID_ego, Ego_count = n) %>%
  ungroup() %>% 
  data.frame %T>% 
  write_csv(., path = paste0(tbl_pth, "invest_ego_descrip_by_gr", ".csv")) %>% 
  flextable(.)
  


```

\pagebreak

### Grupo A2

```{r rinvestgrA2, echo=FALSE,fig.width=15, fig.height=11,warning=FALSE,strip.white=FALSE}


a2 <- groups %>% filter(V1 == "A2") %>% pull(ID)

d2 <- d %>%  
  dplyr::mutate(col = case_when( R_Start_ID  %in% a2 ~ "orange", TRUE ~ "gray80"))

  net <- graph_from_data_frame(d=  d2,
                               vertices = groups %>% dplyr::select(ID, V1),
                               directed=F)%>%
  igraph::delete_vertices(., igraph::degree(.) == 0) %>% 
  igraph::delete_edges(., edges = which(igraph::which_multiple(.)))

edge.col <- E(net)$col


v.col <- groups %>% 
  dplyr::mutate(v.col = case_when(
    V1 == "A2" ~ "tomato",
    TRUE ~ "gray50"
  )) %>% 
  dplyr::filter(ID %in% V(net)$name) %>%
  pull(v.col)

par(bg = NA)
plot(net, 
     layout= layout_with_kk, 
     edge.arrow.size=0.5, 
     rescale=T,
     edge.color= edge.col,
     edge.width = 2.5,
     vertex.size = 6.5,
     vertex.shape = NULL,
     vertex.label.dist=0,
     vertex.label= V(net)$name,
     vertex.label.family = "Arial",
     vertex.label.font	= 2,
     vertex.label.cex = 0.9,
     vertex.label.dist = 150,
     vertex.label.degree = -pi/2,
     vertex.label.color="black",
     vertex.color = v.col,
     asp = 0)

legend("topright" , c("Group A","Group A2", "Group B"), 
       pch = c(21, 21, 21),
       col= c("black","black", "black", "black"), pt.bg= c("olivedrab3", "tomato", "gold"), 
       pt.cex=2, cex=.8, bty = "n",  title="GROUPS")

legend("bottomright", c( "A2 net", "Others Net"), lty = c(1,1), col = c("orange", "gray50"), lwd = c(3,3), pt.cex=2, cex=0.8, bty="n")

```

\pagebreak

### Grupo A

```{r rinvestgrA, echo=FALSE,fig.width=15, fig.height=11,warning=FALSE,strip.white=FALSE}

set.seed(123)

a2 <- groups %>% filter(V1 == "A") %>% pull(ID)

d2 <- d %>%  
  dplyr::mutate(col = case_when( R_Start_ID  %in% a2 ~ "orange", TRUE ~ "gray80"))

  net <- graph_from_data_frame(d =  d2,
                               vertices = groups %>% dplyr::select(ID, V1),
                               directed=F)%>%
  igraph::delete_vertices(., igraph::degree(.) == 0) %>% 
  igraph::delete_edges(., edges = which(igraph::which_multiple(.)))

edge.col <- E(net)$col

v.col <- groups %>% 
  dplyr::mutate(v.col = case_when(
    V1 == "A" ~ "olivedrab3",
    TRUE ~ "gray50"
  )) %>% 
  dplyr::filter(ID %in% V(net)$name) %>%
  pull(v.col)

par(bg = NA)
plot(net, 
     layout= layout_with_kk, 
     edge.arrow.size=0.5, 
     rescale=T,
     edge.color= edge.col,
     edge.width = 2.5,
     vertex.size = 6.5,
     vertex.shape = NULL,
     vertex.label.dist=0,
     vertex.label= V(net)$name,
     vertex.label.family = "Arial",
     vertex.label.font	= 2,
     vertex.label.cex = 0.9,
     vertex.label.dist = 150,
     vertex.label.degree = -pi/2,
     vertex.label.color="black",
     vertex.color = v.col,
     asp = 0)

legend("topright" , c("Group A","Group A2", "Group B"), 
       pch = c(21, 21, 21),
       col= c("black","black", "black", "black"), pt.bg= c("olivedrab3", "tomato", "gold"), 
       pt.cex=2, cex=.8, bty = "n",  title="GROUPS")

legend("bottomright", c( "A net", "Others Net"), lty = c(1,1), col = c("orange", "gray50"), lwd = c(3,3), pt.cex=2, cex=0.8, bty="n")

```

\pagebreak


### Grupo B

```{r rinvestgrB, echo=FALSE,fig.width=15, fig.height=11,warning=FALSE,strip.white=FALSE, cache = TRUE}

set.seed(123)

a2 <- groups %>% filter(V1 == "B") %>% pull(ID)

d2 <- d %>%  
  dplyr::mutate(col = case_when( R_Start_ID  %in% a2 ~ "orange", TRUE ~ "gray80"))

  net <- graph_from_data_frame(d =  d2,
                               vertices = groups %>% dplyr::select(ID, V1),
                               directed=F)%>%
  igraph::delete_vertices(., igraph::degree(.) == 0) %>% 
  igraph::delete_edges(., edges = which(igraph::which_multiple(.)))

  net_no_dir <- net
  
  #save adjacencyu matrix
  as_adjacency_matrix(net, type = "both", sparse = F) %>% 
  as.data.frame() %>%
    write_csv(., path = paste0(tbl_pth, "adj_m_invst_NoDir", ".csv"))
  
edge.col <- E(net)$col

v.col <- groups %>% 
  dplyr::mutate(v.col = case_when(
    V1 == "B" ~ "gold",
    TRUE ~ "gray50"
  )) %>% 
  dplyr::filter(ID %in% V(net)$name) %>%
  pull(v.col)

par(bg = NA)
plot(net, 
     layout= layout_with_kk, 
     edge.arrow.size=0.5, 
     rescale=T,
     edge.color= edge.col,
     edge.width = 2.5,
     vertex.size = 6.5,
     vertex.shape = NULL,
     vertex.label.dist=0,
     vertex.label= V(net)$name,
     vertex.label.family = "Arial",
     vertex.label.font	= 2,
     vertex.label.cex = 0.9,
     vertex.label.dist = 150,
     vertex.label.degree = -pi/2,
     vertex.label.color="black",
     vertex.color = v.col,
     asp = 0)

legend("topright" , c("Group A","Group A2", "Group B"), 
       pch = c(21, 21, 21),
       col= c("black","black", "black", "black"), pt.bg= c("olivedrab3", "tomato", "gold"), 
       pt.cex=2, cex=.8, bty = "n",  title="GROUPS")

legend("bottomright", c( "B Net", "Others Net"), lty = c(1,1), col = c("orange", "gray50"), lwd = c(3,3), pt.cex=2, cex=0.8, bty="n")

```

\pagebreak 

### Entrevistados red Investimento

```{r rinvest_entrev, echo=FALSE,fig.width=15, fig.height=11,warning=FALSE,strip.white=FALSE, cache = FALSE}

set.seed(123)

red <- "invest"

  net <- graph_from_data_frame(d =  d,
                               vertices = groups %>% dplyr::select(ID, V1),
                               directed=F)%>%
  igraph::delete_vertices(., igraph::degree(.) == 0) %>% 
  igraph::delete_edges(., edges = which(igraph::which_multiple(.)))

  
#cambiar color segun status
entrev_col <- entrevistados %>% 
  dplyr::mutate(v.col = case_when(
    status == "entrevistado" ~ "gold",
    TRUE ~ "royalblue3"
  )) %>% 
  dplyr::filter(ID %in% V(net)$name) 

par(bg = NA)
plot(net, 
     layout= layout_with_kk, 
     edge.arrow.size=0.5, 
     rescale=T,
     edge.color= "gray50",
     edge.width = 2.5,
     vertex.size = 6.5,
     vertex.shape = NULL,
     vertex.label.dist=0,
     vertex.label= V(net)$name,
     vertex.label.family = "Arial",
     vertex.label.font	= 2,
     vertex.label.cex = 0.9,
     vertex.label.dist = 150,
     vertex.label.degree = -pi/2,
     vertex.label.color="black",
     vertex.color = entrev_col$v.col,
     asp = 0)

legend("topleft" , c("Entrevistado","No entrevistado"), 
       pch = c(21, 21),
       col= c("gold","royalblue3"), pt.bg= c("gold", "royalblue3"), 
       pt.cex=2, cex=.8, bty = "n",  title="Status")


entrev_col %>% 
  dplyr::left_join(., groups) %>% 
  dplyr::select(Node = ID, status, Nome, Group = V1) %T>% 
   write_csv(., path = paste0(tbl_pth, "entrev_", red, ".csv")) %>% 
  flextable(.)

entrev_col %>% 
  dplyr::left_join(., groups) %>% 
  dplyr::group_by(V1, status) %>% 
  tally() %>% 
  dplyr::mutate(freq = round(n/sum(n)*100,1), Frequency = paste0(freq, "%")) %>% 
  dplyr::select(Group = V1, status, Count = n, Frequency) %T>%
  write_csv(., path = paste0(tbl_pth, "entrev_", red, "_freq_byGRoup", ".csv")) %>%
  flextable(.)

```

\pagebreak

### Tipo de tipo de organização

```{r rinvest_tipo_org, echo=FALSE,fig.width=15, fig.height=11,warning=FALSE,strip.white=FALSE, cache = FALSE}

set.seed(123)

red <- "invest"

  net <- graph_from_data_frame(d =  d,
                               vertices = groups %>% dplyr::select(ID, V1),
                               directed=F)%>%
  igraph::delete_vertices(., igraph::degree(.) == 0) %>% 
  igraph::delete_edges(., edges = which(igraph::which_multiple(.)))

  
  
  color_vec <- brewer.pal(4,"Set1")

#cambiar color segun status
  vtx_col <- type_org %>% 
  dplyr::mutate(v.col = case_when(
    V39a == "1" ~ color_vec[1],
    V39a == "2" ~ color_vec[2],
    V39a == "3" ~ color_vec[3],
    V39a == "4" ~ color_vec[4],
    TRUE ~ "gray70"
  )) %>% 
  dplyr::filter(ID %in% V(net)$name) 

  
par(bg = NA)
plot(net, 
     layout= layout_with_kk, 
     edge.arrow.size=0.5, 
     rescale=T,
     edge.color= "gray50",
     edge.width = 2.5,
     vertex.size = 6.5,
     vertex.shape = NULL,
     vertex.label.dist=0,
     vertex.label= V(net)$name,
     vertex.label.family = "Arial",
     vertex.label.font	= 2,
     vertex.label.cex = 0.9,
     vertex.label.dist = 150,
     vertex.label.degree = -pi/2,
     vertex.label.color="black",
     vertex.color = vtx_col$v.col,
     asp = 0)

legend("topleft" , unique(vtx_col$V39a_lab) , 
       pch = c(21, 21),
       col=  unique(vtx_col$v.col), pt.bg= unique(vtx_col$v.col), 
       pt.cex=2, cex=.8, bty = "n",  title="Tipo de organização")


vtx_col %T>% 
   write_csv(., path = paste0(tbl_pth, "type_org_", red, ".csv")) %>% 
  flextable(.)

vtx_col %>% 
  dplyr::group_by(V1, V39a_lab) %>% 
  tally() %>% 
  dplyr::mutate(freq = round(n/sum(n)*100,1), Frequency = paste0(freq, "%")) %>% 
  dplyr::select(Group = V1, Type_V39a = V39a_lab, Count = n, Frequency) %T>%
  write_csv(., path = paste0(tbl_pth, "type_org_", red, "_V39a_byGRoup", ".csv")) %>%
  flextable(.)

vtx_col %>% 
  dplyr::group_by(V1, V39b_lab) %>% 
  tally() %>% 
  dplyr::mutate(freq = round(n/sum(n)*100,1), Frequency = paste0(freq, "%")) %>% 
  dplyr::select(Group = V1, Type_v39b = V39b_lab, Count = n, Frequency) %T>%
  write_csv(., path = paste0(tbl_pth, "type_org_", red, "_V39b_byGRoup", ".csv")) %>%
  flextable(.)

```

\pagebreak

### Entrevistado y Tipo de organização

```{r rinvest_entre_tipo_org, echo=FALSE,fig.width=15, fig.height=11,warning=FALSE,strip.white=FALSE, cache = FALSE}

set.seed(123)

red <- "invest"

  net <- graph_from_data_frame(d =  d,
                               vertices = groups %>% dplyr::select(ID, V1),
                               directed=F)%>%
  igraph::delete_vertices(., igraph::degree(.) == 0) %>% 
  igraph::delete_edges(., edges = which(igraph::which_multiple(.)))

  
 
 color_vec <- brewer.pal(4,"Set1")
#cambiar color segun status
  vtx_col <- type_org %>% 
  dplyr::mutate(v.col = case_when(
    V39a == "1" ~ color_vec[1],
    V39a == "2" ~ color_vec[2],
    V39a == "3" ~ color_vec[3],
    V39a == "4" ~ color_vec[4],
    TRUE ~ "gray70"
  )) %>% 
  dplyr::filter(ID %in% V(net)$name) 

  
  entrev_col <- entrevistados %>% 
  dplyr::mutate(v.shp = case_when(
    status == "entrevistado" ~ "circle",
    TRUE ~ "square"
  )) %>% 
  dplyr::filter(ID %in% V(net)$name) 

  
par(bg = NA)
plot(net, 
     layout= layout_with_kk, 
     edge.arrow.size=0.5, 
     rescale=T,
     edge.color= "gray50",
     edge.width = 2.5,
     vertex.size = 6.5,
     vertex.shape = entrev_col$v.shp,
     vertex.label.dist=0,
     vertex.label= V(net)$name,
     vertex.label.family = "Arial",
     vertex.label.font	= 2,
     vertex.label.cex = 0.9,
     vertex.label.dist = 150,
     vertex.label.degree = -pi/2,
     vertex.label.color="black",
     vertex.color = vtx_col$v.col,
     asp = 0)

legend("topleft" , unique(vtx_col$V39a_lab) , 
       pch = rep(21, length(unique(vtx_col$V39a_lab))),
       col=  unique(vtx_col$v.col), pt.bg= unique(vtx_col$v.col), 
       pt.cex=2, cex=.8, bty = "n",  title="Tipo de organização")

legend("bottomleft" , c("No entrevistados", "Entrevistados") , 
       pch = c(22, 21),
       col=  c("black", "black"), pt.bg= c("black", "black"), 
       pt.cex=2, cex=.8, bty = "n",  title="Status")

vtx_col %>%
  left_join(., entrev_col, by = c("ID" = "ID"),  suffix = c("", ".to_remove")) %>%
  dplyr::select(-contains("to_remove")) %>% 
  dplyr::select(Group = ID, V39a:V39b_lab, status) %T>% 
   write_csv(., path = paste0(tbl_pth, "entrev_type_org_", red, ".csv")) %>% 
  flextable(.)

vtx_col %>%
  left_join(., entrev_col, by = c("ID" = "ID"),  suffix = c("", ".to_remove")) %>%
  dplyr::select(-contains("to_remove")) %>% 
  dplyr::select(Group = ID, V39a:V39b_lab, status) %>%  
  dplyr::group_by(V1,  status, V39a_lab) %>% 
  tally() %>% 
  dplyr::mutate(freq = round(n/sum(n)*100,1), Frequency = paste0(freq, "%")) %>% 
  dplyr::select(Group = V1, status, Type_V39a = V39a_lab, Count = n, Frequency) %T>%
  write_csv(., path = paste0(tbl_pth, "entrev_type_org_", red, "_byGR", ".csv")) %>%
  flextable(.)



```


\pagrebreak 


### Red Investimento (Tipo de nodo/Sin egos)

```{r rinvestshp, echo=FALSE,fig.width=15, fig.height=11,warning=FALSE,strip.white=FALSE, cache = TRUE}

set.seed(123)
#  reordenar interaccion de acuerdo a R2b (recibio, aporto, etc...)
d2 <- d %>% dplyr::mutate(start = case_when(
  R2b == "2" ~ R_Destiny_ID,
  TRUE ~ R_Start_ID 
),
end = case_when(
  R2b == "2" ~ R_Start_ID ,
  TRUE ~ R_Destiny_ID 
)) 
# duplicar e invertir las relacions recibio/aporto
dopler <- d2 %>% 
  dplyr::filter(R2b == "3") %>%
  dplyr::mutate(start =  R_Destiny_ID, 
                end = R_Start_ID) %>% 
  dplyr::select(start, end, R2c, R2a, R2b)
# adicionar filas duplicadas al edgelist
 d2 <- d2 %>% 
  bind_rows(., dopler) %>%
  dplyr::select(R_Start_ID = start, R_Destiny_ID = end, R2c, R2a, R2b)

 
  net <- graph_from_data_frame(d=  d2,
                               vertices = groups %>% dplyr::select(ID, V1),
                               directed=T)%>%
  igraph::delete_vertices(., igraph::degree(.) == 0) %>% 
  igraph::delete_edges(., edges = which(igraph::which_multiple(.)))
  
  net_directed <- net
  
  #save adjacencyu matrix
  as_adjacency_matrix(net, type = "both", sparse = F) %>% 
  as.data.frame() %>% 
     write_csv(., path = paste0(tbl_pth, "adj_m_invst_dir", ".csv"))
  
  

vtx_shp <- tibble(nodos = character(0), shp = character(0)) %>% 
  add_row(nodos = intersect(d2$R_Start_ID, d2$R_Destiny_ID), shp = "both") %>%
  add_row(nodos = setdiff(d2$R_Start_ID, d2$R_Destiny_ID), shp = "reporter") %>%
  add_row(nodos = setdiff(d2$R_Destiny_ID, d2$R_Start_ID), shp = "partner") %>%
  right_join(., tibble(vtx = V(net)$name), by = c("nodos" = "vtx") ) %>% 
  dplyr::mutate( shape = dplyr::case_when(
                   shp == "both" ~ "circle",
                   shp == "partner" ~ "triangle",
                   shp == "reporter" ~ "square"))

colrs <- c("olivedrab3", "tomato", "gold", "gray40")
V(net)$color <- colrs[as.numeric(as.factor(V(net)$V1))]



igraph::add_shape("triangle", clip=igraph::shapes("circle")$clip,
                 plot=mytriangle)
par(bg = NA)
plot(net, 
     layout= layout_with_kk, 
     edge.arrow.size=0.8, 
     rescale=T,
     edge.color= "gray70",
     edge.width = 2.5,
     vertex.size = 6.5,
     vertex.label.dist=0,
     vertex.shape = vtx_shp$shape,
     vertex.label= V(net)$name,
     vertex.label.family = "Arial",
     vertex.label.font	= 2,
     vertex.label.cex = 0.9,
     vertex.label.dist = 150,
     vertex.label.degree = -pi/2,
     vertex.label.color="black",
     asp = 0)

legend("topright" , c("Group A","Group A2", "Group B", "Group C"), 
       pch = c(21, 21, 21, 21),
       col= c("black","black", "black", "black"), pt.bg= colrs, 
       pt.cex=2, cex=.8, bty = "n",  title="GROUPS")

legend("bottomright", c( "Reporter", "Partner", "Both"), col = c("black", "black", "black"), pch = c(15, 17, 16),  pt.cex=2, cex=0.8, bty="n", title = "shape")

#conteo de tipo de nodo por cada gruppo
vtx_shp %>% 
  left_join(., groups, by = c("nodos" = "ID") ) %>% 
  group_by( shp) %>%
  tally() %>%
  dplyr::mutate(freq = round(n/sum(n), 2), frq = paste0(round(freq*100,1), "%")) %>% 
  dplyr::select(Type = shp, Count = n, Frequency = frq) %>% 
  data.frame() %>% 
   flextable(.)

#### conteo rol de cada empresa dentro de la PPA

jf <- d2 %>% 
  dplyr::left_join(., groups , by = c("R_Start_ID" = "ID")) %>% 
  select(-Nome, V1_St = V1) %>% 
   dplyr::left_join(., groups , by = c("R_Destiny_ID" = "ID")) %>% 
  select(-Nome, V1_end = V1) 
  
salen <- jf %>% 
  filter(R_Start_ID %in% intersect(d2$R_Start_ID, d2$R_Destiny_ID) | 
           R_Destiny_ID %in% intersect(d2$R_Start_ID, d2$R_Destiny_ID)) %>% 
  group_by( V1_St) %>%
  dplyr::summarise(salen = n())

entran <- jf %>% 
  filter(R_Start_ID %in% intersect(d2$R_Start_ID, d2$R_Destiny_ID) | 
           R_Destiny_ID %in% intersect(d2$R_Start_ID, d2$R_Destiny_ID)) %>% 
  group_by(V1_end) %>% 
  dplyr::count(V1_end, name = "entran") 
 
left_join(salen, entran, by = c("V1_St" = "V1_end")) %>% 
  mutate(tot = sum(salen, entran, na.rm = T), 
         salen_frq = paste0(round(salen/tot*100,0), "%"),  
         entran_feq = paste0(round(entran/tot*100,0), "%")) 
  
 

  
#contar nodos dentro por R2a (In ppa and Out PPA)
vtx_shp %>% 
  left_join(., groups, by = c("nodos" = "ID") ) %>% 
  group_by( V1, shp) %>%
  tally() %>%
  dplyr::mutate(freq = round(n/sum(n), 2), frq = paste0(freq*100, "%")) %>%
  ungroup() %>% 
  reshape::rename(., c("shp" = "category", "V1" = "Group" , "n" = "Count", "freq" = "freq_rel", "frq" = "Frequency")) %>%
  data.frame()  %T>% 
   write_csv(., path = paste0(tbl_pth, "invest_gr_degree_type", ".csv")) %>% 
  flextable(.)

#contar los links para cada nodo según el grupo
as_tibble(ends(net, E(net), names = T)) %>% 
  dplyr::select("start" = V1, "end" = V2) %>% 
  left_join(., groups, by = c("start" = "ID")) %>% 
  dplyr::select( ID_start = V1, everything()) %>% 
  dplyr::left_join(., groups, by = c("end"= "ID")) %>% 
  dplyr::select(start, end,  ID_start,ID_end = V1, everything()) %>% 
  group_by(ID_start, ID_end) %>% 
  tally() %>%
  ungroup() %>%
  dplyr::mutate(Ratio = paste(round(n/sum(n)*100,1), "%")) %>% 
   dplyr::select(Group_start = ID_start, Group_end = ID_end, Links_count = n, Ratio) %T>% 
  write_csv(.,  path = paste0(tbl_pth, paste0("invest_node_links_count", ".csv"))) %>%
  flextable(.)
  


```


\pagebreak

#### Degree análisis

```{r rinvestDegSum, echo=FALSE,fig.width=15, fig.height=11,warning=FALSE,strip.white=FALSE}

summ_deg <- tibble(ID = V(net)$name ,
       type    = vtx_shp$shp,
       group   = V(net)$V1,
       in_deg  = igraph::degree(net, mode = 'in'), 
       out_deg = igraph::degree(net, mode = 'out'), 
       all     = igraph::degree(net, mode = 'total') ) %>% 
  dplyr::mutate(in_deg_frq  = round(in_deg/all,3)*100,
                out_deg_frq = round(out_deg/all,3)*100) %>% 
  dplyr::left_join(., groups %>% dplyr::select(ID, Nome) , by = ("ID" = "ID"))

summ_deg %>% 
  dplyr::filter(type == "both") %>%
  dplyr::group_by(group) %>%
  dplyr::summarise(sum_in_deg   = sum(in_deg),
            sum_out_deg  = sum(out_deg),
            sum_all      = sum(all)) %>%
  dplyr::mutate(in_deg_frq  = round(sum_in_deg/sum_all,3)*100,
                out_deg_frq = round(sum_out_deg/sum_all,3)*100) %>% 
  pivot_longer(cols = in_deg_frq:out_deg_frq) %>%
  ggplot(aes(x = group, y = value, fill = name))+
  geom_bar( stat = "identity")+
  geom_text(aes(label = paste0(value, "%")),
                 position = position_stack(vjust = .5), size = 7)+
  labs(x= "Group", y = "Frequency", title = "Degree Composition (Aporto/recebeu)")+
        scale_fill_discrete(name = "",  labels = c("In", "Out"))+
        labs(caption = "ALLIANCE BIOVERSITY CIAT - IPAM- CALPP")+
  theme(aspect.ratio = 0.6)+
  theme_light()+
  theme(legend.position="right", title = element_text(size=25),
        axis.text = element_text(size=25),
        legend.text = element_text(size=20),
        legend.title = element_text(size=25))

 summ_deg %>% 
  data.frame()  %T>% 
     write_csv(., path = paste0(tbl_pth, "invest_degree_analy", ".csv"))  %>%
    flextable(.)

```

\pagebreak

### Nueva red de inversión teniendo en cuenta a R2a (DIRECCION 1,2,3)

```{r rinvestINPPAneW_123, echo=FALSE,fig.width=13, fig.height=11,warning=FALSE,strip.white=FALSE, cache = FALSE, dpi = 300}
nt1 <- read_excel(xls.file, sheet = "R2_investimento") %>% 
  dplyr::filter( !(R_Start_ID == 27 & R_Start_ID_ego == "a" & R_Destiny_ID == 38 &   R2b == 6)) %>% 
  dplyr::filter( !(R_Start_ID == 27 & R_Start_ID_ego == "a" & R_Destiny_ID == 59 &   R2b == 6))


dups <- nt1 %>% 
  dplyr::mutate(id = paste0(R_Start_ID, "-", R_Destiny_ID)) %>% 
  dplyr::mutate(dup = duplicated(id)) %>% 
  dplyr::filter(dup) %>%  pull(id)

#remover duplicados
nt1 <- nt1 %>% 
  dplyr::mutate(id = paste0(R_Start_ID, "-", R_Destiny_ID)) %>% 
  dplyr::mutate(dup = id %in% dups) %>% 
  dplyr::mutate(no_remove = if_else( (dup & R_Start_ID == 42 & R_Start_ID_ego == "b") | 
                                       (dup & R_Start_ID == 49 & R_Start_ID_ego == "c") |
                                       (dup & R_Start_ID == 76 & R_Start_ID_ego == "b"), TRUE, FALSE)) %>% 
  dplyr::filter( !(dup & !no_remove) ) %>% 
  dplyr::select(-id, -dup, -no_remove) 

#calcular non response rate
non_response <-  nt1 %>% 
  dplyr::select( R_Start_ID,  R_Destiny_ID, R2c, R2a, R2b) %>%
  dplyr::filter(R2b == 9) %>% 
  nrow()

non_res_frq <- paste0(round(non_response/nrow(nt1)*100), "%")

d2 <- nt1 %>% 
  dplyr::select( R_Start_ID,  R_Destiny_ID, R2c, R2a, R2b) %>%
  dplyr::filter(R2b != 9) %>% 
  dplyr::mutate(R2c = R2c+1, R2c = if_else(R2c == 7, 1, R2c)) %>%
  dplyr::mutate_all(as.character) %>%
  dplyr::mutate(start = case_when(
  R2b == "2" ~ R_Destiny_ID,
  TRUE ~ R_Start_ID 
),
end = case_when(
  R2b == "2" ~ R_Start_ID ,
  TRUE ~ R_Destiny_ID 
)) 

# duplicar e invertir las relacions recibio/aporto
dopler <- d2 %>% 
  dplyr::filter(R2b == "3") %>%
  dplyr::mutate(start =  R_Destiny_ID, 
                end = R_Start_ID) %>% 
  dplyr::select(start, end, R2c, R2a, R2b)
# adicionar filas duplicadas al edgelist
 d2 <- d2 %>% 
  bind_rows(., dopler) %>%
  dplyr::select(R_Start_ID = start, R_Destiny_ID = end, R2c, R2a, R2b, R2b) %>% 
  dplyr::filter(R2b %in% c("1", "2" , "3")) 
   

  net <- graph_from_data_frame(d=  d2,
                               vertices = groups %>% dplyr::select(ID, V1),
                               directed=T)%>%
  igraph::delete_vertices(., igraph::degree(.) == 0) %>% 
  igraph::delete_edges(., edges = which(igraph::which_multiple(.)))
  
 
vtx_shp <- tibble(nodos = character(0), shp = character(0)) %>% 
  add_row(nodos = intersect(d2$R_Start_ID, d2$R_Destiny_ID), shp = "Intermediary") %>%
  add_row(nodos = setdiff(d2$R_Start_ID, d2$R_Destiny_ID), shp = "Investor") %>%
  add_row(nodos = setdiff(d2$R_Destiny_ID, d2$R_Start_ID), shp = "Recipient") %>%
  right_join(., tibble(vtx = V(net)$name), by = c("nodos" = "vtx") ) %>% 
  dplyr::mutate( shape = dplyr::case_when(
                   shp == "Intermediary" ~ "circle",
                   shp == "Recipient" ~ "triangle",
                   shp == "Investor" ~ "square"))

V(net)$color <- tibble(id = V(net)$name) %>% 
  dplyr::left_join(., groups, by = c("id" = "ID") ) %>% 
  dplyr::left_join(., gr_colors, by = c("V1" = "V1")) %>% 
  pull(color)

igraph::add_shape("triangle", clip=igraph::shapes("circle")$clip,
                 plot=mytriangle)

edge.col <- tibble(var = E(net)$R2a) %>% 
  dplyr::mutate(col = dplyr::recode(var,  "0" = "gray48", "1" =  "darkgreen",  "2" = "seashell1", "3" =  "seashell3" )) %>% pull(col) 
  

igraph::add_shape("triangle", clip=igraph::shapes("circle")$clip,
                 plot=mytriangle)

par(bg = NA)
plot(net, 
     layout= layout_with_kk, 
     edge.arrow.size=0.8, 
     rescale= TRUE,
     edge.color= edge.col,
     edge.width = 2.2,
     vertex.size = 6.5,
     vertex.shape = vtx_shp$shape,
     vertex.label.dist=0,
     vertex.label= V(net)$name,
     vertex.label.family = "Arial",
     vertex.label.font	= 2,
     vertex.label.cex = 0.90,
     vertex.label.dist = 150,
     vertex.label.degree = -pi/2,
     vertex.label.color="black",
     asp = 0)

gr_labs <- gr_colors %>% 
 dplyr::filter(V1 != "0") %>% 
  mutate(lab = paste("Grupo", V1)) %>% 
  select(color, lab)

legend("topleft" , c("PPA members", "Executive Coordination (in 2019)", "PPA partners and collaborators") , pch = c(21, 21, 21),
       col= c("black","black", "black"), pt.bg= c(gr_labs$color[-4]), pt.cex=2, cex=.8, bty = "n",  title="GROUPS")

legend("left", c("Investor", "Recipient", "Intemediary"), title = "FUNCTION", pt.bg =  c("black", "black", "black"), pch = c(15, 17, 16), col = c( "black", "black", "black") , pt.cex=2, cex=.8, bty = "n")

legend("bottomleft", c( "In the PPA", "Outside the PPA"), lty = c(1,1), col = c("darkgreen", "gray48"), lwd = c(3,3,3), pt.cex=2, cex=0.8, bty="n", title = "CONTEXT OF THE RELATION")

#conteo de shpe de los nodos por cada grupo

vtx_shp %>% 
  left_join(., groups, by = c("nodos" = "ID") ) %>% 
  group_by( shp) %>%
  tally() %>%
  dplyr::mutate(freq = round(n/sum(n), 2), frq = paste0(round(freq*100,1), "%")) %>% 
  dplyr::select(Type = shp, Count = n, Frequency = frq) %>%
  add_row(Type = "Not avaliable rate", Count = non_response, Frequency = non_res_frq) %>% 
  data.frame() %>% 
  write_csv(., path = paste0(tbl_pth, "invest_123_shape_freq", ".csv"))

vtx_shp %>% 
  left_join(., groups, by = c("nodos" = "ID") ) %>% 
  group_by( V1, shp) %>%
  tally() %>%
  dplyr::mutate(freq = round(n/sum(n), 2), frq = paste0(freq*100, "%")) %>%
  ungroup() %>%
  add_row(V1 = "Not avaliable", shp = "Not avaliable rate", n = non_response, frq = non_res_frq) %>% 
  reshape::rename(., c("shp" = "category", "V1" = "Group" , "n" = "Count", "frq" = "Frequency")) %>%
  data.frame()  %T>% 
   write_csv(., path = paste0(tbl_pth, "invest_123_shape_by_gr", ".csv"))


mtrs <- tibble(start = ends(net, es = E(net))[,1], 
               end = ends(net, es = E(net))[,2],
               R2b = E(net)$R2b) %>% 
 left_join(., groups, by = c("start" = "ID") ) %>% 
 left_join(., vtx_shp, by = c("start" = "nodos"))

# add partnes to data frame
mtrs_partner <-  tibble(start = ends(net, es = E(net))[,1], 
                  end = ends(net, es = E(net))[,2],
                  R2b = E(net)$R2b) %>% 
  left_join(., groups, by = c("end" = "ID") ) %>% 
  left_join(., vtx_shp, by = c("end" = "nodos") ) %>% 
  filter(shp == "partner") 
 


mtrs %>% 
  bind_rows(mtrs_partner) %>%
  group_by(V1, R2b) %>% 
  tally() %>%
  dplyr::mutate(freq = n/sum(n), Frequency = paste0(round(freq*100,1), "%") ) %>% 
  dplyr::select(Group = V1, Intensity = R2b, Count = n, Frequency) %>% 
  ungroup() %>% 
   dplyr::mutate(Intensity  = case_when(
    Intensity  == "1" ~  "Invested",
    Intensity  == "2" ~ "Received investment",
    Intensity  == "3" ~ "Invested and received investment",
    TRUE ~ "Nao identificado"
  )) %>%
  add_row(Group = "Not avaliable", Intensity = "Not avaliable rate", Count = non_response, Frequency = non_res_frq ) %>% 
  dplyr::rename("Link type" = Intensity) %>% 
  write_csv(., path = paste0(tbl_pth, "invest_123_R2b_link_freq", ".csv"))


```


\pagebreak

### Nueva red de inversión (NO DIRECCION 1,2,3,4,5,6)

```{r rinvestINPPANew2_123456, echo=FALSE,fig.width=13, fig.height=11,warning=FALSE,strip.white=FALSE, cache = FALSE, dpi = 300}

nt1 <- read_excel(xls.file, sheet = "R2_investimento") %>% 
  dplyr::filter( !(R_Start_ID == 27 & R_Start_ID_ego == "a" & R_Destiny_ID == 38 &   R2b == 6)) %>% 
  dplyr::filter( !(R_Start_ID == 27 & R_Start_ID_ego == "a" & R_Destiny_ID == 59 &   R2b == 6)) 
 
dups <- nt1 %>% 
  dplyr::mutate(id = paste0(R_Start_ID, "-", R_Destiny_ID)) %>% 
  dplyr::mutate(dup = duplicated(id)) %>% 
  dplyr::filter(dup) %>%  pull(id)

nt1 <- nt1 %>% 
  dplyr::mutate(id = paste0(R_Start_ID, "-", R_Destiny_ID)) %>% 
  dplyr::mutate(dup = id %in% dups) %>% 
  dplyr::mutate(no_remove = if_else( (dup & R_Start_ID == 42 & R_Start_ID_ego == "b") | 
                                       (dup & R_Start_ID == 49 & R_Start_ID_ego == "c") |
                                       (dup & R_Start_ID == 76 & R_Start_ID_ego == "b"), TRUE, FALSE)) %>% 
  dplyr::filter( !(dup & !no_remove) ) %>% 
  dplyr::select(-id, -dup, -no_remove) 

# calcular non response rate para todas las preguntas
tot <-nt1 %>% 
  nrow()

non_res_Ra <- nt1 %>% 
  dplyr::filter(R2a == 2) %>% 
  nrow

non_res_Ra_frq <- paste0(round(non_res_Ra/tot*100), "%")

non_res_Rb <- nt1  %>% 
  dplyr::filter(R2b == 9)%>% 
  nrow

non_res_Rb_frq <- paste0(round(non_res_Rb/tot*100), "%")

non_res_Rc <- nt1 %>% 
  dplyr::filter(R2c == 9)%>% 
  nrow

non_res_Rc_frq <- paste0(round(non_res_Rc/tot*100), "%")

#### encontrar los duplicados y removerlos


d2 <- nt1 %>%
  dplyr::select( R_Start_ID,  R_Destiny_ID, R2c, R2a, R2b) %>%
  dplyr::filter(R2a != 2) %>%
  dplyr::filter(R2b != 9) %>% 
  dplyr::mutate(R2c = R2c+1, R2c = if_else(R2c == 7, 1, R2c)) %>%
  dplyr::mutate_all(as.character)
 
  net <- graph_from_data_frame(d=  d2,
                               vertices = groups %>% dplyr::select(ID, V1),
                               directed=T)%>%
  igraph::delete_vertices(., igraph::degree(.) == 0)
  
  net_no_dir <- graph_from_data_frame(d=  d2,
                               vertices = groups %>% dplyr::select(ID, V1),
                               directed=F)%>%
  igraph::delete_vertices(., igraph::degree(.) == 0)
  #%>% 
  #igraph::delete_edges(., edges = which(igraph::which_multiple(.)))
  

  
  #save adjacencyu matrix
  as_adjacency_matrix(net_no_dir, type = "both", sparse = F) %>% 
  as.data.frame() %>% 
     write_csv(., path = paste0(tbl_pth, "adj_m_invst_123456_Ndir", ".csv"))
  
  
v_color <- tibble(id = V(net)$name) %>% 
  dplyr::left_join(., groups, by = c("id" = "ID") ) %>% 
  dplyr::left_join(., gr_colors, by = c("V1" = "V1")) %>% 
  pull(color)

igraph::add_shape("triangle", clip=igraph::shapes("circle")$clip,
                 plot=mytriangle)

edge.col <- tibble(var = E(net)$R2b) %>% 
  dplyr::mutate(col = dplyr::recode(var,  "1" = "gray48", "2" =  "gray48",  "3" = "gray48", "4" =  "blue4", 
                                    "5" = "gray50", "6" = "green4" )) %>% 
  pull(col) 

ltype <- tibble(var = E(net)$R2b) %>% 
  dplyr::mutate(lty = if_else(var == "5", 2, 1)) %>% 
  pull(lty) 

par(bg = NA)
plot(net, 
     layout= layout_with_kk, 
     edge.arrow.size= 0, 
     rescale= TRUE,
     edge.color= edge.col,
     edge.width = 2.2,
     edge.lty = ltype, 
     vertex.size = 6.5,
     vertex.shape = NULL,
     vertex.label.dist=0,
     vertex.color = v_color,
     vertex.label= V(net)$name,
     vertex.label.family = "Arial",
     vertex.label.font	= 2,
     vertex.label.cex = 0.90,
     vertex.label.dist = 150,
     vertex.label.degree = -pi/2,
     vertex.label.color="black",
     asp = 0)

gr_labs <- gr_colors %>% 
 dplyr::filter(V1 != "0") %>% 
  mutate(lab = paste("Grupo", V1)) %>% 
  select(color, lab)

legend("topleft" , c("PPA members", "Executive Coordination (in 2019)", "PPA partners and collaborators") , pch = c(21, 21, 21, 15,15, 17, 16),
       col= c("black","black", "black"), pt.bg= c(gr_labs$color[-4]), pt.cex=2, cex=.8, bty = "n",  title="GRUPOS")

legend("bottomleft", c("In negociations", "contributed, Received, contribute and Received", "counterpart", "co-investment" ), lty = c(2,1, 1, 1), col = unique(edge.col), lwd = c(2,3,3,3), pt.cex=2, cex=0.8, bty="n", title = "INVESTMENT FLOW")

#metricas generales

tibble(Metric = c("density", "centraBetw", "centraDeg", "modularidad", "meanDegree", "transitiv", "assorta", "EigenValue"),
       Value  = c(igraph::edge_density(net_no_dir),
                  igraph::centralization.betweenness(net_no_dir)$centralization,
                  igraph::centralization.degree (net_no_dir, mode = "all")$centralization,
                  igraph:: cluster_walktrap(net_no_dir) %>% igraph::modularity(),
                  mean(igraph::degree(net_no_dir, mode="all", normalized = F)),
                  igraph::transitivity(net_no_dir),
                  igraph::assortativity.degree(net_no_dir, directed = F),
                  eigen_centrality(net_no_dir, directed = F)$value
       )) %>%
  dplyr::mutate_if(is.numeric, round, digits = 2) %>%
  data.frame()  %T>%
   write_csv(., path = paste0(tbl_pth, "invest_123456_gnrl_metrics_Ndir", ".csv"))  %>% 
flextable(.,  cwidth = 2)

#metricas por cada nodo
metrics <- tibble(nodes_id = V(net_no_dir)$name) %>% 
  dplyr::left_join(., groups, by = c("nodes_id" = "ID")) %>%
  dplyr::select(nodes_id, Nome,V1) %>%
  dplyr::mutate(degree         = igraph::degree(net_no_dir, mode="all", normalized = F),
                betwe          = igraph::betweenness(net_no_dir) %>% round(.,1),
                closeness      = igraph::closeness(net_no_dir, mode="all") %>% round(.,4),
                ClusWalk       = igraph:: cluster_walktrap(net_no_dir) %>% membership(),
                transitivLocal = igraph::transitivity(net_no_dir, type = "local")  %>% round(.,2),
                Eigen_centr    = igraph::eigen_centrality(net_no_dir, directed = T)$vector %>%  round(.,2)
  ) %>%
  dplyr::mutate( HClust         = dplyr::select(., degree, betwe, closeness, Eigen_centr ) %>% 
                   clustering(data =., k = 4, dist.method = "euclidean", scale.unit = T)) %>% 
  dplyr::left_join(., entrevistados, by = c("nodes_id"= "ID")) %>% 
  dplyr::left_join(., type_org %>% dplyr::select(ID, V39a_lab, V39b_lab), by = c("nodes_id"= "ID"))

metrics %>% 
  data.frame()  %T>% 
  write_csv(., path = paste0(tbl_pth, "invest_123456_all_metrics_Ndir", ".csv")) %>% 
  flextable(.)

metrics %>% 
  dplyr::group_by(HClust) %>% 
  dplyr::summarise_if(is.numeric, list(~mean(.),~sd(.))) %T>% 
  write_csv(., path = paste0(tbl_pth, "investement_123456_NDir_cluster_summary.csv")) %>% 
   flextable(.)

### R2a summary

summ <-  tibble(var = E(net)$R2a) %>%
  dplyr::mutate( start  = igraph::ends(net, es=E(net), names=T)[,1]) %>%
  left_join(., groups, by = c("start" = "ID"))%>%
  dplyr::mutate( var = case_when(
    var == "0" ~ "No",
    var == "1" ~ "Yes",
    var == "2" ~ "Do not know",
    TRUE ~ "Outro"
  ))

summ %>%
  dplyr::filter(var != "Do not know" ) %>% 
  group_by( V1, var) %>%
  tally()  %>% 
  dplyr::mutate(freq = round(n/sum(n),2)*100, freq = paste0(freq, "%") ) %>% 
   ungroup() %>% 
  add_row(V1 = "Do not know", var = "Do not know rate", n = non_res_Ra, freq = non_res_Ra_frq) %>% 
  dplyr::select(Group = V1, "Investment relation began in the PPA" = var, Count = n, Frequency = freq) %>%
  data.frame()  %T>% 
  write_csv(., path = paste0(tbl_pth, "invest_123456_R2a_summary", ".csv")) %>% 
  flextable(.) 

##### R2b summary


summ <-  tibble(var = E(net)$R2b) %>%
  dplyr::mutate( start  = igraph::ends(net, es=E(net), names=T)[,1]) %>%
  left_join(., groups, by = c("start" = "ID"))%>%
  dplyr::mutate( var = case_when(
    var  == "1" ~  "Invested",
    var  == "2" ~ "Received investment",
    var  == "3" ~ "Invested and received investment",
    var  == "4" ~ "Coinvestment in third party",
    var  == "5" ~ "In negociation",
    var  == "6" ~ "Matching investment",
    TRUE ~ "Not available"
  ))

summ %>%
  dplyr::filter(var != "Not available" ) %>% 
  group_by( V1, var) %>%
  tally()  %>% 
  dplyr::mutate(freq = round(n/sum(n),2)*100, freq = paste0(freq, "%") ) %>% 
   ungroup() %>% 
  add_row(V1 = "Do not know", var = "Do not know rate", n = non_res_Rb, freq = non_res_Rb_frq) %>% 
  dplyr::select(Group = V1, "Type of investment relation" = var, Count = n, Frequency = freq) %>%
  data.frame()  %T>% 
  write_csv(., path = paste0(tbl_pth, "invest_123456_R2b_summary", ".csv")) %>% 
  flextable(.)

##### R2c summary


summ <-  tibble(var = E(net)$R2c) %>%
  dplyr::mutate( start  = igraph::ends(net, es=E(net), names=T)[,1]) %>%
  left_join(., groups, by = c("start" = "ID"))%>%
  dplyr::mutate( var = case_when(
    var  == "1" ~  "Very low - R$ 100,000 or less",
    var  == "2" ~ "Low - R$ 101,000 to R$ 250,000",
    var  == "3" ~ "Medium - R$ 251,000 to R$ 500,000",
    var  == "4" ~ "High - R$ 501,000 to R$ 1 million",
    var  == "5" ~ "Very high - above R$ 1 million",
    var  == "6" ~ "In negociation",
    var  == "9" ~ "Not available",
    TRUE ~ "Not avaliable"
  ))

summ %>%
#  dplyr::filter(var != "Not available" ) %>% 
  group_by( V1, var) %>%
  tally()  %>% 
  #dplyr::mutate(freq = round(n/sum(n),2)*100, freq = paste0(freq, "%") ) %>% 
   ungroup() %>% 
  #add_row(V1 = "Data not available", var = "Data not available rate", n = non_res_Rc, freq = non_res_Rc_frq) %>% 
  dplyr::select(Group = V1, "Intensity of investment relation" = var, Count = n) %>%
  data.frame()  %T>% 
  write_csv(., path = paste0(tbl_pth, "invest_123456_R2c_summary", ".csv")) %>% 
  flextable(.) 


#### R2a vs R2b


summ <-  tibble(var = E(net)$R2a, var2 = E(net)$R2b) %>%
  dplyr::mutate( start  = igraph::ends(net, es=E(net), names=T)[,1]) %>%
   dplyr::filter(var != 2) %>%
  dplyr::filter(var2 != 9) %>% 
  left_join(., groups, by = c("start" = "ID"))%>%
  dplyr::mutate( var = case_when(
    var == "0" ~ "No",
    var == "1" ~ "Yes",
    var == "2" ~ "Do not know",
    TRUE ~ "Not avaliable"
  ), var2 = case_when(
    var2  == "1" ~  "Invested",
    var2  == "2" ~ "Received investment",
    var2  == "3" ~ "Invested and received investment",
    var2  == "4" ~ "Coinvestment in third party",
    var2  == "5" ~ "In negociation",
    var2  == "6" ~ "Matching investment",
    TRUE ~ "Not avaliable"
  ))


non_response<- nt1 %>%
  dplyr::select( R_Start_ID,  R_Destiny_ID, R2c, R2a, R2b, R2b) %>%
  dplyr::filter(R2a == 2 | R2b == 9) %>%
  nrow
non_res_frq <- paste0(round(non_response/nrow(nt1)*100), "%")

summ %>%  
  group_by( V1, var, var2) %>%
  tally()  %>% 
  ungroup() %>% 
  add_row(V1 = "No response count", var = "No response count", var2 = var , n = non_response) %>% 
  dplyr::select(Group = V1, "Investment relation began in the PPA" = var,
                "Type of investment relation" = var2, Count = n) %>%
  data.frame()  %T>% 
  write_csv(., path = paste0(tbl_pth, "invest_123456_R2a_R2b_summary", ".csv")) %>% 
  flextable(.) 


#### R2a vs R2c

summ <-  tibble(var = E(net)$R2a, var2 = E(net)$R2c) %>%
  dplyr::mutate( start  = igraph::ends(net, es=E(net), names=T)[,1]) %>%
  left_join(., groups, by = c("start" = "ID"))%>%
  dplyr::mutate( var = case_when(
    var == "0" ~ "No",
    var == "1" ~ "Yes",
    var == "2" ~ "Do not know",
    TRUE ~ "Not available"
  ), var2 = case_when(
    var2  == "1" ~  "Very low - R$ 100,000 or less",
    var2  == "2" ~ "Low - R$ 101,000 to R$ 250,000",
    var2  == "3" ~ "Medium - R$ 251,000 to R$ 500,000",
    var2  == "4" ~ "High - R$ 501,000 to R$ 1 million",
    var2  == "5" ~ "Very high - above R$ 1 million",
    var2  == "6" ~ "In negociation",
    var2  == "9" ~ "Not available",
    TRUE ~ "Not available"
  ))


# non_response<- nt1 %>%
#   dplyr::select( R_Start_ID,  R_Destiny_ID, R2c, R2a, R2b, R2b) %>%
#   dplyr::filter(R2a == 2 | R2c == 9) %>%
#   nrow
# non_res_frq <- paste0(round(non_response/nrow(nt1)*100), "%")

summ %>%  
  group_by( V1, var, var2) %>%
  tally()  %>% 
  ungroup() %>% 
  #add_row(V1 = "No response count", var = "No response count", var2 = var , n = non_response) %>% 
  dplyr::select(Group = V1, "Investment relation began in the PPA" = var,
                "Intensity of investment relation" = var2, Count = n) %>%
  data.frame()  %T>% 
  write_csv(., path = paste0(tbl_pth, "invest_123456_R2a_R2c_summary", ".csv")) %>% 
  flextable(.) 



#contar los links para cada nodo según el grupo
as_tibble(ends(net, E(net), names = T)) %>% 
  dplyr::select(start = V1, end = V2) %>% 
  left_join(., groups, by = c("start" = "ID")) %>% 
  dplyr::select( ID_start = V1, everything()) %>% 
  dplyr::left_join(., groups, by = c("end"= "ID")) %>% 
  dplyr::select(start, end,  ID_start,ID_end = V1, everything()) %>% 
  group_by(ID_start, ID_end) %>% 
  tally() %>%
  ungroup() %>%
  dplyr::mutate(Ratio = paste(round(n/sum(n)*100,1), "%")) %>% 
  dplyr::select(Group_start = ID_start, Group_end = ID_end, Links_count = n, Ratio) %T>% 
  write_csv(.,  path = paste0(tbl_pth, paste0(red, "rinvest_123456_node_links_count", ".csv"))) %>%
  flextable(.)

# frecuencias por grupo y tipo de organizacion
tibble(ID = V(net)$name) %>% 
  left_join(., type_org, by = c("ID" = "ID"),  suffix = c("", ".to_remove")) %>%
  dplyr::group_by(V1, V39a_lab) %>% 
  tally() %>% 
  dplyr::select(Group = V1, "Type of organization" = V39a_lab, Count = n) %>%
  write_csv(., path = paste0(tbl_pth, "rinvest_123456_type_org_byGR", ".csv"))
 



```


\pagebreak

### Nueva red de inversión mas grupoC (NO DIRECCION 1,2,3,4,5,6)

```{r rinvestINPPANewGrC, echo=FALSE,fig.width=13, fig.height=11,warning=FALSE,strip.white=FALSE, cache = FALSE, dpi = 300}

nt1 <- read_excel(xls.file, sheet = "R2_investimento") %>% 
  dplyr::filter( !(R_Start_ID == 27 & R_Start_ID_ego == "a" & R_Destiny_ID == 38 &   R2b == 6)) %>% 
  dplyr::filter( !(R_Start_ID == 27 & R_Start_ID_ego == "a" & R_Destiny_ID == 59 &   R2b == 6)) 



dups <- nt1 %>% 
  dplyr::mutate(id = paste0(R_Start_ID, "-", R_Destiny_ID)) %>% 
  dplyr::mutate(dup = duplicated(id)) %>% 
  dplyr::filter(dup) %>%  pull(id)

nt1 <- nt1 %>% 
  dplyr::mutate(id = paste0(R_Start_ID, "-", R_Destiny_ID)) %>% 
  dplyr::mutate(dup = id %in% dups) %>% 
  dplyr::mutate(no_remove = if_else( (dup & R_Start_ID == 42 & R_Start_ID_ego == "b") | 
                                       (dup & R_Start_ID == 49 & R_Start_ID_ego == "c") |
                                       (dup & R_Start_ID == 76 & R_Start_ID_ego == "b"), TRUE, FALSE)) %>% 
  dplyr::filter( !(dup & !no_remove) ) %>% 
  dplyr::select(-id, -dup, -no_remove) 

d <- nt1 %>% 
  dplyr::select( R_Start_ID,  R_Destiny_ID, R2c, R2a, R2b, R2b) %>%
  dplyr::mutate(R2c = R2c+1, R2c = if_else(R2c == 7, 1, R2c)) %>%
  dplyr::mutate_all(as.character)



nt2 <- read_excel(xls.file, sheet = "R5_outras_org") %>%
  dplyr::select(R_Start_ID, R_Destiny_ID = R5b_Destiny_ID, R5c) %>% 
  drop_na() %>% 
  mutate_all(as.character) %>% 
  dplyr::filter(R5c == "2") %>% 
  dplyr::select( -R5c)

nt_all <- bind_rows(d, nt2) %>% 
  dplyr::mutate(R2b = if_else(is.na(R2b), "9", R2b))

 
  net <- graph_from_data_frame(d=  nt_all,
                               vertices = groups %>% dplyr::select(ID, V1),
                               directed=T)%>%
  igraph::delete_vertices(., igraph::degree(.) == 0)
  #%>% 
  #igraph::delete_edges(., edges = which(igraph::which_multiple(.)))
  
  net_no_dir <- graph_from_data_frame(d=  nt_all,
                               vertices = groups %>% dplyr::select(ID, V1),
                               directed=F)%>%
  igraph::delete_vertices(., igraph::degree(.) == 0)
  #%>% 
  #igraph::delete_edges(., edges = which(igraph::which_multiple(.)))
  
   #save adjacencyu matrix
  as_adjacency_matrix(net_no_dir, type = "both", sparse = F) %>% 
  as.data.frame() %>% 
     write_csv(., path = paste0(tbl_pth, "adj_m_invst_123456_Ndir_Grc", ".csv"))
  
  
 
v_color <- tibble(id = V(net)$name) %>% 
  dplyr::left_join(., groups, by = c("id" = "ID") ) %>% 
  dplyr::left_join(., gr_colors, by = c("V1" = "V1")) %>% 
  pull(color)

igraph::add_shape("triangle", clip=igraph::shapes("circle")$clip,
                 plot=mytriangle)

edge.col <- tibble(var = E(net)$R2b) %>% 
  dplyr::mutate(col = dplyr::recode(var,  "1" = "gray48", "2" =  "gray48",  "3" = "gray48", "4" =  "blue4", 
                                    "5" = "gray50", "6" = "green4", "9"  = "lavenderblush3" )) %>% 
  pull(col) 

ltype <- tibble(var = E(net)$R2b) %>% 
  dplyr::mutate(lty = if_else(var == "5", 2, 1)) %>% 
  pull(lty) 

par(bg = NA)
plot(net, 
     layout= layout_with_kk, 
     edge.arrow.size= 0, 
     rescale= TRUE,
     edge.color= edge.col,
     edge.width = 2.2,
     edge.lty = ltype,
     vertex.size = 6.5,
     vertex.shape = NULL,
     vertex.label.dist=0,
     vertex.color = v_color,
     vertex.label= V(net)$name,
     vertex.label.family = "Arial",
     vertex.label.font	= 2,
     vertex.label.cex = 0.90,
     vertex.label.dist = 150,
     vertex.label.degree = -pi/2,
     vertex.label.color="black",
     asp = 0)

gr_labs <- gr_colors %>% 
 dplyr::filter(V1 != "0") %>% 
  mutate(lab = paste("Grupo", V1)) %>% 
  select(color, lab)

legend("topleft" , c("PPA members", "Executive Coordination (in 2019)", "PPA partners and collaborators", "Actors in PPA's sphere of influence"), pch = c(21, 21, 21,21, 15,15, 17, 16),
       col= c("black","black", "black", "black"), pt.bg= c(gr_labs$color), pt.cex=2, cex=.8, bty = "n",  title="GROUPS")

legend("bottomleft", c("In negociations", "contributed, Received, contribute and Received", "counterpart", "co-investment", "Unanswered" ), lty = c(2,1, 1, 1, 1), col = unique(edge.col), lwd = c(2,3,3,3, 3), pt.cex=2, cex=0.8, bty="n", title = "INVESTMENT FLOW")


#metricas generales

tibble(Metric = c("density", "centraBetw", "centraDeg", "modularidad", "meanDegree", "transitiv", "assorta", "EigenValue"),
       Value  = c(igraph::edge_density(net_no_dir),
                  igraph::centralization.betweenness(net_no_dir)$centralization,
                  igraph::centralization.degree (net_no_dir, mode = "all")$centralization,
                  igraph:: cluster_walktrap(net_no_dir) %>% igraph::modularity(),
                  mean(igraph::degree(net_no_dir, mode="all", normalized = F)),
                  igraph::transitivity(net_no_dir),
                  igraph::assortativity.degree(net_no_dir, directed = F),
                  eigen_centrality(net_no_dir, directed = F)$value
       )) %>%
  dplyr::mutate_if(is.numeric, round, digits = 2) %>%
  data.frame()  %T>%
   write_csv(., path = paste0(tbl_pth, "invest_123456_gnrl_metrics_Grc", ".csv"))  %>% 
flextable(.,  cwidth = 2)

#metricas por cada nodo
metrics <- tibble(nodes_id = V(net_no_dir)$name) %>% 
  dplyr::left_join(., groups, by = c("nodes_id" = "ID")) %>%
  dplyr::select(nodes_id, Nome,V1) %>%
  dplyr::mutate(degree         = igraph::degree(net_no_dir, mode="all", normalized = F),
                betwe          = igraph::betweenness(net_no_dir) %>% round(.,1),
                closeness      = igraph::closeness(net_no_dir, mode="all") %>% round(.,4),
                ClusWalk       = igraph:: cluster_walktrap(net_no_dir) %>% membership(),
                transitivLocal = igraph::transitivity(net_no_dir, type = "local")  %>% round(.,2),
                Eigen_centr    = igraph::eigen_centrality(net_no_dir, directed = T)$vector %>%  round(.,2)
  ) %>%
  dplyr::mutate( HClust         = dplyr::select(., degree, betwe, closeness, Eigen_centr ) %>% 
                   clustering(data =., k = 4, dist.method = "euclidean", scale.unit = T)) %>% 
  dplyr::left_join(., entrevistados, by = c("nodes_id"= "ID")) %>% 
  dplyr::left_join(., type_org %>% dplyr::select(ID, V39a_lab, V39b_lab), by = c("nodes_id"= "ID"))

metrics %>% 
  data.frame()  %T>% 
  write_csv(., path = paste0(tbl_pth, "invest_123456_all_metrics_GrC", ".csv")) %>% 
  flextable(.)

metrics %>% 
  dplyr::group_by(HClust) %>% 
  dplyr::summarise_if(is.numeric, list(~mean(.),~sd(.))) %T>% 
  write_csv(., path = paste0(tbl_pth, "investement_123456_Dir_cluster_summary_Grc.csv")) %>% 
   flextable(.)


#contar los links para cada nodo según el grupo
as_tibble(ends(net, E(net), names = T)) %>% 
  dplyr::select(start = V1, end = V2) %>% 
  left_join(., groups, by = c("start" = "ID")) %>% 
  dplyr::select( ID_start = V1, everything()) %>% 
  dplyr::left_join(., groups, by = c("end"= "ID")) %>% 
  dplyr::select(start, end,  ID_start,ID_end = V1, everything()) %>% 
  group_by(ID_start, ID_end) %>% 
  tally() %>%
  ungroup() %>%
  dplyr::mutate(Ratio = paste(round(n/sum(n)*100,1), "%")) %>% 
  dplyr::select(Group_start = ID_start, Group_end = ID_end, Links_count = n) %T>% 
  write_csv(.,  path = paste0(tbl_pth, paste0("rinvest_123456_node_links_count_Grc", ".csv"))) %>%
  flextable(.)

# frecuencias por grupo y tipo de organizacion
tibble(ID = V(net)$name) %>% 
  left_join(., type_org, by = c("ID" = "ID"),  suffix = c("", ".to_remove")) %>%
  dplyr::group_by(V1, V39a_lab) %>% 
  tally() %>% 
  dplyr::select(Group = V1, "Type of organization" = V39a_lab, Count = n) %>%
  write_csv(., path = paste0(tbl_pth, "rinvest_123456_type_org_byGR_Grc", ".csv"))
 


```


\pagebreak

### Nueva Red cooperación técnica teniendo en cuenta a R3a (DIRECCION 1,2,3,4,5,6,7)

```{r rcoopshp, echo=FALSE,fig.width=15, fig.height=11,warning=FALSE,strip.white=FALSE, cache = TRUE, dpi = 300}

nt1 <- read_excel(xls.file, sheet = "R3_coop_técnica") %>%
  dplyr::filter(R_Start_ID != 25 & R_Destiny_ID != 25) %>% 
  dplyr::filter(R_Start_ID != 78 & R_Destiny_ID != 75)


dups <- nt1 %>% 
  dplyr::mutate(id = paste0(R_Start_ID, "-", R_Destiny_ID)) %>% 
  dplyr::mutate(dup = duplicated(id)) %>% 
  dplyr::filter(dup) %>%  pull(id)

#remover duplicados
nt1 <- nt1 %>% 
  dplyr::mutate(id = paste0(R_Start_ID, "-", R_Destiny_ID)) %>% 
  dplyr::mutate(dup = id %in% dups) %>% 
  dplyr::mutate(no_remove = if_else( (dup & R_Start_ID == 42 & R_Start_ID_ego == "b") | 
                                       (dup & R_Start_ID == 49 & R_Start_ID_ego == "c") |
                                       (dup & R_Start_ID == 76 & R_Start_ID_ego == "b"), TRUE, FALSE)) %>% 
  dplyr::filter( !(dup & !no_remove) ) %>% 
  dplyr::select(-id, -dup, -no_remove) 

#calcular non response rate
non_response <-  nt1 %>% 
  dplyr::select( R_Start_ID,  R_Destiny_ID, R3c, R3a, R3d) %>%
  dplyr::filter(R3a == 2 | R3d %in% c(8, 9)) %>% 
  nrow()

non_res_frq <- paste0(round(non_response/nrow(nt1)*100), "%")

# calcular non response rate para todas las preguntas
tot <-nt1 %>% 
  nrow()

non_res_Ra <- nt1 %>% 
  dplyr::filter(R3a == 2) %>% 
  nrow

non_res_Ra_frq <- paste0(round(non_res_Ra/tot*100), "%")

non_res_Rb <- nt1  %>% 
  dplyr::filter(R3d == 9)%>% 
  nrow

non_res_Rb_frq <- paste0(round(non_res_Rb/tot*100), "%")

non_res_Rc <- nt1 %>% 
  dplyr::filter(R3c == 9)%>% 
  nrow

non_res_Rc_frq <- paste0(round(non_res_Rc/tot*100), "%")


#  reordenar interaccion de acuerdo a R3d (recibio, aporto, etc...)
d2 <- nt1 %>% 
  dplyr::select( R_Start_ID,  R_Destiny_ID, R3c, R3a, R3d) %>%
  dplyr::filter(R3a != 2) %>%
  dplyr::filter( !R3d %in% c(9, 8)) %>% 
  dplyr::mutate(R3c = R3c+1, R3c = if_else(R3c == 7, 1, R3c)) %>%
  dplyr::mutate_all(as.character) %>%
  dplyr::mutate(start = case_when(
  R3d == "2" ~ R_Destiny_ID,
  TRUE ~ R_Start_ID 
),
end = case_when(
  R3d == "2" ~ R_Start_ID ,
  TRUE ~ R_Destiny_ID 
)) 
# duplicar e invertir las relacions recibio/aporto
dopler <- d2 %>% 
  dplyr::filter(R3d %in% c("3", "4", "5", "6", "7")) %>%
  dplyr::mutate(start =  R_Destiny_ID, 
                end = R_Start_ID) %>% 
  dplyr::select(start, end, R3c, R3a, R3d)
# adicionar filas duplicadas al edgelist
 d2 <- d2 %>% 
  bind_rows(., dopler) %>%
  dplyr::select(R_Start_ID = start, R_Destiny_ID = end, R3c, R3a, R3d) %>% 
  dplyr::filter()

 
  net <- graph_from_data_frame(d=  d2,
                               vertices = groups %>% dplyr::select(ID, V1),
                               directed=T)%>%
  igraph::delete_vertices(., igraph::degree(.) == 0)  %>% 
  igraph::delete_edges(., edges = which(igraph::which_multiple(.)))
  
  
  #save adjacency matrix
  # as_adjacency_matrix(net, type = "both", sparse = F) %>% 
  # as.data.frame() %>% 
  #    write_csv(., path = paste0(tbl_pth, "adj_1a7_m_coopTEc_dir", ".csv"))

vtx_shp <- tibble(nodos = character(0), shp = character(0)) %>% 
  add_row(nodos = intersect(d2$R_Start_ID, d2$R_Destiny_ID), shp = "both") %>%
  add_row(nodos = setdiff(d2$R_Start_ID, d2$R_Destiny_ID), shp = "Providers") %>%
  add_row(nodos = setdiff(d2$R_Destiny_ID, d2$R_Start_ID), shp = "Receptors") %>%
  right_join(., tibble(vtx = V(net)$name), by = c("nodos" = "vtx") ) %>% 
  dplyr::mutate( shape = dplyr::case_when(
                   shp == "both" ~ "circle",
                   shp == "Receptors" ~ "triangle",
                   shp == "Providers" ~ "square"))



v_color <- tibble(id = V(net)$name) %>% 
  dplyr::left_join(., groups, by = c("id" = "ID") ) %>% 
  dplyr::left_join(., gr_colors, by = c("V1" = "V1")) %>% 
  pull(color)

edge.col <- tibble(var = E(net)$R3a) %>% 
  dplyr::mutate(col = dplyr::recode(var,  "0" = "gray48", "1" =  "darkgreen")) %>% 
  pull(col) 


igraph::add_shape("triangle", clip=igraph::shapes("circle")$clip,
                 plot=mytriangle)
par(bg = NA)
plot(net, 
     layout= layout_with_kk, 
     edge.arrow.size=0.8, 
     rescale=T,
     edge.color= edge.col,
     edge.width = 2.5,
     vertex.color = v_color,
     vertex.size = 6.5,
     vertex.label.dist=0,
     vertex.shape = vtx_shp$shape,
     vertex.label= V(net)$name,
     vertex.label.family = "Arial",
     vertex.label.font	= 2,
     vertex.label.cex = 0.9,
     vertex.label.dist = 150,
     vertex.label.degree = -pi/2,
     vertex.label.color="black",
     asp = 0)

legend("topright" , c("Group A","Group A2", "Group B", "Group 0"), 
       pch = c(21, 21, 21, 21),
       col= c("black","black", "black", "black"), pt.bg= colrs, 
       pt.cex=2, cex=.8, bty = "n",  title="GROUPS")

legend("bottomright", c( "Providers", "Receptors", "Both"), col = c("black", "black", "black"), pch = c(15, 17, 16),  pt.cex=2, cex=0.8, bty="n", title = "Type of technical cooperation relation")

#Conteos de los verteex shape
vtx_shp %>% 
  left_join(., groups, by = c("nodos" = "ID") ) %>% 
  group_by( shp) %>%
  tally() %>%
  dplyr::mutate(freq = round(n/sum(n), 2), frq = paste0(round(freq*100,1), "%")) %>% 
  dplyr::select(Type = shp, Count = n, Frequency = frq) %>%
  add_row(Type = "Not avaliable rate", Count = non_response, Frequency = non_res_frq) %>% 
  data.frame() %>% 
  write_csv(., path = paste0(tbl_pth, "rcoopTec_1a7_shape_freq", ".csv"))

vtx_shp %>% 
  left_join(., groups, by = c("nodos" = "ID") ) %>% 
  group_by( V1, shp) %>%
  tally() %>%
  dplyr::mutate(freq = round(n/sum(n), 2), frq = paste0(freq*100, "%")) %>%
  ungroup() %>%
  add_row(V1 = "Not avaliable", shp = "Not avaliable rate", n = non_response, frq = non_res_frq) %>% 
  dplyr::select(., "Type of technical cooperation relation" = shp, "Group" = V1 , "Count" = n , "Frequency" = frq) %>%
  data.frame()  %T>% 
   write_csv(., path = paste0(tbl_pth, "rcoopTec_1a7_shape_by_gr", ".csv"))


  
```


\pagebreak

### Nueva Red cooperación técnica (NO DIRECCION 1,2,3,4,5,6,7,8)

```{r rcoopTecNew2_1a8, echo=FALSE,fig.width=13, fig.height=11,warning=FALSE,strip.white=FALSE, cache = FALSE, dpi = 300}

nt1 <- read_excel(xls.file, sheet = "R3_coop_técnica") %>%
  dplyr::filter(R_Start_ID != 25 & R_Destiny_ID != 25) %>% 
  dplyr::filter(R_Start_ID != 78 & R_Destiny_ID != 75)


dups <- nt1 %>% 
  dplyr::mutate(id = paste0(R_Start_ID, "-", R_Destiny_ID)) %>% 
  dplyr::mutate(dup = duplicated(id)) %>% 
  dplyr::filter(dup) %>%  pull(id)

#remover duplicados
nt1 <- nt1 %>% 
  dplyr::mutate(id = paste0(R_Start_ID, "-", R_Destiny_ID)) %>% 
  dplyr::mutate(dup = id %in% dups) %>% 
  dplyr::mutate(no_remove = if_else( (dup & R_Start_ID == 42 & R_Start_ID_ego == "b") | 
                                       (dup & R_Start_ID == 49 & R_Start_ID_ego == "c") |
                                       (dup & R_Start_ID == 76 & R_Start_ID_ego == "b"), TRUE, FALSE)) %>% 
  dplyr::filter( !(dup & !no_remove) ) %>% 
  dplyr::select(-id, -dup, -no_remove) 


# calcular non response rate para todas las preguntas
tot <-nt1 %>% 
  nrow()

non_res_Ra <- nt1 %>% 
  dplyr::filter(R3a == 2) %>% 
  nrow

non_res_Ra_frq <- paste0(round(non_res_Ra/tot*100), "%")

non_res_Rb <- nt1  %>% 
  dplyr::filter(R3d == 9)%>% 
  nrow

non_res_Rb_frq <- paste0(round(non_res_Rb/tot*100), "%")

non_res_Rc <- nt1 %>% 
  dplyr::filter(R3c == 9)%>% 
  nrow

non_res_Rc_frq <- paste0(round(non_res_Rc/tot*100), "%")



d2 <- nt1 %>%
  dplyr::select( R_Start_ID,  R_Destiny_ID, R3c, R3a, R3d) %>%
  dplyr::filter(R3a != 2) %>%
  dplyr::filter(R3d != 9) %>% 
  dplyr::mutate(R3c = R3c+1, R3c = if_else(R3c == 7, 1, R3c)) %>%
  dplyr::mutate_all(as.character)
 
  net <- graph_from_data_frame(d=  d2,
                               vertices = groups %>% dplyr::select(ID, V1),
                               directed=T)%>%
  igraph::delete_vertices(., igraph::degree(.) == 0)
  
  net_no_dir <- graph_from_data_frame(d=  d2,
                               vertices = groups %>% dplyr::select(ID, V1),
                               directed=F)%>%
  igraph::delete_vertices(., igraph::degree(.) == 0)
  #%>% 
  #igraph::delete_edges(., edges = which(igraph::which_multiple(.)))
  

  
  #save adjacencyu matrix
  as_adjacency_matrix(net_no_dir, type = "both", sparse = F) %>% 
  as.data.frame() %>% 
     write_csv(., path = paste0(tbl_pth, "adj_m_coopTec_12345678_Ndir", ".csv"))
  
  
v_color <- tibble(id = V(net)$name) %>% 
  dplyr::left_join(., groups, by = c("id" = "ID") ) %>% 
  dplyr::left_join(., gr_colors, by = c("V1" = "V1")) %>% 
  pull(color)

igraph::add_shape("triangle", clip=igraph::shapes("circle")$clip,
                 plot=mytriangle)

edge.col <- tibble(var = E(net)$R3d) %>% 
  dplyr::mutate(col = dplyr::recode(var,  "1" = "gray48", "2" =  "gray48",  "3" = "gray48", "4" =  "gray48", 
                                    "5" = "gray48", "6" = "gray48", "7" = "gray48", "8" = "gray48")) %>% 
  pull(col) 

ltype <- tibble(var = E(net)$R3d) %>% 
  dplyr::mutate(lty = if_else(var == "8", 2, 1)) %>% 
  pull(lty) 

par(bg = NA)
plot(net, 
     layout= layout_with_kk, 
     edge.arrow.size= 0, 
     rescale= TRUE,
     edge.color= edge.col,
     edge.width = 2.2,
     edge.lty = ltype, 
     vertex.size = 6.5,
     vertex.shape = NULL,
     vertex.label.dist=0,
     vertex.color = v_color,
     vertex.label= V(net)$name,
     vertex.label.family = "Arial",
     vertex.label.font	= 2,
     vertex.label.cex = 0.90,
     vertex.label.dist = 150,
     vertex.label.degree = -pi/2,
     vertex.label.color="black",
     asp = 0)

gr_labs <- gr_colors %>% 
 dplyr::filter(V1 != "0") %>% 
  mutate(lab = paste("Grupo", V1)) %>% 
  select(color, lab)

legend("topleft" , c("PPA members", "Executive Coordination (in 2019)", "PPA partners and collaborators") , pch = c(21, 21, 21, 15,15, 17, 16),
       col= c("black","black", "black"), pt.bg= c(gr_labs$color[-4]), pt.cex=2, cex=.8, bty = "n",  title="GRUPOS")

legend("bottomleft", c("In negociations", "Providers, Receptors, and Both"), lty = c(2,1), col = unique(edge.col), lwd = c(2,3), pt.cex=2, cex=0.8, bty="n", title = "Technical cooperation relation")

#metricas generales

tibble(Metric = c("density", "centraBetw", "centraDeg", "modularidad", "meanDegree", "transitiv", "assorta", "EigenValue"),
       Value  = c(igraph::edge_density(net_no_dir),
                  igraph::centralization.betweenness(net_no_dir)$centralization,
                  igraph::centralization.degree (net_no_dir, mode = "all")$centralization,
                  igraph:: cluster_walktrap(net_no_dir) %>% igraph::modularity(),
                  mean(igraph::degree(net_no_dir, mode="all", normalized = F)),
                  igraph::transitivity(net_no_dir),
                  igraph::assortativity.degree(net_no_dir, directed = F),
                  eigen_centrality(net_no_dir, directed = F)$value
       )) %>%
  dplyr::mutate_if(is.numeric, round, digits = 2) %>%
  data.frame()  %T>%
   write_csv(., path = paste0(tbl_pth, "coopTec_1234567_gnrl_metrics_Ndir", ".csv"))  %>% 
flextable(.,  cwidth = 2)

#metricas por cada nodo
metrics <- tibble(nodes_id = V(net_no_dir)$name) %>% 
  dplyr::left_join(., groups, by = c("nodes_id" = "ID")) %>%
  dplyr::select(nodes_id, Nome,V1) %>%
  dplyr::mutate(degree         = igraph::degree(net_no_dir, mode="all", normalized = F),
                betwe          = igraph::betweenness(net_no_dir) %>% round(.,1),
                closeness      = igraph::closeness(net_no_dir, mode="all") %>% round(.,4),
                ClusWalk       = igraph:: cluster_walktrap(net_no_dir) %>% membership(),
                transitivLocal = igraph::transitivity(net_no_dir, type = "local")  %>% round(.,2),
                Eigen_centr    = igraph::eigen_centrality(net_no_dir, directed = T)$vector %>%  round(.,2)
  ) %>%
  dplyr::mutate( HClust         = dplyr::select(., degree, betwe, closeness, Eigen_centr ) %>% 
                   clustering(data =., k = 4, dist.method = "euclidean", scale.unit = T)) %>% 
  dplyr::left_join(., entrevistados, by = c("nodes_id"= "ID")) %>% 
  dplyr::left_join(., type_org %>% dplyr::select(ID, V39a_lab, V39b_lab), by = c("nodes_id"= "ID"))

metrics %>% 
  data.frame()  %T>% 
  write_csv(., path = paste0(tbl_pth, "coopTec_1234567_all_metrics_Ndir", ".csv")) %>% 
  flextable(.)

metrics %>% 
  dplyr::group_by(HClust) %>% 
  dplyr::summarise_if(is.numeric, list(~mean(.),~sd(.))) %T>% 
  write_csv(., path = paste0(tbl_pth, "CoopTec_1234567_NDir_cluster_summary.csv")) %>% 
   flextable(.)

### R3a summary

summ <-  tibble(var = E(net)$R3a) %>%
  dplyr::mutate( start  = igraph::ends(net, es=E(net), names=T)[,1]) %>%
  left_join(., groups, by = c("start" = "ID"))%>%
  dplyr::mutate( var = case_when(
    var == "0" ~ "No",
    var == "1" ~ "Yes",
    var == "2" ~ "Do not know",
    TRUE ~ "Outro"
  ))

summ %>%
  dplyr::filter(var != "Do not know" ) %>% 
  group_by( V1, var) %>%
  tally()  %>% 
  dplyr::mutate(freq = round(n/sum(n),2)*100, freq = paste0(freq, "%") ) %>% 
   ungroup() %>% 
  add_row(V1 = "Do not know", var = "Do not know rate", n = non_res_Ra, freq = non_res_Ra_frq) %>% 
  dplyr::select(Group = V1, "Technical cooperation relation began in the PPA" = var, Count = n, Frequency = freq) %>%
  data.frame()  %T>% 
  write_csv(., path = paste0(tbl_pth, "coopTec_12345678_R3a_summary", ".csv")) %>% 
  flextable(.) 

##### R3d summary


summ <-  tibble(var = E(net)$R3d) %>%
  dplyr::mutate( start  = igraph::ends(net, es=E(net), names=T)[,1]) %>%
  left_join(., groups, by = c("start" = "ID"))%>%
  dplyr::mutate( var = case_when(
    var  == "1" ~  "Provider",
    var  == "2" ~ "Recepient",
    var  == "3" ~ "Collaboration",
    var  == "4" ~ "Collaboration and provider",
    var  == "5" ~ "Collaboration and recipient",
    var  == "6" ~ "Provider and Recipient",
    var  == "7" ~ "Provider, recipient and collaboration",
    var  == "8" ~ "In negociation",
    TRUE ~ "Not available"
  ))

summ %>%
  dplyr::filter(var != "Not available" ) %>% 
  group_by( V1, var) %>%
  tally()  %>% 
  dplyr::mutate(freq = round(n/sum(n),2)*100, freq = paste0(freq, "%") ) %>% 
   ungroup() %>% 
  add_row(V1 = "Do not know", var = "Do not know rate", n = non_res_Rb, freq = non_res_Rb_frq) %>% 
  dplyr::select(Group = V1, "Type of technical cooperation relation" = var, Count = n, Frequency = freq) %>%
  data.frame()  %T>% 
  write_csv(., path = paste0(tbl_pth, "coopTec_12345678_R3d_summary", ".csv")) %>% 
  flextable(.)

##### R2c summary


summ <-  tibble(var = E(net)$R3c) %>%
  dplyr::mutate( start  = igraph::ends(net, es=E(net), names=T)[,1]) %>%
  left_join(., groups, by = c("start" = "ID"))%>%
  dplyr::mutate( var = case_when(
    var  == "1" ~  "Very low - less than once per year",
    var  == "2" ~ "Low - once or twice per year",
    var  == "3" ~ "Regular - three to six times per year",
    var  == "4" ~ "Frequent - seven to 12 times per year",
    var  == "5" ~ "Very frequent - more than once a month",
    TRUE ~ "Not avaliable"
  ))

summ %>%
  group_by( V1, var) %>%
  tally()  %>% 
  #dplyr::mutate(freq = round(n/sum(n),2)*100, freq = paste0(freq, "%") ) %>% 
   ungroup() %>% 
  #add_row(V1 = "Data not available", var = "Data not available rate", n = non_res_Rc, freq = non_res_Rc_frq) %>% 
  dplyr::select(Group = V1, "Intensity of technical cooperation relation" = var, Count = n) %>%
  data.frame()  %T>% 
  write_csv(., path = paste0(tbl_pth, "CoopTec_12345678_R3c_summary", ".csv")) %>% 
  flextable(.) 


#### R3a vs R3d


summ <-  tibble(var = E(net)$R3a, var2 = E(net)$R3d) %>%
  dplyr::mutate( start  = igraph::ends(net, es=E(net), names=T)[,1]) %>%
   dplyr::filter(var != 2) %>%
  dplyr::filter(var2 != 9) %>% 
  left_join(., groups, by = c("start" = "ID"))%>%
  dplyr::mutate( var = case_when(
    var == "0" ~ "No",
    var == "1" ~ "Yes",
    var == "2" ~ "Do not know",
    TRUE ~ "Not available"
  ), var2 = case_when(
    var2  == "1" ~  "Provider",
    var2  == "2" ~ "Recepient",
    var2  == "3" ~ "Collaboration",
    var2  == "4" ~ "Collaboration and provider",
    var2  == "5" ~ "Collaboration and recipient",
    var2  == "6" ~ "Provider and Recipient",
    var2  == "7" ~ "Provider, recipient and collaboration",
    var2  == "8" ~ "In negociation",
    TRUE ~ "Not available"
  ))


non_response<- nt1 %>%
  dplyr::select( R_Start_ID,  R_Destiny_ID, R3c, R3a, R3d) %>%
  dplyr::filter(R3a == 2 | R3d == 9) %>%
  nrow
non_res_frq <- paste0(round(non_response/nrow(nt1)*100), "%")

summ %>%  
  group_by( V1, var, var2) %>%
  tally()  %>% 
  ungroup() %>% 
  add_row(V1 = "No response count", var = "No response count", var2 = var , n = non_response) %>% 
  dplyr::select(Group = V1, "Technical cooperation relation began in the PPA" = var,
                "Type of technical cooperation relation" = var2, Count = n) %>%
  data.frame()  %T>% 
  write_csv(., path = paste0(tbl_pth, "Cooptec_12345678_R3a_R3d_summary", ".csv")) %>% 
  flextable(.) 


#### R2a vs R2c



summ <-  tibble(var = E(net)$R3a, var2 = E(net)$R3c) %>%
  dplyr::mutate( start  = igraph::ends(net, es=E(net), names=T)[,1]) %>%
  left_join(., groups, by = c("start" = "ID"))%>%
  dplyr::mutate( var = case_when(
    var == "0" ~ "No",
    var == "1" ~ "Yes",
    var == "2" ~ "Do not know",
    TRUE ~ "Not available"
  ), var2 = case_when(
    var2  == "1" ~  "Very low - less than once per year",
    var2  == "2" ~ "Low - once or twice per year",
    var2  == "3" ~ "Regular - three to six times per year",
    var2  == "4" ~ "Frequent - seven to 12 times per year",
    var2  == "5" ~ "Very frequent - more than once a month",
    TRUE ~ "Not avaliable"
  ))


# non_response<- nt1 %>%
#   dplyr::select( R_Start_ID,  R_Destiny_ID, R3c, R3a,  R3d) %>%
#   dplyr::filter(R3a == 2 | R3c == 9) %>%
#   nrow
# non_res_frq <- paste0(round(non_response/nrow(nt1)*100), "%")

summ %>%  
  group_by( V1, var, var2) %>%
  tally()  %>% 
  ungroup() %>% 
  #add_row(V1 = "No response count", var = "No response count", var2 = var , n = non_response) %>% 
  dplyr::select(Group = V1, "Technical cooperation relation began in the PPA" = var,
                "Intensity of techical cooperation relation" = var2, Count = n) %>%
  data.frame()  %T>% 
  write_csv(., path = paste0(tbl_pth, "coopTec_12345678_R3a_R3c_summary", ".csv")) %>% 
  flextable(.) 



#contar los links para cada nodo según el grupo
as_tibble(ends(net, E(net), names = T)) %>% 
  dplyr::select(start = V1, end = V2) %>% 
  left_join(., groups, by = c("start" = "ID")) %>% 
  dplyr::select( ID_start = V1, everything()) %>% 
  dplyr::left_join(., groups, by = c("end"= "ID")) %>% 
  dplyr::select(start, end,  ID_start,ID_end = V1, everything()) %>% 
  group_by(ID_start, ID_end) %>% 
  tally() %>%
  ungroup() %>%
  dplyr::mutate(Ratio = paste(round(n/sum(n)*100,1), "%")) %>% 
  dplyr::select(Group_start = ID_start, Group_end = ID_end, Links_count = n, Ratio) %T>% 
  write_csv(.,  path = paste0(tbl_pth, paste0(red, "rinvest_123456_node_links_count", ".csv"))) %>%
  flextable(.)

# frecuencias por grupo y tipo de organizacion
tibble(ID = V(net)$name) %>% 
  left_join(., type_org, by = c("ID" = "ID"),  suffix = c("", ".to_remove")) %>%
  dplyr::group_by(V1, V39a_lab) %>% 
  tally() %>% 
  dplyr::select(Group = V1, "Type of organization" = V39a_lab, Count = n) %>%
  write_csv(., path = paste0(tbl_pth, "rinvest_123456_type_org_byGR", ".csv"))
 

```


\pagebreak

### Nueva Red cooperación técnica mas GRUPO C (NO DIRECCION 1,2,3,4,5,6,7,8)

```{r rcoopTecNew2Grc, echo=FALSE,fig.width=13, fig.height=11,warning=FALSE,strip.white=FALSE, cache = FALSE, dpi = 300}

nt1 <- read_excel(xls.file, sheet = "R3_coop_técnica") %>%
  dplyr::filter(R_Start_ID != 25 & R_Destiny_ID != 25) %>% 
  dplyr::filter(R_Start_ID != 78 & R_Destiny_ID != 75)


dups <- nt1 %>% 
  dplyr::mutate(id = paste0(R_Start_ID, "-", R_Destiny_ID)) %>% 
  dplyr::mutate(dup = duplicated(id)) %>% 
  dplyr::filter(dup) %>%  pull(id)

#remover duplicados
nt1 <- nt1 %>% 
  dplyr::mutate(id = paste0(R_Start_ID, "-", R_Destiny_ID)) %>% 
  dplyr::mutate(dup = id %in% dups) %>% 
  dplyr::mutate(no_remove = if_else( (dup & R_Start_ID == 42 & R_Start_ID_ego == "b") | 
                                       (dup & R_Start_ID == 49 & R_Start_ID_ego == "c") |
                                       (dup & R_Start_ID == 76 & R_Start_ID_ego == "b"), TRUE, FALSE)) %>% 
  dplyr::filter( !(dup & !no_remove) ) %>% 
  dplyr::select(-id, -dup, -no_remove) 

d <- nt1 %>%
  dplyr::select( R_Start_ID,  R_Destiny_ID, R3c, R3a, R3d) %>%
  dplyr::filter(R3a != 2) %>%
  dplyr::filter(R3d != 9) %>% 
  dplyr::mutate(R3c = R3c+1, R3c = if_else(R3c == 7, 1, R3c)) %>%
  dplyr::mutate_all(as.character)

nt2 <- read_excel(xls.file, sheet = "R5_outras_org") %>%
  dplyr::select(R_Start_ID, R_Destiny_ID = R5b_Destiny_ID, R5c) %>% 
  drop_na() %>% 
  mutate_all(as.character) %>% 
  dplyr::filter(R5c == "3") %>% 
  dplyr::select( -R5c)

nt_all <- bind_rows(d, nt2)

 
  net <- graph_from_data_frame(d=  nt_all,
                               vertices = groups %>% dplyr::select(ID, V1),
                               directed=T)%>%
  igraph::delete_vertices(., igraph::degree(.) == 0) %>% 
  igraph::delete_edges(., edges = which(igraph::which_multiple(.)))
  
  net_no_dir <- graph_from_data_frame(d=  nt_all,
                               vertices = groups %>% dplyr::select(ID, V1),
                               directed=F)%>%
  igraph::delete_vertices(., igraph::degree(.) == 0) %>% 
  igraph::delete_edges(., edges = which(igraph::which_multiple(.)))
  
   #save adjacencyu matrix
  as_adjacency_matrix(net_no_dir, type = "both", sparse = F) %>% 
  as.data.frame() %>% 
     write_csv(., path = paste0(tbl_pth, "adj_m_coopTec_12345678_Ndir_Grc", ".csv"))
  

  
v_color <- tibble(id = V(net)$name) %>% 
  dplyr::left_join(., groups, by = c("id" = "ID") ) %>% 
  dplyr::left_join(., gr_colors, by = c("V1" = "V1")) %>% 
  pull(color)


par(bg = NA)
plot(net, 
     layout= layout_with_kk, 
     edge.arrow.size= 0, 
     rescale= TRUE,
     edge.color= "gray48",
     edge.width = 2.2,
     vertex.size = 6.5,
     vertex.shape = NULL,
     vertex.label.dist=0,
     vertex.color = v_color,
     vertex.label= V(net)$name,
     vertex.label.family = "Arial",
     vertex.label.font	= 2,
     vertex.label.cex = 0.90,
     vertex.label.dist = 150,
     vertex.label.degree = -pi/2,
     vertex.label.color="black",
     asp = 0)

gr_labs <- gr_colors %>% 
 dplyr::filter(V1 != "0") %>% 
  mutate(lab = paste("Grupo", V1)) %>% 
  select(color, lab)

legend("topleft" , c("PPA members", "Executive Coordination (in 2019)", "PPA partners and collaborators", "Actors in PPA's sphere of influence") , pch = c(21, 21, 21, 21),
       col= c("black","black", "black"), pt.bg= c(gr_labs$color), pt.cex=2, cex=.8, bty = "n",  title="GRUPOS")





#metricas generales

tibble(Metric = c("density", "centraBetw", "centraDeg", "modularidad", "meanDegree", "transitiv", "assorta", "EigenValue"),
       Value  = c(igraph::edge_density(net_no_dir),
                  igraph::centralization.betweenness(net_no_dir)$centralization,
                  igraph::centralization.degree (net_no_dir, mode = "all")$centralization,
                  igraph:: cluster_walktrap(net_no_dir) %>% igraph::modularity(),
                  mean(igraph::degree(net_no_dir, mode="all", normalized = F)),
                  igraph::transitivity(net_no_dir),
                  igraph::assortativity.degree(net_no_dir, directed = F),
                  eigen_centrality(net_no_dir, directed = F)$value
       )) %>%
  dplyr::mutate_if(is.numeric, round, digits = 2) %>%
  data.frame()  %T>%
   write_csv(., path = paste0(tbl_pth, "coopTec_12345678_gnrl_metrics_Ndir_Grc", ".csv"))  %>% 
flextable(.,  cwidth = 2)

#metricas por cada nodo
metrics <- tibble(nodes_id = V(net_no_dir)$name) %>% 
  dplyr::left_join(., groups, by = c("nodes_id" = "ID")) %>%
  dplyr::select(nodes_id, Nome,V1) %>%
  dplyr::mutate(degree         = igraph::degree(net_no_dir, mode="all", normalized = F),
                betwe          = igraph::betweenness(net_no_dir) %>% round(.,1),
                closeness      = igraph::closeness(net_no_dir, mode="all") %>% round(.,4),
                ClusWalk       = igraph:: cluster_walktrap(net_no_dir) %>% membership(),
                transitivLocal = igraph::transitivity(net_no_dir, type = "local")  %>% round(.,2),
                Eigen_centr    = igraph::eigen_centrality(net_no_dir, directed = T)$vector %>%  round(.,2)
  ) %>%
  dplyr::mutate( HClust         = dplyr::select(., degree, betwe, closeness, Eigen_centr ) %>% 
                   clustering(data =., k = 4, dist.method = "euclidean", scale.unit = T)) %>% 
  dplyr::left_join(., entrevistados, by = c("nodes_id"= "ID")) %>% 
  dplyr::left_join(., type_org %>% dplyr::select(ID, V39a_lab, V39b_lab), by = c("nodes_id"= "ID"))

metrics %>% 
  data.frame()  %T>% 
  write_csv(., path = paste0(tbl_pth, "coopTec_1234567_all_metrics_Ndir_Grc", ".csv")) %>% 
  flextable(.)

metrics %>% 
  dplyr::group_by(HClust) %>% 
  dplyr::summarise_if(is.numeric, list(~mean(.),~sd(.))) %T>% 
  write_csv(., path = paste0(tbl_pth, "CoopTec_1234567_NDir_cluster_summary_Grc.csv")) %>% 
   flextable(.)



## conteos de links para el grupo C

#contar los links para cada nodo según el grupo
as_tibble(ends(net, E(net), names = T)) %>% 
  dplyr::select(start = V1, end = V2) %>% 
  left_join(., groups, by = c("start" = "ID")) %>% 
  dplyr::select( ID_start = V1, everything()) %>% 
  dplyr::left_join(., groups, by = c("end"= "ID")) %>% 
  dplyr::select(start, end,  ID_start,ID_end = V1, everything()) %>% 
  group_by(ID_start, ID_end) %>% 
  tally() %>%
  ungroup() %>%
  dplyr::mutate(Ratio = paste(round(n/sum(n)*100,1), "%")) %>% 
  dplyr::select(Group_start = ID_start, Group_end = ID_end, Links_count = n, Ratio) %T>% 
  write_csv(.,  path = paste0(tbl_pth, paste0("rcooptec_node_links_count_Grc", ".csv"))) %>%
  flextable(.)


 

```

\pagebreak


# Red de Negocios



### Nueva red de negocios R1a (NO DIRECCION )

```{r rnegoR1a, echo=FALSE,fig.width=13, fig.height=11,warning=FALSE,strip.white=FALSE, cache = FALSE, dpi = 300}

nt1 <- read_excel(xls.file, sheet = "R1_negocios") 


dups <- nt1 %>% 
  dplyr::mutate(id = paste0(R_Start_ID, "-", R_Destiny_ID)) %>% 
  dplyr::mutate(dup = duplicated(id)) %>% 
  dplyr::filter(dup) %>%  pull(id)

nt1 <- nt1 %>% 
  dplyr::mutate(id = paste0(R_Start_ID, "-", R_Destiny_ID)) %>% 
  dplyr::mutate(dup = id %in% dups) %>% 
  dplyr::mutate(no_remove = if_else( (dup & R_Start_ID == 42 & R_Start_ID_ego == "b") | 
                                       (dup & R_Start_ID == 49 & R_Start_ID_ego == "c") |
                                       (dup & R_Start_ID == 76 & R_Start_ID_ego == "b"), TRUE, FALSE)) %>% 
  dplyr::filter( !(dup & !no_remove) ) %>% 
  dplyr::select(-id, -dup, -no_remove) 

# calcular non response rate para todas las preguntas
tot <-nt1 %>% 
  nrow()

non_res_Ra <- nt1 %>% 
  dplyr::filter(R1a == 2) %>% 
  nrow

non_res_Ra_frq <- paste0(round(non_res_Ra/tot*100), "%")

non_res_Rb <- nt1  %>% 
  dplyr::filter(R1b == 9)%>% 
  nrow

non_res_Rb_frq <- paste0(round(non_res_Rb/tot*100), "%")


#### encontrar los duplicados y removerlos


d2 <- nt1 %>%
  dplyr::select( R_Start_ID,  R_Destiny_ID,  R1a, R1b) %>%
  dplyr::filter(R1a != 2) %>%
  dplyr::mutate(R1b = R1b+1, R1b = if_else(R1b == 7, 1, R1b)) %>%
  dplyr::mutate_all(as.character)
 
  net <- graph_from_data_frame(d=  d2,
                               vertices = groups %>% dplyr::select(ID, V1),
                               directed=T)%>%
  igraph::delete_vertices(., igraph::degree(.) == 0)
  
  net_no_dir <- graph_from_data_frame(d=  d2,
                               vertices = groups %>% dplyr::select(ID, V1),
                               directed=F)%>%
  igraph::delete_vertices(., igraph::degree(.) == 0)
  #%>% 
  #igraph::delete_edges(., edges = which(igraph::which_multiple(.)))
  

  
  #save adjacencyu matrix
  as_adjacency_matrix(net_no_dir, type = "both", sparse = F) %>% 
  as.data.frame() %>% 
     write_csv(., path = paste0(tbl_pth, "adj_m_nego_Ndir", ".csv"))
  
  
v_color <- tibble(id = V(net)$name) %>% 
  dplyr::left_join(., groups, by = c("id" = "ID") ) %>% 
  dplyr::left_join(., gr_colors, by = c("V1" = "V1")) %>% 
  pull(color)

igraph::add_shape("triangle", clip=igraph::shapes("circle")$clip,
                 plot=mytriangle)

edge.col <- tibble(var = E(net)$R1a) %>% 
  dplyr::mutate(col = dplyr::recode(var, "0" = "gray48", "1" = "green4" )) %>% 
  pull(col) 

# ltype <- tibble(var = E(net)$R2b) %>% 
#   dplyr::mutate(lty = if_else(var == "5", 2, 1)) %>% 
#   pull(lty) 

par(bg = NA)
plot(net, 
     layout= layout_with_kk, 
     edge.arrow.size= 0, 
     rescale= TRUE,
     edge.color= edge.col,
     edge.width = 2.2,
     vertex.size = 5,
     vertex.shape = NULL,
     vertex.label.dist=0,
     vertex.color = v_color,
     vertex.label= V(net)$name,
     vertex.label.family = "Arial",
     vertex.label.font	= 2,
     vertex.label.cex = 0.90,
     vertex.label.dist = 150,
     vertex.label.degree = -pi/2,
     vertex.label.color="black",
     asp = 0)

gr_labs <- gr_colors %>% 
 dplyr::filter(V1 != "0") %>% 
  mutate(lab = paste("Grupo", V1)) %>% 
  select(color, lab)

legend("topleft" , c("PPA members", "Executive Coordination (in 2019)", "PPA partners and collaborators") , pch = c(21, 21, 21, 15,15, 17, 16),
       col= c("black","black", "black"), pt.bg= c(gr_labs$color[-4]), pt.cex=2, cex=.8, bty = "n",  title="GRUPOS")

legend("bottomleft", c( "In the PPA", "Outside the PPA"), lty = c(1,1), col = c("darkgreen", "gray48"), lwd = c(3,3,3), pt.cex=2, cex=0.8, bty="n", title = "CONTEXT OF THE RELATION")

#metricas generales

tibble(Metric = c("density", "centraBetw", "centraDeg", "modularidad", "meanDegree", "transitiv", "assorta", "EigenValue"),
       Value  = c(igraph::edge_density(net_no_dir),
                  igraph::centralization.betweenness(net_no_dir)$centralization,
                  igraph::centralization.degree (net_no_dir, mode = "all")$centralization,
                  igraph:: cluster_walktrap(net_no_dir) %>% igraph::modularity(),
                  mean(igraph::degree(net_no_dir, mode="all", normalized = F)),
                  igraph::transitivity(net_no_dir),
                  igraph::assortativity.degree(net_no_dir, directed = F),
                  eigen_centrality(net_no_dir, directed = F)$value
       )) %>%
  dplyr::mutate_if(is.numeric, round, digits = 2) %>%
  data.frame()  %T>%
   write_csv(., path = paste0(tbl_pth, "rnego_gnrl_metrics_Ndir", ".csv"))  %>% 
flextable(.,  cwidth = 2)

#metricas por cada nodo
metrics <- tibble(nodes_id = V(net_no_dir)$name) %>% 
  dplyr::left_join(., groups, by = c("nodes_id" = "ID")) %>%
  dplyr::select(nodes_id, Nome,V1) %>%
  dplyr::mutate(degree         = igraph::degree(net_no_dir, mode="all", normalized = F),
                betwe          = igraph::betweenness(net_no_dir) %>% round(.,1),
                closeness      = igraph::closeness(net_no_dir, mode="all") %>% round(.,4),
                ClusWalk       = igraph:: cluster_walktrap(net_no_dir) %>% membership(),
                transitivLocal = igraph::transitivity(net_no_dir, type = "local")  %>% round(.,2),
                Eigen_centr    = igraph::eigen_centrality(net_no_dir, directed = T)$vector %>%  round(.,2)
  ) %>%
  dplyr::mutate( HClust         = dplyr::select(., degree, betwe, closeness, Eigen_centr ) %>% 
                   clustering(data =., k = 4, dist.method = "euclidean", scale.unit = T)) %>% 
  dplyr::left_join(., entrevistados, by = c("nodes_id"= "ID")) %>% 
  dplyr::left_join(., type_org %>% dplyr::select(ID, V39a_lab, V39b_lab), by = c("nodes_id"= "ID"))

metrics %>% 
  data.frame()  %T>% 
  write_csv(., path = paste0(tbl_pth, "rnego_all_metrics_Ndir", ".csv")) %>% 
  flextable(.)

metrics %>% 
  dplyr::group_by(HClust) %>% 
  dplyr::summarise_if(is.numeric, list(~mean(.),~sd(.))) %T>% 
  write_csv(., path = paste0(tbl_pth, "rnego_NDir_cluster_summary.csv")) %>% 
   flextable(.)

### R2a summary

summ <-  tibble(var = E(net)$R1a) %>%
  dplyr::mutate( start  = igraph::ends(net, es=E(net), names=T)[,1]) %>%
  left_join(., groups, by = c("start" = "ID"))%>%
  dplyr::mutate( var = case_when(
    var == "0" ~ "No",
    var == "1" ~ "Yes",
    var == "2" ~ "Do not know",
    TRUE ~ "Outro"
  ))

summ %>%
  dplyr::filter(var != "Do not know" ) %>% 
  group_by( V1, var) %>%
  tally()  %>% 
  dplyr::mutate(freq = round(n/sum(n),2)*100, freq = paste0(freq, "%") ) %>% 
   ungroup() %>% 
  add_row(V1 = "Do not know", var = "Do not know rate", n = non_res_Ra, freq = non_res_Ra_frq) %>% 
  dplyr::select(Group = V1, "Business relation began in the PPA" = var, Count = n, Frequency = freq) %>%
  data.frame()  %T>% 
  write_csv(., path = paste0(tbl_pth, "rnego_R1a_summary", ".csv")) %>% 
  flextable(.) 


##### R1b summary



summ <-  tibble(var = E(net)$R1b) %>%
  dplyr::mutate( start  = igraph::ends(net, es=E(net), names=T)[,1]) %>%
  left_join(., groups, by = c("start" = "ID"))%>%
  dplyr::mutate( var = case_when(
    var  == "1" ~  "Very low - less than once per year",
    var  == "2" ~ "Low - once or twice per year",
    var  == "3" ~ "Regular - three to six times per year",
    var  == "4" ~ "Frequent - seven to 12 times per year",
    var  == "5" ~ "Very frequent - more than once a month",
    var  == "6" ~ "In negociation",
    var  == "9" ~ "Not available",
    TRUE ~ "Not avaliable"
  ))

summ %>%
#  dplyr::filter(var != "Not available" ) %>% 
  group_by( V1, var) %>%
  tally()  %>% 
  #dplyr::mutate(freq = round(n/sum(n),2)*100, freq = paste0(freq, "%") ) %>% 
   ungroup() %>% 
  #add_row(V1 = "Data not available", var = "Data not available rate", n = non_res_Rc, freq = non_res_Rc_frq) %>% 
  dplyr::select(Group = V1, "Intensity of business relation" = var, Count = n) %>%
  data.frame()  %T>% 
  write_csv(., path = paste0(tbl_pth, "rnego_R1b_summary", ".csv")) %>% 
  flextable(.) 



#### R1a vs R1b

summ <-  tibble(var = E(net)$R1a, var2 = E(net)$R1b) %>%
  dplyr::mutate( start  = igraph::ends(net, es=E(net), names=T)[,1]) %>%
  left_join(., groups, by = c("start" = "ID"))%>%
  dplyr::mutate( var = case_when(
    var == "0" ~ "No",
    var == "1" ~ "Yes",
    var == "2" ~ "Do not know",
    TRUE ~ "Not available"
  ), var2 = case_when(
    var2  == "1" ~  "Very low - less than once per year",
    var2  == "2" ~ "Low - once or twice per year",
    var2  == "3" ~ "Regular - three to six times per year",
    var2  == "4" ~ "Frequent - seven to 12 times per year",
    var2  == "5" ~ "Very frequent - more than once a month",
    var2  == "6" ~ "In negociation",
    var2  == "9" ~ "Not available",
    TRUE ~ "Not avaliable"
  ))


# non_response<- nt1 %>%
#   dplyr::select( R_Start_ID,  R_Destiny_ID, R2c, R2a, R2b, R2b) %>%
#   dplyr::filter(R2a == 2 | R2c == 9) %>%
#   nrow
# non_res_frq <- paste0(round(non_response/nrow(nt1)*100), "%")

summ %>%  
  group_by( V1, var, var2) %>%
  tally()  %>% 
  ungroup() %>% 
  #add_row(V1 = "No response count", var = "No response count", var2 = var , n = non_response) %>% 
  dplyr::select(Group = V1, "Business relation began in the PPA" = var,
                "Intensity of Business relation" = var2, Count = n) %>%
  data.frame()  %T>% 
  write_csv(., path = paste0(tbl_pth, "rnego_R1a_R1b_summary", ".csv")) %>% 
  flextable(.) 



#contar los links para cada nodo según el grupo
as_tibble(ends(net, E(net), names = T)) %>% 
  dplyr::select(start = V1, end = V2) %>% 
  left_join(., groups, by = c("start" = "ID")) %>% 
  dplyr::select( ID_start = V1, everything()) %>% 
  dplyr::left_join(., groups, by = c("end"= "ID")) %>% 
  dplyr::select(start, end,  ID_start,ID_end = V1, everything()) %>% 
  group_by(ID_start, ID_end) %>% 
  tally() %>%
  ungroup() %>%
  dplyr::mutate(Ratio = paste(round(n/sum(n)*100,1), "%")) %>% 
  dplyr::select(Group_start = ID_start, Group_end = ID_end, Links_count = n, Ratio) %T>% 
  write_csv(.,  path = paste0(tbl_pth, paste0(red, "rnego_node_links_count", ".csv"))) %>%
  flextable(.)

# frecuencias por grupo y tipo de organizacion
tibble(ID = V(net)$name) %>% 
  left_join(., type_org, by = c("ID" = "ID"),  suffix = c("", ".to_remove")) %>%
  dplyr::group_by(V1, V39a_lab) %>% 
  tally() %>% 
  dplyr::select(Group = V1, "Type of organization" = V39a_lab, Count = n) %>%
  write_csv(., path = paste0(tbl_pth, "rnego_type_org_byGR", ".csv"))
 



```


\pagebreak

### Nueva red de negocios mas grupoC (NO DIRECCION)

```{r rnegoGrC, echo=FALSE,fig.width=13, fig.height=11,warning=FALSE,strip.white=FALSE, cache = FALSE, dpi = 300}

nt1 <- read_excel(xls.file, sheet = "R1_negocios") 

dups <- nt1 %>% 
  dplyr::mutate(id = paste0(R_Start_ID, "-", R_Destiny_ID)) %>% 
  dplyr::mutate(dup = duplicated(id)) %>% 
  dplyr::filter(dup) %>%  pull(id)

nt1 <- nt1 %>% 
  dplyr::mutate(id = paste0(R_Start_ID, "-", R_Destiny_ID)) %>% 
  dplyr::mutate(dup = id %in% dups) %>% 
  dplyr::mutate(no_remove = if_else( (dup & R_Start_ID == 42 & R_Start_ID_ego == "b") | 
                                       (dup & R_Start_ID == 49 & R_Start_ID_ego == "c") |
                                       (dup & R_Start_ID == 76 & R_Start_ID_ego == "b"), TRUE, FALSE)) %>% 
  dplyr::filter( !(dup & !no_remove) ) %>% 
  dplyr::select(-id, -dup, -no_remove) 

d <- nt1 %>% 
  dplyr::select( R_Start_ID,  R_Destiny_ID, R1a, R1b) %>%
  dplyr::mutate(R1b = R1b+1, R1b = if_else(R1b == 7, 1, R1b)) %>%
  dplyr::mutate_all(as.character)



nt2 <- read_excel(xls.file, sheet = "R5_outras_org") %>%
  dplyr::select(R_Start_ID, R_Destiny_ID = R5b_Destiny_ID, R5c) %>% 
  drop_na() %>% 
  dplyr::filter( !R_Destiny_ID %in% c(900, 25)) %>% 
  mutate_all(as.character) %>% 
  dplyr::filter(R5c == "1") %>% 
  dplyr::select( -R5c)

nt_all <- bind_rows(d, nt2) 

 
  net <- graph_from_data_frame(d=  nt_all,
                               vertices = groups %>% dplyr::select(ID, V1),
                               directed=T)%>%
  igraph::delete_vertices(., igraph::degree(.) == 0) %>% 
  igraph::delete_edges(., edges = which(igraph::which_multiple(.)))
  
  net_no_dir <- net
  
   #save adjacencyu matrix
  as_adjacency_matrix(net_no_dir, type = "both", sparse = F) %>% 
  as.data.frame() %>% 
     write_csv(., path = paste0(tbl_pth, "adj_m_rnego_Ndir_Grc", ".csv"))
  
  
 
v_color <- tibble(id = V(net)$name) %>% 
  dplyr::left_join(., groups, by = c("id" = "ID") ) %>% 
  dplyr::left_join(., gr_colors, by = c("V1" = "V1")) %>% 
  pull(color)

igraph::add_shape("triangle", clip=igraph::shapes("circle")$clip,
                 plot=mytriangle)


par(bg = NA)
plot(net, 
     layout= layout_with_kk, 
     edge.arrow.size= 0, 
     rescale= TRUE,
     edge.color= "gray48",
     edge.width = 2.2,
     vertex.size = 6.5,
     vertex.shape = NULL,
     vertex.label.dist=0,
     vertex.color = v_color,
     vertex.label= V(net)$name,
     vertex.label.family = "Arial",
     vertex.label.font	= 2,
     vertex.label.cex = 0.90,
     vertex.label.dist = 150,
     vertex.label.degree = -pi/2,
     vertex.label.color="black",
     asp = 0)

gr_labs <- gr_colors %>% 
 dplyr::filter(V1 != "0") %>% 
  mutate(lab = paste("Grupo", V1)) %>% 
  select(color, lab)

legend("topleft" , c("PPA members", "Executive Coordination (in 2019)", "PPA partners and collaborators", "Actors in PPA's sphere of influence"), pch = c(21, 21, 21,21, 15,15, 17, 16),
       col= c("black","black", "black", "black"), pt.bg= c(gr_labs$color), pt.cex=2, cex=.8, bty = "n",  title="GROUPS")


#metricas generales

tibble(Metric = c("density", "centraBetw", "centraDeg", "modularidad", "meanDegree", "transitiv", "assorta", "EigenValue"),
       Value  = c(igraph::edge_density(net_no_dir),
                  igraph::centralization.betweenness(net_no_dir)$centralization,
                  igraph::centralization.degree (net_no_dir, mode = "all")$centralization,
                  igraph:: cluster_walktrap(net_no_dir) %>% igraph::modularity(),
                  mean(igraph::degree(net_no_dir, mode="all", normalized = F)),
                  igraph::transitivity(net_no_dir),
                  igraph::assortativity.degree(net_no_dir, directed = F),
                  eigen_centrality(net_no_dir, directed = F)$value
       )) %>%
  dplyr::mutate_if(is.numeric, round, digits = 2) %>%
  data.frame()  %T>%
   write_csv(., path = paste0(tbl_pth, "rnego_gnrl_metrics_Grc", ".csv"))  %>% 
flextable(.,  cwidth = 2)

#metricas por cada nodo
metrics <- tibble(nodes_id = V(net_no_dir)$name) %>% 
  dplyr::left_join(., groups, by = c("nodes_id" = "ID")) %>%
  dplyr::select(nodes_id, Nome,V1) %>%
  dplyr::mutate(degree         = igraph::degree(net_no_dir, mode="all", normalized = F),
                betwe          = igraph::betweenness(net_no_dir) %>% round(.,1),
                closeness      = igraph::closeness(net_no_dir, mode="all") %>% round(.,4),
                ClusWalk       = igraph:: cluster_walktrap(net_no_dir) %>% membership(),
                transitivLocal = igraph::transitivity(net_no_dir, type = "local")  %>% round(.,2),
                Eigen_centr    = igraph::eigen_centrality(net_no_dir, directed = T)$vector %>%  round(.,2)
  ) %>%
  dplyr::mutate( HClust         = dplyr::select(., degree, betwe, closeness, Eigen_centr ) %>% 
                   clustering(data =., k = 4, dist.method = "euclidean", scale.unit = T)) %>% 
  dplyr::left_join(., entrevistados, by = c("nodes_id"= "ID")) %>% 
  dplyr::left_join(., type_org %>% dplyr::select(ID, V39a_lab, V39b_lab), by = c("nodes_id"= "ID"))

metrics %>% 
  data.frame()  %T>% 
  write_csv(., path = paste0(tbl_pth, "rnego_all_metrics_GrC", ".csv")) %>% 
  flextable(.)

metrics %>% 
  dplyr::group_by(HClust) %>% 
  dplyr::summarise_if(is.numeric, list(~mean(.),~sd(.))) %T>% 
  write_csv(., path = paste0(tbl_pth, "rnego_Dir_cluster_summary_Grc.csv")) %>% 
   flextable(.)


#contar los links para cada nodo según el grupo
as_tibble(ends(net, E(net), names = T)) %>% 
  dplyr::select(start = V1, end = V2) %>% 
  left_join(., groups, by = c("start" = "ID")) %>% 
  dplyr::select( ID_start = V1, everything()) %>% 
  dplyr::left_join(., groups, by = c("end"= "ID")) %>% 
  dplyr::select(start, end,  ID_start,ID_end = V1, everything()) %>% 
  group_by(ID_start, ID_end) %>% 
  tally() %>%
  ungroup() %>%
  dplyr::mutate(Ratio = paste(round(n/sum(n)*100,1), "%")) %>% 
  dplyr::select(Group_start = ID_start, Group_end = ID_end, Links_count = n) %T>% 
  write_csv(.,  path = paste0(tbl_pth, paste0(red, "rnego_node_links_count_Grc", ".csv"))) %>%
  flextable(.)

# frecuencias por grupo y tipo de organizacion
tibble(ID = V(net)$name) %>% 
  left_join(., type_org, by = c("ID" = "ID"),  suffix = c("", ".to_remove")) %>%
  dplyr::group_by(V1, V39a_lab) %>% 
  tally() %>% 
  dplyr::select(Group = V1, "Type of organization" = V39a_lab, Count = n) %>%
  write_csv(., path = paste0(tbl_pth, "rnego_type_org_byGR_Grc", ".csv"))
 


```


\pagebreak

# Red de Colaboración institucional


### Nueva red de Colaboración institucional (NO DIRECCION )

```{r rcolabInsR4a, echo=FALSE,fig.width=13, fig.height=11,warning=FALSE,strip.white=FALSE, cache = FALSE, dpi = 300}

nt1 <- read_excel(xls.file, sheet = "R4_colab_inst") %>% 
  dplyr::filter(R_Destiny_ID != 25)


dups <- nt1 %>% 
  dplyr::mutate(id = paste0(R_Start_ID, "-", R_Destiny_ID)) %>% 
  dplyr::mutate(dup = duplicated(id)) %>% 
  dplyr::filter(dup) %>%  pull(id)

nt1 <- nt1 %>% 
  dplyr::mutate(id = paste0(R_Start_ID, "-", R_Destiny_ID)) %>% 
  dplyr::mutate(dup = id %in% dups) %>% 
  dplyr::mutate(no_remove = if_else( (dup & R_Start_ID == 42 & R_Start_ID_ego == "b") | 
                                       (dup & R_Start_ID == 49 & R_Start_ID_ego == "c") |
                                       (dup & R_Start_ID == 76 & R_Start_ID_ego == "b"), TRUE, FALSE)) %>% 
  dplyr::filter( !(dup & !no_remove) ) %>% 
  dplyr::select(-id, -dup, -no_remove) 

# calcular non response rate para todas las preguntas
tot <-nt1 %>% 
  nrow()

non_res_Ra <- nt1 %>% 
  dplyr::filter(R4a == 2) %>% 
  nrow

non_res_Ra_frq <- paste0(round(non_res_Ra/tot*100), "%")

non_res_Rb <- nt1  %>% 
  dplyr::filter(R4b == 9)%>% 
  nrow

non_res_Rb_frq <- paste0(round(non_res_Rb/tot*100), "%")

non_res_Rc <- nt1 %>% 
  dplyr::filter(R4c == 9)%>% 
  nrow

non_res_Rc_frq <- paste0(round(non_res_Rc/tot*100), "%")

#### encontrar los duplicados y removerlos


d2 <- nt1 %>%
  dplyr::select( R_Start_ID,  R_Destiny_ID, R4c, R4a, R4b) %>%
  dplyr::filter(R4a != 2) %>%
  dplyr::mutate(R4c = R4c+1, R4c = if_else(R4c == 7, 1, R4c)) %>%
  dplyr::mutate_all(as.character)


  net <- graph_from_data_frame(d=  d2,
                               vertices = groups %>% dplyr::select(ID, V1),
                               directed=T) %>%
  igraph::delete_vertices(., igraph::degree(.) == 0)
  
  net_no_dir <- graph_from_data_frame(d=  d2,
                               vertices = groups %>% dplyr::select(ID, V1),
                               directed=F) %>%
  igraph::delete_vertices(., igraph::degree(.) == 0)
  #%>% 
  #igraph::delete_edges(., edges = which(igraph::which_multiple(.)))
  

  
  #save adjacencyu matrix
  as_adjacency_matrix(net_no_dir, type = "both", sparse = F) %>% 
  as.data.frame() %>% 
     write_csv(., path = paste0(tbl_pth, "adj_m_rcolabInst_Ndir", ".csv"))
  
  
v_color <- tibble(id = V(net)$name) %>% 
  dplyr::left_join(., groups, by = c("id" = "ID") ) %>% 
  dplyr::left_join(., gr_colors, by = c("V1" = "V1")) %>% 
  pull(color)

igraph::add_shape("triangle", clip=igraph::shapes("circle")$clip,
                 plot=mytriangle)

edge.col <- tibble(var = E(net)$R4a) %>% 
  dplyr::mutate(col = dplyr::recode(var,  "0" = "gray48", "1" =  "green4")) %>% 
  pull(col) 

par(bg = NA)
plot(net, 
     layout= layout_with_kk, 
     edge.arrow.size= 0, 
     rescale= TRUE,
     edge.color= edge.col,
     edge.width = 2.2,
     vertex.size = 6.5,
     vertex.shape = NULL,
     vertex.label.dist=0,
     vertex.color = v_color,
     vertex.label= V(net)$name,
     vertex.label.family = "Arial",
     vertex.label.font	= 2,
     vertex.label.cex = 0.90,
     vertex.label.dist = 150,
     vertex.label.degree = -pi/2,
     vertex.label.color="black",
     asp = 0)

gr_labs <- gr_colors %>% 
 dplyr::filter(V1 != "0") %>% 
  mutate(lab = paste("Grupo", V1)) %>% 
  select(color, lab)

legend("topleft" , c("PPA members", "Executive Coordination (in 2019)", "PPA partners and collaborators") , pch = c(21, 21, 21, 15,15, 17, 16),
       col= c("black","black", "black"), pt.bg= c(gr_labs$color[-4]), pt.cex=2, cex=.8, bty = "n",  title="GRUPOS")

legend("bottomleft", c("In negociations", "contributed, Received, contribute and Received", "counterpart", "co-investment" ), lty = c(2,1, 1, 1), col = unique(edge.col), lwd = c(2,3,3,3), pt.cex=2, cex=0.8, bty="n", title = "INVESTMENT FLOW")

#metricas generales

tibble(Metric = c("density", "centraBetw", "centraDeg", "modularidad", "meanDegree", "transitiv", "assorta", "EigenValue"),
       Value  = c(igraph::edge_density(net_no_dir),
                  igraph::centralization.betweenness(net_no_dir)$centralization,
                  igraph::centralization.degree (net_no_dir, mode = "all")$centralization,
                  igraph:: cluster_walktrap(net_no_dir) %>% igraph::modularity(),
                  mean(igraph::degree(net_no_dir, mode="all", normalized = F)),
                  igraph::transitivity(net_no_dir),
                  igraph::assortativity.degree(net_no_dir, directed = F),
                  eigen_centrality(net_no_dir, directed = F)$value
       )) %>%
  dplyr::mutate_if(is.numeric, round, digits = 2) %>%
  data.frame()  %T>%
   write_csv(., path = paste0(tbl_pth, "rcolabInst_gnrl_metrics_Ndir", ".csv"))  %>% 
flextable(.,  cwidth = 2)

#metricas por cada nodo
metrics <- tibble(nodes_id = V(net_no_dir)$name) %>% 
  dplyr::left_join(., groups, by = c("nodes_id" = "ID")) %>%
  dplyr::select(nodes_id, Nome,V1) %>%
  dplyr::mutate(degree         = igraph::degree(net_no_dir, mode="all", normalized = F),
                betwe          = igraph::betweenness(net_no_dir) %>% round(.,1),
                closeness      = igraph::closeness(net_no_dir, mode="all") %>% round(.,4),
                ClusWalk       = igraph:: cluster_walktrap(net_no_dir) %>% membership(),
                transitivLocal = igraph::transitivity(net_no_dir, type = "local")  %>% round(.,2),
                Eigen_centr    = igraph::eigen_centrality(net_no_dir, directed = T)$vector %>%  round(.,2)
  ) %>%
  dplyr::mutate( HClust         = dplyr::select(., degree, betwe, closeness, Eigen_centr ) %>% 
                   clustering(data =., k = 4, dist.method = "euclidean", scale.unit = T)) %>% 
  dplyr::left_join(., entrevistados, by = c("nodes_id"= "ID")) %>% 
  dplyr::left_join(., type_org %>% dplyr::select(ID, V39a_lab, V39b_lab), by = c("nodes_id"= "ID"))

metrics %>% 
  data.frame()  %T>% 
  write_csv(., path = paste0(tbl_pth, "rcolabinst_all_metrics_Ndir", ".csv")) %>% 
  flextable(.)

metrics %>% 
  dplyr::group_by(HClust) %>% 
  dplyr::summarise_if(is.numeric, list(~mean(.),~sd(.))) %T>% 
  write_csv(., path = paste0(tbl_pth, "rcolabInst_NDir_cluster_summary.csv")) %>% 
   flextable(.)

### R4a summary

summ <-  tibble(var = E(net)$R4a) %>%
  dplyr::mutate( start  = igraph::ends(net, es=E(net), names=T)[,1]) %>%
  left_join(., groups, by = c("start" = "ID"))%>%
  dplyr::mutate( var = case_when(
    var == "0" ~ "No",
    var == "1" ~ "Yes",
    var == "2" ~ "Do not know",
    TRUE ~ "Outro"
  ))

summ %>%
  dplyr::filter(var != "Do not know" ) %>% 
  group_by( V1, var) %>%
  tally()  %>% 
  dplyr::mutate(freq = round(n/sum(n),2)*100, freq = paste0(freq, "%") ) %>% 
   ungroup() %>% 
  add_row(V1 = "Do not know", var = "Do not know rate", n = non_res_Ra, freq = non_res_Ra_frq) %>% 
  dplyr::select(Group = V1, "Institutional collaboration relation began in the PPA" = var, Count = n, Frequency = freq) %>%
  data.frame()  %T>% 
  write_csv(., path = paste0(tbl_pth, "rcolabInst_R4a_summary", ".csv")) %>% 
  flextable(.) 

##### R4b summary


summ <-  tibble(var = E(net)$R4b) %>%
  dplyr::mutate( start  = igraph::ends(net, es=E(net), names=T)[,1]) %>%
  left_join(., groups, by = c("start" = "ID"))%>%
  dplyr::mutate( var = case_when(
    var  == "1" ~  "Reputational gain",
    var  == "2" ~ "Gain in visibility",
    var  == "3" ~ "Creation of sectoral regulation",
    var  == "4" ~ "Public policy incidence",
    var  == "5" ~ "Territorial collaboration where both are present",
    var  == "6" ~ "Strengthening the Amazon impact business ecosystem",
    var  == "6" ~ "Articulation with organisations that share strategic objectives",
    var  == "6" ~ "Collaboration in the development of sociobio chains",
    TRUE ~ "Other"
  ))

summ %>%
  dplyr::filter(var != "Not available" ) %>% 
  group_by( V1, var) %>%
  tally()  %>% 
  dplyr::mutate(freq = round(n/sum(n),2)*100, freq = paste0(freq, "%") ) %>% 
   ungroup() %>% 
  add_row(V1 = "Do not know", var = "Do not know rate", n = non_res_Rb, freq = non_res_Rb_frq) %>% 
  dplyr::select(Group = V1, "Type of institutional collaboration relation" = var, Count = n, Frequency = freq) %>%
  data.frame()  %T>% 
  write_csv(., path = paste0(tbl_pth, "rcolabInst_R4b_summary", ".csv")) %>% 
  flextable(.)

##### R4c summary


summ <-  tibble(var = E(net)$R4c) %>%
  dplyr::mutate( start  = igraph::ends(net, es=E(net), names=T)[,1]) %>%
  left_join(., groups, by = c("start" = "ID"))%>%
  dplyr::mutate( var = case_when(
    var  == "1" ~  "Very low - less than once per year",
    var  == "2" ~ "Low - once or twice per year",
    var  == "3" ~ "Regular - three to six times per year",
    var  == "4" ~ "Frequent - seven to 12 times per year",
    var  == "5" ~ "Very frequent - more than once a month",
    TRUE ~ "Not avaliable"
  ))

summ %>%
#  dplyr::filter(var != "Not available" ) %>% 
  group_by( V1, var) %>%
  tally()  %>% 
  #dplyr::mutate(freq = round(n/sum(n),2)*100, freq = paste0(freq, "%") ) %>% 
   ungroup() %>% 
  #add_row(V1 = "Data not available", var = "Data not available rate", n = non_res_Rc, freq = non_res_Rc_frq) %>% 
  dplyr::select(Group = V1, "Intensity of institutional collaboration relation" = var, Count = n) %>%
  data.frame()  %T>% 
  write_csv(., path = paste0(tbl_pth, "rcolabInst_R4c_summary", ".csv")) %>% 
  flextable(.) 


#### R4a vs R4b


summ <-  tibble(var = E(net)$R4a, var2 = E(net)$R4b) %>%
  dplyr::mutate( start  = igraph::ends(net, es=E(net), names=T)[,1]) %>%
   dplyr::filter(var != 2) %>%
  dplyr::filter(var2 != 9) %>% 
  left_join(., groups, by = c("start" = "ID"))%>%
  dplyr::mutate( var = case_when(
    var == "0" ~ "No",
    var == "1" ~ "Yes",
    var == "2" ~ "Do not know",
    TRUE ~ "Not avaliable"
  ), var2 =case_when(
    var2  == "1" ~  "Reputational gain",
    var2  == "2" ~ "Gain in visibility",
    var2  == "3" ~ "Creation of sectoral regulation",
    var2  == "4" ~ "Public policy incidence",
    var2  == "5" ~ "Territorial collaboration where both are present",
    var2  == "6" ~ "Strengthening the Amazon impact business ecosystem",
    var2  == "6" ~ "Articulation with organisations that share strategic objectives",
    var2  == "6" ~ "Collaboration in the development of sociobio chains",
    TRUE ~ "Other"
  ))


non_response<- nt1 %>%
  dplyr::select( R_Start_ID,  R_Destiny_ID, R4c, R4a, R4b) %>%
  dplyr::filter(R4a == 2) %>%
  nrow
non_res_frq <- paste0(round(non_response/nrow(nt1)*100), "%")

summ %>%  
  group_by( V1, var, var2) %>%
  tally()  %>% 
  ungroup() %>% 
  add_row(V1 = "No response count", var = "No response count", var2 = var , n = non_response) %>% 
  dplyr::select(Group = V1, "Institutional collaboration relation began in the PPA" = var,
                "Type of institutional collaboration relation" = var2, Count = n) %>%
  data.frame()  %T>% 
  write_csv(., path = paste0(tbl_pth, "rcolabInst_R4a_R4b_summary", ".csv")) %>% 
  flextable(.) 


#### R4a vs R4c

summ <-  tibble(var = E(net)$R4a, var2 = E(net)$R4c) %>%
  dplyr::mutate( start  = igraph::ends(net, es=E(net), names=T)[,1]) %>%
  left_join(., groups, by = c("start" = "ID"))%>%
  dplyr::mutate( var = case_when(
    var == "0" ~ "No",
    var == "1" ~ "Yes",
    var == "2" ~ "Do not know",
    TRUE ~ "Not available"
  ), var2 =  case_when(
    var2  == "1" ~  "Very low - less than once per year",
    var2  == "2" ~ "Low - once or twice per year",
    var2  == "3" ~ "Regular - three to six times per year",
    var2  == "4" ~ "Frequent - seven to 12 times per year",
    var2  == "5" ~ "Very frequent - more than once a month",
    TRUE ~ "Not avaliable"
  ))


# non_response<- nt1 %>%
#   dplyr::select( R_Start_ID,  R_Destiny_ID, R2c, R2a, R2b, R2b) %>%
#   dplyr::filter(R2a == 2 | R2c == 9) %>%
#   nrow
# non_res_frq <- paste0(round(non_response/nrow(nt1)*100), "%")

summ %>%  
  group_by( V1, var, var2) %>%
  tally()  %>% 
  ungroup() %>% 
  #add_row(V1 = "No response count", var = "No response count", var2 = var , n = non_response) %>% 
  dplyr::select(Group = V1, "Institutional collaboration relation began in the PPA" = var,
                "Intensity of institutional collaboration relation" = var2, Count = n) %>%
  data.frame()  %T>% 
  write_csv(., path = paste0(tbl_pth, "rcolabInst_R4a_R4c_summary", ".csv")) %>% 
  flextable(.) 



#contar los links para cada nodo según el grupo
as_tibble(ends(net, E(net), names = T)) %>% 
  dplyr::select(start = V1, end = V2) %>% 
  left_join(., groups, by = c("start" = "ID")) %>% 
  dplyr::select( ID_start = V1, everything()) %>% 
  dplyr::left_join(., groups, by = c("end"= "ID")) %>% 
  dplyr::select(start, end,  ID_start,ID_end = V1, everything()) %>% 
  group_by(ID_start, ID_end) %>% 
  tally() %>%
  ungroup() %>%
  dplyr::mutate(Ratio = paste(round(n/sum(n)*100,1), "%")) %>% 
  dplyr::select(Group_start = ID_start, Group_end = ID_end, Links_count = n, Ratio) %T>% 
  write_csv(.,  path = paste0(tbl_pth, paste0("rcolabInst_node_links_count", ".csv"))) %>%
  flextable(.)

# frecuencias por grupo y tipo de organizacion
tibble(ID = V(net)$name) %>% 
  left_join(., type_org, by = c("ID" = "ID"),  suffix = c("", ".to_remove")) %>%
  dplyr::group_by(V1, V39a_lab) %>% 
  tally() %>% 
  dplyr::select(Group = V1, "Type of organization" = V39a_lab, Count = n) %>%
  write_csv(., path = paste0(tbl_pth, "rcolabInst_type_org_byGR", ".csv"))
 


```


\pagebreak

### Nueva red de Colaboración institucional mas grupoC (NO DIRECCION)

```{r rcolabInstGrC, echo=FALSE,fig.width=13, fig.height=11,warning=FALSE,strip.white=FALSE, cache = FALSE, dpi = 300}

nt1 <- nt1 <- read_excel(xls.file, sheet = "R4_colab_inst") %>% 
  dplyr::filter(R_Destiny_ID != 25)
 

dups <- nt1 %>% 
  dplyr::mutate(id = paste0(R_Start_ID, "-", R_Destiny_ID)) %>% 
  dplyr::mutate(dup = duplicated(id)) %>% 
  dplyr::filter(dup) %>%  pull(id)

nt1 <- nt1 %>% 
  dplyr::mutate(id = paste0(R_Start_ID, "-", R_Destiny_ID)) %>% 
  dplyr::mutate(dup = id %in% dups) %>% 
  dplyr::mutate(no_remove = if_else( (dup & R_Start_ID == 42 & R_Start_ID_ego == "b") | 
                                       (dup & R_Start_ID == 49 & R_Start_ID_ego == "c") |
                                       (dup & R_Start_ID == 76 & R_Start_ID_ego == "b"), TRUE, FALSE)) %>% 
  dplyr::filter( !(dup & !no_remove) ) %>% 
  dplyr::select(-id, -dup, -no_remove) 

d <- nt1 %>% 
  dplyr::select( R_Start_ID,  R_Destiny_ID, R4a) %>%
  dplyr::mutate_all(as.character)



nt2 <- read_excel(xls.file, sheet = "R5_outras_org") %>%
  dplyr::filter(!(R5b_Destiny_ID %in% c(25, 900))) %>% 
  dplyr::select(R_Start_ID, R_Destiny_ID = R5b_Destiny_ID, R5c) %>% 
  drop_na() %>% 
  dplyr::filter( !R_Destiny_ID %in% c(900, 25)) %>% 
  mutate_all(as.character) %>% 
  dplyr::filter(R5c == "4") %>% 
  dplyr::select( -R5c)

nt_all <- bind_rows(d, nt2) 

 
  net <- graph_from_data_frame(d=  nt_all,
                               vertices = groups %>% dplyr::select(ID, V1),
                               directed=T)%>%
  igraph::delete_vertices(., igraph::degree(.) == 0) %>% 
  igraph::delete_edges(., edges = which(igraph::which_multiple(.)))
  
  net_no_dir <- net
  
   #save adjacencyu matrix
  as_adjacency_matrix(net_no_dir, type = "both", sparse = F) %>% 
  as.data.frame() %>% 
     write_csv(., path = paste0(tbl_pth, "adj_m_rcolabInst_Ndir_Grc", ".csv"))
  
  
 
v_color <- tibble(id = V(net)$name) %>% 
  dplyr::left_join(., groups, by = c("id" = "ID") ) %>% 
  dplyr::left_join(., gr_colors, by = c("V1" = "V1")) %>% 
  pull(color)

igraph::add_shape("triangle", clip=igraph::shapes("circle")$clip,
                 plot=mytriangle)


par(bg = NA)
plot(net, 
     layout= layout_with_fr, 
     edge.arrow.size= 0, 
     rescale= TRUE,
     edge.color= "gray48",
     edge.width = 2.2,
     vertex.size = 5,
     vertex.shape = NULL,
     vertex.label.dist=0,
     vertex.color = v_color,
     vertex.label= V(net)$name,
     vertex.label.family = "Arial",
     vertex.label.font	= 2,
     vertex.label.cex = 0.90,
     vertex.label.dist = 150,
     vertex.label.degree = -pi/2,
     vertex.label.color="black",
     asp = 0)

gr_labs <- gr_colors %>% 
 dplyr::filter(V1 != "0") %>% 
  mutate(lab = paste("Grupo", V1)) %>% 
  select(color, lab)

legend("topleft" , c("PPA members", "Executive Coordination (in 2019)", "PPA partners and collaborators", "Actors in PPA's sphere of influence"), pch = c(21, 21, 21,21, 15,15, 17, 16),
       col= c("black","black", "black", "black"), pt.bg= c(gr_labs$color), pt.cex=2, cex=.8, bty = "n",  title="GROUPS")


#metricas generales

tibble(Metric = c("density", "centraBetw", "centraDeg", "modularidad", "meanDegree", "transitiv", "assorta", "EigenValue"),
       Value  = c(igraph::edge_density(net_no_dir),
                  igraph::centralization.betweenness(net_no_dir)$centralization,
                  igraph::centralization.degree (net_no_dir, mode = "all")$centralization,
                  igraph:: cluster_walktrap(net_no_dir) %>% igraph::modularity(),
                  mean(igraph::degree(net_no_dir, mode="all", normalized = F)),
                  igraph::transitivity(net_no_dir),
                  igraph::assortativity.degree(net_no_dir, directed = F),
                  eigen_centrality(net_no_dir, directed = F)$value
       )) %>%
  dplyr::mutate_if(is.numeric, round, digits = 2) %>%
  data.frame()  %T>%
   write_csv(., path = paste0(tbl_pth, "rcolabInst_gnrl_metrics_Grc", ".csv"))  %>% 
flextable(.,  cwidth = 2)

#metricas por cada nodo
metrics <- tibble(nodes_id = V(net_no_dir)$name) %>% 
  dplyr::left_join(., groups, by = c("nodes_id" = "ID")) %>%
  dplyr::select(nodes_id, Nome,V1) %>%
  dplyr::mutate(degree         = igraph::degree(net_no_dir, mode="all", normalized = F),
                betwe          = igraph::betweenness(net_no_dir) %>% round(.,1),
                closeness      = igraph::closeness(net_no_dir, mode="all") %>% round(.,4),
                ClusWalk       = igraph:: cluster_walktrap(net_no_dir) %>% membership(),
                transitivLocal = igraph::transitivity(net_no_dir, type = "local")  %>% round(.,2),
                Eigen_centr    = igraph::eigen_centrality(net_no_dir, directed = T)$vector %>%  round(.,2)
  ) %>%
  dplyr::mutate( HClust         = dplyr::select(., degree, betwe, closeness, Eigen_centr ) %>% 
                   clustering(data =., k = 4, dist.method = "euclidean", scale.unit = T)) %>% 
  dplyr::left_join(., entrevistados, by = c("nodes_id"= "ID")) %>% 
  dplyr::left_join(., type_org %>% dplyr::select(ID, V39a_lab, V39b_lab), by = c("nodes_id"= "ID"))

metrics %>% 
  data.frame()  %T>% 
  write_csv(., path = paste0(tbl_pth, "rcolabInst_all_metrics_GrC", ".csv")) %>% 
  flextable(.)

metrics %>% 
  dplyr::group_by(HClust) %>% 
  dplyr::summarise_if(is.numeric, list(~mean(.),~sd(.))) %T>% 
  write_csv(., path = paste0(tbl_pth, "rcolabInst_Dir_cluster_summary_Grc.csv")) %>% 
   flextable(.)


#contar los links para cada nodo según el grupo
as_tibble(ends(net, E(net), names = T)) %>% 
  dplyr::select(start = V1, end = V2) %>% 
  left_join(., groups, by = c("start" = "ID")) %>% 
  dplyr::select( ID_start = V1, everything()) %>% 
  dplyr::left_join(., groups, by = c("end"= "ID")) %>% 
  dplyr::select(start, end,  ID_start,ID_end = V1, everything()) %>% 
  group_by(ID_start, ID_end) %>% 
  tally() %>%
  ungroup() %>%
  dplyr::mutate(Ratio = paste(round(n/sum(n)*100,1), "%")) %>% 
  dplyr::select(Group_start = ID_start, Group_end = ID_end, Links_count = n) %T>% 
  write_csv(.,  path = paste0(tbl_pth, paste0( "rcolabInst_node_links_count_Grc", ".csv"))) %>%
  flextable(.)

# frecuencias por grupo y tipo de organizacion
tibble(ID = V(net)$name) %>% 
  left_join(., type_org, by = c("ID" = "ID"),  suffix = c("", ".to_remove")) %>%
  dplyr::group_by(V1, V39a_lab) %>% 
  tally() %>% 
  dplyr::select(Group = V1, "Type of organization" = V39a_lab, Count = n) %>%
  write_csv(., path = paste0(tbl_pth, "rcolabInst_type_org_byGR_Grc", ".csv"))
 


```




\pagebreak



# Red mamá

### Red Madre (sin loops/sin egos)

```{r r6_all, echo=FALSE,fig.width=15, fig.height=10,warning=FALSE,strip.white=FALSE, message = FALSE, cache = TRUE}
 
nt1 <- read_excel("D:/OneDrive - CGIAR/Attachments/Desktop/infrormes_PPA/red_madre.xlsx") %>%
  dplyr::filter(R_Start_ID != 25 & R_Destiny_ID != 25) %>% 
  dplyr::filter(R_Start_ID != 75 & R_Destiny_ID != 75) %>% 
  filter(group != "GRC")


d <-  nt1 %>%  
  dplyr::mutate_all(as.character) %>% 
  dplyr::select(R_Start_ID, R_Destiny_ID, everything())



  net <- graph_from_data_frame(d=  d,
                               vertices = groups %>% dplyr::select(ID, V1),
                               directed=F)%>%
  igraph::delete_vertices(., igraph::degree(.) == 0) %>% 
  igraph::delete_edges(., edges = which(igraph::which_multiple(.)))
  
net_no_dir <- net

#matrix de ajacencia

 as_adjacency_matrix(net_no_dir, type = "both", sparse = F) %>% 
  as.data.frame() %>% 
     write_csv(., path = paste0(tbl_pth, "adj_m_rmama_NOGRC_Ndir", ".csv"))
  
  

v_color <- tibble(id = V(net)$name) %>% 
  dplyr::left_join(., groups, by = c("id" = "ID") ) %>% 
  dplyr::left_join(., gr_colors, by = c("V1" = "V1")) %>% 
  pull(color)


V(net)$color <- v_color

set.seed(123)


edge.col <- NULL
  

igraph::add_shape("triangle", clip=igraph::shapes("circle")$clip,
                 plot=mytriangle)

par(mar = c(0.5, 0.5, 0.5, 0.5))
plot(net, 
     layout=layout_with_fr, 
     edge.arrow.size=0.85, 
     rescale=T,
     edge.color="gray48",
     vertex.size = 6.5,
     vertex.shape = NULL,
     vertex.label.dist=0,
     vertex.label= V(net)$name,
     vertex.label.family = "Arial",
     vertex.label.font	= 2,
     vertex.label.cex = 0.7,
     vertex.label.dist = 150,
     vertex.label.degree = -pi/2,
     vertex.label.color="black")

gr_labs <- gr_colors %>% 
 dplyr::filter(V1 != "0") %>% 
  mutate(lab = paste("Grupo", V1)) %>% 
  select(color, lab)

legend("topleft" , c("PPA members", "Executive Coordination (in 2019)", "PPA partners and collaborators", "Actors in PPA's sphere of influence") , pch = c(21, 21, 21, 21),
       col= c("black","black", "black"), pt.bg= c(gr_labs$color), pt.cex=2, cex=.8, bty = "n",  title="GRUPOS")

# legend("bottomright", c( "Sim", "Não", "Não se aplica", "Não disponível"), lty = c(1,1, 1, 1), col = c("darkgreen", "orange", "grey70", "grey70"), lwd = c(3,3,3,3), pt.cex=2, cex=0.8, bty="n", title = "R_b")
  
#Metricas Generales Red de madre (No direccionada)

tibble(Metric = c("density", "centraBetw", "centraDeg", "modularidad", "meanDegree", "transitiv", "assorta", "EigenValue"),
             Value  = c(igraph::edge_density(net_no_dir, loops = FALSE),
                        igraph::centralization.betweenness(net_no_dir)$centralization,
                        igraph::centralization.degree (net_no_dir, mode = "all")$centralization,
                        igraph:: cluster_walktrap(net_no_dir) %>% igraph::modularity(),
                        mean(igraph::degree(net_no_dir, mode="all", normalized = F)),
                        igraph::transitivity(net_no_dir),
                        igraph::assortativity.degree(net_no_dir, directed = T),
                        igraph::eigen_centrality(net_no_dir, directed = T)$value %>%  round(.,2)
                        )) %>%
        dplyr::mutate_if(is.numeric, round, digits = 2) %>%
   data.frame()  %T>% 
   write_csv(., path = paste0(tbl_pth, "madre_mtric_summ_NOGRC_Ndir", ".csv")) %>%
        flextable(.,  cwidth = 2)

#Metricas por cada nodo

 metrics <- tibble(nodes_id = V(net_no_dir)$name) %>% 
      dplyr::left_join(., groups, by = c("nodes_id" = "ID")) %>%
      dplyr::select(nodes_id, Nome, V1) %>%
      dplyr::mutate(degree         = igraph::degree(net_no_dir, mode="all", normalized = F),
                    betwe          = igraph::betweenness(net_no_dir) %>% round(.,1),
                    closeness      = igraph::closeness(net_no_dir, mode="all") %>% round(.,4),
                    ClusWalk       = igraph:: cluster_walktrap(net_no_dir) %>% membership(),
                    transitivLocal = igraph::transitivity(net_no_dir, type = "local")  %>% round(.,2),
                    Eigen_centr    = igraph::eigen_centrality(net_no_dir, directed = F)$vector %>%  round(.,2)
                    ) %>%
     dplyr::mutate( HClust         = dplyr::select(., degree, betwe, closeness, Eigen_centr ) %>%    clustering(data =., k = 4, dist.method = "euclidean", scale.unit = T)) %>% 
  dplyr::left_join(., entrevistados, by = c("nodes_id"= "ID")) %>% 
  dplyr::left_join(., type_org %>% dplyr::select(ID, V39a_lab, V39b_lab), by = c("nodes_id"= "ID"))

metrics %>% 
  data.frame()  %T>% 
  write_csv(., path = paste0(tbl_pth, "madre_all_mtric_NOGRC_Ndir", ".csv")) %>%
      flextable(.)

metrics %>% 
  dplyr::group_by(HClust) %>% 
  dplyr::summarise_if(is.numeric, list(~mean(.),~sd(.))) %>% 
  write_csv(., path = paste0(tbl_pth,"redmama_NoDir_NOGRC_cluster_summary.csv")) %T>% 
   flextable(.)



```

\pagebreak



### Red Madre Grupo C (sin loops/sin egos)

```{r r6_all_grC_, echo=FALSE,fig.width=15, fig.height=10,warning=FALSE,strip.white=FALSE, message = FALSE, cache = TRUE}
 
nt1 <- read_excel("D:/OneDrive - CGIAR/Attachments/Desktop/infrormes_PPA/red_madre.xlsx") %>%
  dplyr::filter(R_Start_ID != 25 & R_Destiny_ID != 25) %>% 
  dplyr::filter(R_Start_ID != 75 & R_Destiny_ID != 75)


d <-  nt1 %>%  
  dplyr::mutate_all(as.character) %>% 
  dplyr::select(R_Start_ID, R_Destiny_ID, everything())



  net <- graph_from_data_frame(d=  d,
                               vertices = groups %>% dplyr::select(ID, V1),
                               directed=F)%>%
  igraph::delete_vertices(., igraph::degree(.) == 0) %>% 
  igraph::delete_edges(., edges = which(igraph::which_multiple(.)))
  
net_no_dir <- net

#matrix de ajacencia

 as_adjacency_matrix(net_no_dir, type = "both", sparse = F) %>% 
  as.data.frame() %>% 
     write_csv(., path = paste0(tbl_pth, "adj_m_rmama_Ndir", ".csv"))
  
  

v_color <- tibble(id = V(net)$name) %>% 
  dplyr::left_join(., groups, by = c("id" = "ID") ) %>% 
  dplyr::left_join(., gr_colors, by = c("V1" = "V1")) %>% 
  pull(color)


V(net)$color <- v_color

set.seed(123)


edge.col <- NULL
  

igraph::add_shape("triangle", clip=igraph::shapes("circle")$clip,
                 plot=mytriangle)

par(mar = c(0.5, 0.5, 0.5, 0.5))
plot(net, 
     layout=layout_with_fr, 
     edge.arrow.size=0.85, 
     rescale=T,
     edge.color="gray48",
     vertex.size = 6.5,
     vertex.shape = NULL,
     vertex.label.dist=0,
     vertex.label= V(net)$name,
     vertex.label.family = "Arial",
     vertex.label.font	= 2,
     vertex.label.cex = 0.7,
     vertex.label.dist = 150,
     vertex.label.degree = -pi/2,
     vertex.label.color="black")

gr_labs <- gr_colors %>% 
 dplyr::filter(V1 != "0") %>% 
  mutate(lab = paste("Grupo", V1)) %>% 
  select(color, lab)

legend("topleft" , c("PPA members", "Executive Coordination (in 2019)", "PPA partners and collaborators", "Actors in PPA's sphere of influence") , pch = c(21, 21, 21, 21),
       col= c("black","black", "black"), pt.bg= c(gr_labs$color), pt.cex=2, cex=.8, bty = "n",  title="GRUPOS")

# legend("bottomright", c( "Sim", "Não", "Não se aplica", "Não disponível"), lty = c(1,1, 1, 1), col = c("darkgreen", "orange", "grey70", "grey70"), lwd = c(3,3,3,3), pt.cex=2, cex=0.8, bty="n", title = "R_b")
  
#Metricas Generales Red de madre (No direccionada)

tibble(Metric = c("density", "centraBetw", "centraDeg", "modularidad", "meanDegree", "transitiv", "assorta", "EigenValue"),
             Value  = c(igraph::edge_density(net_no_dir, loops = FALSE),
                        igraph::centralization.betweenness(net_no_dir)$centralization,
                        igraph::centralization.degree (net_no_dir, mode = "all")$centralization,
                        igraph:: cluster_walktrap(net_no_dir) %>% igraph::modularity(),
                        mean(igraph::degree(net_no_dir, mode="all", normalized = F)),
                        igraph::transitivity(net_no_dir),
                        igraph::assortativity.degree(net_no_dir, directed = T),
                        igraph::eigen_centrality(net_no_dir, directed = T)$value %>%  round(.,2)
                        )) %>%
        dplyr::mutate_if(is.numeric, round, digits = 2) %>%
   data.frame()  %T>% 
   write_csv(., path = paste0(tbl_pth, "madre_mtric_summ_Ndir", ".csv")) %>%
        flextable(.,  cwidth = 2)

#Metricas por cada nodo

 metrics <- tibble(nodes_id = V(net_no_dir)$name) %>% 
      dplyr::left_join(., groups, by = c("nodes_id" = "ID")) %>%
      dplyr::select(nodes_id, Nome, V1) %>%
      dplyr::mutate(degree         = igraph::degree(net_no_dir, mode="all", normalized = F),
                    betwe          = igraph::betweenness(net_no_dir) %>% round(.,1),
                    closeness      = igraph::closeness(net_no_dir, mode="all") %>% round(.,4),
                    ClusWalk       = igraph:: cluster_walktrap(net_no_dir) %>% membership(),
                    transitivLocal = igraph::transitivity(net_no_dir, type = "local")  %>% round(.,2),
                    Eigen_centr    = igraph::eigen_centrality(net_no_dir, directed = F)$vector %>%  round(.,2)
                    ) %>%
     dplyr::mutate( HClust         = dplyr::select(., degree, betwe, closeness, Eigen_centr ) %>%    clustering(data =., k = 4, dist.method = "euclidean", scale.unit = T)) %>% 
  dplyr::left_join(., entrevistados, by = c("nodes_id"= "ID")) %>% 
  dplyr::left_join(., type_org %>% dplyr::select(ID, V39a_lab, V39b_lab), by = c("nodes_id"= "ID"))

metrics %>% 
  data.frame()  %T>% 
  write_csv(., path = paste0(tbl_pth, "madre_all_mtric_Ndir", ".csv")) %>%
      flextable(.)

metrics %>% 
  dplyr::group_by(HClust) %>% 
  dplyr::summarise_if(is.numeric, list(~mean(.),~sd(.))) %>% 
  write_csv(., path = paste0(tbl_pth,"redmama_NoDir_cluster_summary.csv")) %T>% 
   flextable(.)



```







